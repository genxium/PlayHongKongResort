String.prototype.format=function(){var c=this;for(var a=0;a<arguments.length;a++){var b=new RegExp("\\{"+a+"\\}","gi");c=c.replace(b,arguments[a])}return c};var RELATION_NAMES={applied:"已報名",selected:"被選上啦",present:"與席",absent:"缺席",assessed:"已評價",hosted:""};var STATUS_NAMES={created:"已創建",pending:"等待審核",rejected:"未通過審核",accepted:"已通過審核"};var TITLES={create:"創建",profile:"個人",register:"註冊帳號",login:"登入",logout:"登出",forgot_password:"忘記密碼",upload:"上傳",choose_picture:"選擇圖片",edit:"編輯","delete":"刪除",update:"更新",save:"保存",submit:"提交",cancel:"取消",detail:"詳情",view:"詳細",join:"報名",begin_time:"開始時間",deadline:"報名截止",selected:"選中",applied:"報名",yes:"是",no:"否",submit_comment_question:"提交問題",submit_comment_reply:"提交",collapse:"收起",reply:"回覆",replied_to:"對@{0}: ",time_ascendant:"時間順序",time_descendant:"時間倒序",joined_activities:"參與的活動",hosted_activities:"發起的活動",question:"Q & A",participant:"參與者",assessment:"評價",view_assessment:"查看Ta收到的評價 >",assessment_disabled:"不可用",present:"已出席",absent:"未出席",from:"來自",content:"內容",by_host:"由 @{0} 發起",view_all_replies:"查看全部回覆({0})",about_us:"關於我們",contact_us:"聯絡我們",privacy_policy:"隱私聲明",resend_email_verification:"重發驗證郵件",submit_participant_selection:"提交",new_password:"新密碼",confirm_new_password:"確認新密碼",input_to_reset_password:"請輸入新密碼並提交以完成修改",add_image:"+",send:"發送",check_all:"全選",uncheck_all:"清空已選",ascendant:"順序",descendant:"倒序",automatic:"自動",time:"時間",last_accepted_time:"審核完成時間","default":"默認"};var MESSAGES={uploading:"正在上傳...",uploaded:"上傳成功",upload_failed:"上傳失敗",delete_activity_confirmation:"確定要刪除此活動嗎？",username_requirement:"用戶名需為6-32位由英文字母， 數字或符號'_'組成",username_valid:"此用戶名可以使用",username_invalid:"此用戶名已被佔用",email_valid:"此電郵地址可以使用",email_invalid:"此電郵地址已被佔用",email_requirement:"請填寫有效的電郵地址",password_requirement:"密碼需為6~32位由英文字母，數字或符號'#'，'_'及'!'組成",password_confirm_requirement:"密碼不匹配",comment_reply_not_submitted:"回覆未提交",assessment_requirement:"請填寫－～64個字",comment_disabled_activity_has_begun:"Q&A時間已經結束",comment_disabled_activity_not_accepted:"活動尚未通過審核",email_verification_success:"Hi @{0}， 你的電郵地址{1}已完成驗證， {2}秒後將為你跳轉到首頁",email_verification_failure:"Hi @{0}， 很遺憾你的電郵地址{1}未能通過驗證， 如需幫助請與hongkongresort@126.com聯繫",about_us:"關於我們\n\r\n\r仲未寫",privacy_policy:"隱私聲明\n\r\n\r仲未寫",please_wait:"請稍後...",email_verification_sent:"驗證郵件已發送到你的註冊郵箱{0}, 請查收",email_verification_not_sent:"未能成功發送驗證郵件, 請重試",image_selection_requirement:"請選擇不多於3張圖片輔助活動說明, 每張圖片應不超過2MB(2048KB), 如需編輯或壓縮圖片可以使用<a target='_blank' href='http://www.pixlr.com'>Pixlr</a>",activity_created:"活動已創建, 你可以在個人主頁查看相關信息",activity_saved:"更新已保存",activity_not_saved:"保存不成功",activity_saving:"正在保存...",instructions_sent_to:"密碼重設郵件已發送至{0}, 請查收",instructions_not_sent:"郵件發送失敗， 請重試",password_reset_tips:"請輸入你的註冊電郵地址",notice:"請注意",password_reset_notice_1:"若電郵地址未在本站註冊， 你將無法收到所需郵件",password_reset_notice_2:"若電郵地址不存在， 你將無法收到所需郵件",password_reset_notice_3:"電郵地址所關聯帳號在申請密碼重設期間不會失效， 如需凍結帳號請通過<a href=\"mailto:admin@qiutongqu.com?subject='account suspension'\">admin@qiutongqu.com</a>聯繫我們"};var HINTS={username:"用戶名",email:"電郵地址",password:"密碼",confirm_password:"確認密碼",title:"標題",address:"地址",content:"內容",activity_title:"標題",activity_address:"活動地點",activity_content:"活動內容",captcha:"驗證碼",reply:"對@{0}說: "};var ALERTS={captcha_not_matched:"驗證碼錯誤",creation_limit_exceeded:"創建活動太頻繁囉， 請稍後片刻",applicant_num_exceeded:"報名人數已達到上限",selected_num_exceeded:"已選人數已達到上限",deadline_expired:"報名已截止",image_selection_limit_exceeded:"請選擇{0}張以內圖片",invalid_email_format:"無效的電郵地址",wrong_password:"密碼錯誤",user_not_existing:"用戶不存在",comment_requirement:"請填寫5～128個字",comment_question_not_submitted:"問題未提交",registered:"註冊成功",not_registered:"註冊不成功",not_permitted_to_view_detail:"你無權瀏覽此頁",activity_not_begun:"活動尚未開始",assessment_submitted:"評價已成功提交",assessment_not_submitted:"評價未提交",no_assessment:"Oops! 暫時沒有人給Ta留下評價喔",choose_one_image:"一次只能選擇一張圖片",please_log_in:"請先登入",image_selection_requirement:"請選擇不多於3張圖片輔助活動說明, 每張圖片應不超過2MB(2048KB)",deadline_behind_begin_time:"報名截止時間應在活動開始時間之前",please_follow_activity_field_instructions:"請根據字數要求填寫各項",not_updated:"更新不成功"};var g_numItemsPerPage=6;var g_baseTwo=2;var g_baseTen=10;var g_rootElement=$(":root");var g_inf=(1<<53);var g_orderDescend=(-1);var g_orderAscend=(+1);var g_directionForward=(+1);var g_directionBackward=(-1);var g_modeHomepage=0;var g_modeProfile=1;var g_idKeyboardEnter=13;var g_keyToken="token";var g_keyId="id";var g_keyOrderKey="order_key";var g_keyRelation="relation";var g_keyBundle="bundle";var g_keyRet="ret";var g_keyCount="count";var g_keyData="data";var g_keyUser="user";var g_keyCode="code";var g_keyUserId="user_id";var g_keyVieweeId="viewee_id";var g_keyName="name";var g_keyEmail="email";var g_keyPassword="password";var g_keyAvatar="avatar";var g_keyPasswordResetCode="password_reset_code";var g_keyUnreadCount="unread_count";var g_keyUnassessedCount="unassessed_count";var g_keyButton="button";var g_keyActivities="activities";var g_keyActivity="activity";var g_keyActivityId="activity_id";var g_keyTitle="title";var g_keyAddress="address";var g_keyContent="content";var g_keyCreatedTime="created_time";var g_keyBeginTime="begin_time";var g_keyDeadline="application_deadline";var g_keyImages="images";var g_keyStatus="status";var g_keyHostId="host_id";var g_keyHostName="host_name";var g_keyPriority="priority";var g_keyOrderMask="order_mask";var g_keyAppliedParticipants="applied_participants";var g_keySelectedParticipants="selected_participants";var g_keyPresentParticipants="present_participants";var g_keyAbsentParticipants="absent_participants";var g_keyImageId="image_id";var g_keyUrl="url";var g_keyComment="comment";var g_keyCommentId="comment_id";var g_keyParentId="parent_id";var g_keyPredecessorId="predecessor_id";var g_keyCommentType="type";var g_keyGeneratedTime="generated_time";var g_keyComments="comments";var g_keySubComments="sub_comments";var g_keyFrom="from";var g_keyFromName="from_name";var g_keyTo="to";var g_keyToName="to_name";var g_keyNotification="notification";var g_keyNotifications="notifications";var g_keyIsRead="is_read";var g_keyPage="page";var g_keyPageSt="page_st";var g_keyPageEd="page_ed";var g_keyRefIndex="ref_index";var g_keyNumItems="num_items";var g_keyOrder="order";var g_keyOrientation="orientation";var g_keyDirection="direction";var g_keyCell="cell";var g_keySid="sid";var g_keyCaptcha="captcha";var g_statusCreated=0;var g_statusPending=1;var g_statusRejected=2;var g_statusAccepted=3;var g_maxApplied=500;var g_maxSelected=250;var g_emailPattern=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i;var g_passwordPattern=/^[0-9a-zA-Z_#\\!]{6,32}$/;var g_usernamePattern=/^[0-9a-zA-Z_]{6,32}$/;var g_activityTitlePattern=/^.{5,64}$/;var g_activityAddressPattern=/^.{5,128}$/;var g_activityContentPattern=/^[\s\S]{15,1024}$/;var g_commentContentPattern=/^.{5,128}$/;var g_assessmentContentPattern=/^.{0,64}$/;var g_errNotLoggedIn=1001;var g_errUserNotFound=1003;var g_errPswErr=1004;var g_errActivityHasBegun=3007;var g_errActivityAppliedLimit=3008;var g_errActivitySelectedLimit=3009;var g_errActivityCreationLimit=3010;var g_errCaptcha=4001;function callbackOnPageLoaded(c,a){if(a==null){return}var b=false;c.onload=c.onreadystatechange=function(){var d=(this.readyState==null||this.readyState=="complete");if(b||!d){return}b=true;a()}}function loadJavaScript(d,f,i){var g=d.document;if(g==null){return}var c=g.createElement("script");var b=g.createTextNode(f);c.appendChild(b);if(i!=null){var a=false;c.onload=c.onreadystatechange=function(){var j=(this.readyState==null||this.readyState=="complete");if(a||!j){return}a=true;i()}}var h=g.getElementsByTagName("head");if(h==null){return}var e=h[0];if(e==null){return}e.appendChild(c)}function loadScriptFile(g,h,e,a){var d=null;if(e=="js"){d=g.document.createElement("script");d.setAttribute("type","text/javascript");d.setAttribute("src",h)}else{if(e=="css"){d=g.document.createElement("link");d.setAttribute("rel","stylesheet");d.setAttribute("type","text/css");d.setAttribute("href",h)}else{}}if(typeof d=="undefined"){return}if(a!=null){var c=false;scriptNode.onload=scriptNode.onreadystatechange=function(){var i=(this.readyState==null||this.readyState=="complete");if(c||!i){return}c=true;a()}}var f=g.document.getElementsByTagName("head");if(f==null){return}var b=f[0];if(b==null){return}b.appendChild(d)}function loadJquery(b,a){loadScriptFile(b,"assets/javascripts/jquery-2.0.3.min.js","js",a)}function loadJqueryPlugins(a){loadScriptFile(a,"assets/javascripts/jquery-cookie.js","js",null);loadScriptFile(a,"assets/javascripts/jquery-ui.js","js",null)}function loadCommonScripts(a){loadScriptFile(a,"assets/javascripts/global_variables.js","js",null);loadScriptFile(a,"assets/javascripts/global_functions.js","js",null)}function validateEmail(a){var b=g_emailPattern;return b.test(a)}function validatePassword(a){var b=g_passwordPattern;return b.test(a)}function validateName(a){var b=g_usernamePattern;return b.test(a)}function validateActivityTitle(b){var a=g_activityTitlePattern;return a.test(b)}function validateActivityAddress(a){var b=g_activityAddressPattern;return b.test(a)}function validateActivityContent(b){var a=g_activityContentPattern;return a.test(b)}function validateCommentContent(b){var a=g_commentContentPattern;return a.test(b)}function validateAssessmentContent(b){var a=g_assessmentContentPattern;return a.test(b)}function extractTagAndParams(b){var f=/https?:\/\/(.+)#(default|profile|detail|home|search|notifications|success|failure)\??(.*)/i;var d=f.exec(b);if(d==null){return null}var a={};a.tag=d[2];a.params={};var h=d[3];var e=/(\w+)=([@\.\w]+)/g;matchParams=e.exec(h);while(matchParams!=null){var c=matchParams[1];var g=matchParams[2];a.params[c]=g;matchParams=e.exec(h)}return a}function firstChild(b,a){return $(b.children(a)[0])}function truncateMillisec(a){try{var c=a.split(".");if(c.length<=1){throw"oops!"}return c[0]}catch(b){return a}}function getCurrentYmdhisDate(){var b=new Date();var a=b.getFullYear().toString()+"-"+(b.getMonth()+1).toString()+"-"+b.getDate().toString();var c=b.getHours().toString()+":"+b.getMinutes().toString()+":"+b.getSeconds().toString();return a+" "+c}function compareYmdhisDate(j,h){var g=new Array();var c=new Array();var e=j.split(" ");var a=e[0].split("-");var b=e[1].split(":");for(var d in a){g.push(parseInt(a[d]))}for(var d in b){g.push(parseInt(b[d]))}var e=h.split(" ");var a=e[0].split("-");var b=e[1].split(":");for(var d in a){c.push(parseInt(a[d]))}for(var d in b){c.push(parseInt(b[d]))}for(var f=0;f<g.length;f++){if(g[f]<c[f]){return -1}if(g[f]>c[f]){return +1}}return 0}function getTarget(a){return $(a.srcElement?a.srcElement:a.target)}function isChecked(a){return(a!=null&&a.is(":checked"))}function isHidden(a){return(a!=null&&a.is(":hidden"))}function checkField(a){if(a==null){return}a.prop("checked",true)}function uncheckField(a){if(a==null){return}a.prop("checked",false)}function disableField(a){if(a==null){return}a.prop("disabled",true)}function enableField(a){if(a==null){return}a.prop("disabled",false)}function setMargin(e,d,c,b,a){if(e==null){return}if(d!=null){e.css("margin-left",d)}if(c!=null){e.css("margin-top",c)}if(b!=null){e.css("margin-right",b)}if(a!=null){e.css("margin-bottom",a)}}function setBackgroundImageDefault(b,a){if(b==null){return}setBackgroundImage(b,a,"contain","no-repeat","center")}function setBackgroundImage(e,b,c,d,a){if(e==null){return}e.css("background-image","url("+b+")");e.css("background-size",c);e.css("-o-background-size",c);e.css("-moz-background-size",c);e.css("-webkit-background-size",c);e.css("background-repeat",d);e.css("background-position",a)}function setDimensions(c,b,a){if(c==null){return}if(b!=null){c.css("width",b)}else{c.css("width","auto")}if(a!=null){c.css("height",a)}else{c.css("height","auto")}}function getDimensions(a){if(a==null){return{width:"0px",height:"0px"}}return{width:a.css("width"),height:a.css("height")}}function setOffset(c,b,a){if(c==null){return}if(b!=null){c.css("left",b)}else{c.css("left","auto")}if(a!=null){c.css("top",a)}else{c.css("top","auto")}}function getOffset(a){if(a==null){return{left:"0px",top:"0px"}}return{left:parseFloat(a.css("left")),top:parseFloat(a.css("top"))}}function stencilize(a){if(a==null){return}a.css("background-color","DimGray");a.css("color","Gainsboro")}function isFileValid(b){if(b==null){return false}var a=(1<<21);if(b.size>a){return false}return true}function validateImage(a){if(a==null){return false}if(!isFileValid(a)){alert("Please choose an image that is less the 2MB(2048KB) in size");return false}var c=a.value==null?a.name:a.value;var b=c.split(".").pop().toLowerCase();if($.inArray(b,["png","jpg","jpeg"])==-1){alert("Invalid image type!");return false}return true}function currentMillis(){var a=new Date();return 1000*moment().zone(a.getTimezoneOffset()).unix()}function gmtMiilisecToLocalYmdhis(b){var a=new Date();return moment(b).zone(a.getTimezoneOffset()).format("YYYY-MM-DD HH:mm:ss")}function gmtMiilisecToLocalYmdhi(b){var a=new Date();return moment(b).zone(a.getTimezoneOffset()).format("YYYY-MM-DD HH:mm")}function localYmdhisToGmtMillisec(a){var b=new Date();return 1000*moment(a,"YYYY-MM-DD HH:mm:ss").zone(b.getTimezoneOffset()).unix()}function generateUuid(){function a(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function isStandardSuccess(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==0}function isStandardFailure(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==1}function isCaptchaNotMatched(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errCaptcha}function isTokenExpired(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errNotLoggedIn}function isUserNotFound(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errUserNotFound}function isPswErr(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errPswErr}function isApplicantLimitExceeded(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errActivityAppliedLimit}function isSelectedLimitExceeded(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errActivitySelectedLimit}function isCreationLimitExceeded(b){if(b==null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errActivityCreationLimit}function toggleScaling(a){this.animate({transform:"scale(1.3, 1.3)"},300);this.animate({transform:"none"},300)}var invalid=0;var applied=(1<<0);var selected=(1<<1);var present=(1<<2);var absent=(1<<3);var assessed=(1<<4);var hosted=(1<<5);function User(a){this.id=parseInt(a.id);if(a.hasOwnProperty("email")){this.email=a.email}this.name=a.name;this.avatar=(a.hasOwnProperty("avatar")?a.avatar:"/assets/icons/anonymous.png");if(a.hasOwnProperty("unread_count")){this.unreadCount=parseInt(a.unread_count)}this.hasAvatar=function(){return(this.avatar!=null&&this.avatar!=undefined)};if(a.hasOwnProperty("group_id")){this.groupId=parseInt(a.group_id)}this.isVisitor=function(){return(this.groupId==null||this.groupId==undefined||this.groupId==0)}}function Image(a){this.id=parseInt(a.id);this.url=a.url}function Activity(b){this.id=parseInt(b.id);this.title=b.title;this.address=b.address;this.content=b.content;this.createdTime=parseInt(b.created_time);this.applicationDeadline=parseInt(b.application_deadline);this.isDeadlineExpired=function(){var p=new Date();var o=1000*moment().zone(p.getTimezoneOffset()).unix();return o>this.applicationDeadline};this.beginTime=parseInt(b.begin_time);this.hasBegun=function(){var p=new Date();var o=1000*moment().zone(p.getTimezoneOffset()).unix();return o>this.beginTime};if(b.hasOwnProperty("capacity")){this.capacity=parseInt(b.capacity)}if(b.hasOwnProperty("num_applied")){this.numApplied=parseInt(b.num_applied)}if(b.hasOwnProperty("num_selected")){this.numSelected=parseInt(b.num_selected)}if(b.hasOwnProperty("status")){this.status=parseInt(b.status)}this.relation=null;this.containsRelation=function(){return(this.relation!=null&&this.relation!=undefined)};if(b.hasOwnProperty("relation")){this.relation=parseInt(b.relation)}if(b.hasOwnProperty("images")){var h=new Array();var a=b.images;for(var l in a){var g=a[l];var d=new Image(g);h.push(d)}this.images=h}if(b.hasOwnProperty("applied_participants")){var f=new Array();var j=b.applied_participants;for(var l in j){var c=j[l];var k=new User(c);f.push(k)}this.appliedParticipants=f}if(b.hasOwnProperty("selected_participants")){var f=new Array();var j=b.selected_participants;for(var l in j){var c=j[l];var k=new User(c);f.push(k)}this.selectedParticipants=f}if(b.hasOwnProperty("present_participants")){var f=new Array();var j=b.present_participants;for(var l in j){var c=j[l];var k=new User(c);f.push(k)}this.presentParticipants=f}if(b.hasOwnProperty("host")){var n=b.host;var m=new User(n);this.host=m}if(b.hasOwnProperty("viewer")){var i=b.viewer;var e=new User(i);this.viewer=e}if(b.hasOwnProperty("priority")){this.priority=parseInt(b.priority)}if(b.hasOwnProperty("order_mask")){this.orderMask=parseInt(b.order_mask)}}function Comment(a){if(a.hasOwnProperty("id")){this.id=parseInt(a.id)}if(a.hasOwnProperty("content")){this.content=a.content}if(a.hasOwnProperty("activity_id")){this.activityId=parseInt(a.activity_id)}if(a.hasOwnProperty("parent_id")){this.parentId=parseInt(a.parent_id)}if(a.hasOwnProperty("predecessor_id")){this.predecessorId=parseInt(a.predecessor_id)}if(a.hasOwnProperty("generated_time")){this.generatedTime=parseInt(a.generated_time)}if(a.hasOwnProperty("num_children")){this.numChildren=parseInt(a.num_children)}if(a.hasOwnProperty("from")){this.from=parseInt(a.from)}if(a.hasOwnProperty("from_user")){this.fromUser=new User(a.from_user)}if(a.hasOwnProperty("to")){this.to=parseInt(a.to)}if(a.hasOwnProperty("to_user")){this.toUser=new User(a.to_user)}}function Assessment(a){if(a.hasOwnProperty("content")){this.content=a.content}if(a.hasOwnProperty("activity_id")){this.activityId=parseInt(a.activity_id)}if(a.hasOwnProperty("from")){this.from=parseInt(a.from)}if(a.hasOwnProperty("to")){this.to=parseInt(a.to)}if(a.hasOwnProperty("from_user")){this.fromUser=new User(a.from_user)}if(a.hasOwnProperty("to_user")){this.toUser=new User(a.to_user)}}function Notification(a){if(a.hasOwnProperty("id")){this.id=parseInt(a.id)}if(a.hasOwnProperty("is_read")){this.isRead=parseInt(a.is_read)}if(a.hasOwnProperty("from")){this.from=parseInt(a.from)}if(a.hasOwnProperty("to")){this.to=parseInt(a.to)}if(a.hasOwnProperty("content")){this.content=a.content}if(a.hasOwnProperty("activity_id")){this.activityId=parseInt(a.activity_id)}if(a.hasOwnProperty("comment_id")){this.commentId=parseInt(a.comment_id)}if(a.hasOwnProperty("assessment_id")){this.assessmentId=parseInt(a.assessment_id)}if(a.hasOwnProperty("cmd")){this.cmd=parseInt(a.cmd)}if(a.hasOwnProperty("relation")){this.relation=parseInt(a.relation)}if(a.hasOwnProperty("status")){this.status=parseInt(a.status)}if(a.hasOwnProperty("generated_time")){this.generatedTime=parseInt(a.generated_time)}}var g_participantsForm=null;var g_aliasApplied=0;var g_aliasSelected=1;var g_tabParticipants=null;function ParticipantsForm(d,e,a,c,b){this.activity=d;this.idList=c;this.labels=e;this.boxes=a;this.statusList=b}function generateParticipantsSelectionForm(h,b){var a=$("<form>",{"class":"participant-form"}).appendTo(h);var n=currentMillis();var l=(g_loggedInUser!=null&&g_loggedInUser.id==b.host.id&&n<b.beginTime);var r=new Array();var e=new Array();var k=new Array();var c=new Array();for(var m=0;m<b.selectedParticipants.length;++m){var o=b.selectedParticipants[m];k.push(o.id);c.push(g_aliasSelected);var d=$("<p>").appendTo(a);var f=$("<label>",{"class":"participant-label"}).appendTo(d);r.push(f);var j=$("<input>",{type:"checkbox","class":"participant-checkbox"}).appendTo(f);e.push(j);j.hide();var p=$("<img>",{src:o.avatar,"class":"participant-avatar"}).click(o,function(i){i.preventDefault();var t=i.data;window.location.hash=("profile?"+g_keyVieweeId+"="+t.id.toString())}).appendTo(f);var g=$("<plaintext>",{"class":"participant-label-name selected-participant",text:o.name}).appendTo(f)}for(var m=0;m<b.appliedParticipants.length;++m){var o=b.appliedParticipants[m];k.push(o.id);c.push(g_aliasApplied);var d=$("<p>").appendTo(a);var f=$("<label>",{"class":"participant-label"}).appendTo(d);r.push(f);var j=$("<input>",{type:"checkbox","class":"participant-checkbox"}).appendTo(f);e.push(j);if(!l){j.hide()}var p=$("<img>",{src:o.avatar,"class":"participant-avatar"}).click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+o.id.toString())}).appendTo(f);var g=$("<plaintext>",{"class":"participant-label-name applied-participant",text:o.name}).appendTo(f)}var s=new ParticipantsForm(b,r,e,k,c);if(!l||b.appliedParticipants.length==0||e.length<=1){return s}var q=$("<button>",{text:TITLES.submit_participant_selection,"class":"purple participant-confirm"}).appendTo(a);q.click(s,function(A){A.preventDefault();var t=A.data;var B=new Array();for(var x=0;x<t.labels.length;x++){var y=t.boxes[x];if(isHidden(y)||!isChecked(y)){continue}var z=t.idList[x];if(z==t.activity.host.id){continue}B.push(z)}if(B.length==0){return}var u=$.cookie(g_keyToken);if(u==null){return}if(B.length+t.activity.numSelected>g_maxSelected){alert(ALERTS.selected_num_exceeded);return}var w={};w[g_keyToken]=u;w[g_keyActivityId]=t.activity.id;w[g_keyBundle]=JSON.stringify(B);var v=getTarget(A);disableField(v);$.ajax({type:"POST",url:"/el/activity/participants/update",data:w,success:function(G,C,H){enableField(v);if(isTokenExpired(G)){logout(null);return}if(isSelectedLimitExceeded(G)){alert(ALERTS.selected_num_exceeded);return}if(!isStandardSuccess(G)){return}for(var E=0;E<t.labels.length;++E){var D=t.labels[E];if(t.statusList[E]==g_aliasSelected){continue}var F=t.boxes[E];if(isHidden(F)||!isChecked(F)){continue}D.removeClass("applied-participant");D.addClass("selected-participant");F.hide();t.statusList[E]=g_aliasSelected}},error:function(D,i,C){enableField(v)}})});$("<hr>").appendTo(a);return s}var g_commentId=null;var g_pagerSubComments=null;function listSubCommentsAndRefresh(b){var a=1;listSubComments(a,b,onListSubCommentsSuccess,onListSubCommentsError)}function listSubComments(b,e,d,a){g_commentId=e;var c=generateCommentsListParams(g_pagerSubComments,b);$.ajax({type:"GET",url:"/comment/sub/list",data:c,success:function(g,f,h){d(g)},error:function(h,f,g){a(g)}})}function onListSubCommentsSuccess(c){if(g_activity==null||c==null){return}var e=c[g_keySubComments];var b=Object.keys(e).length;var a=parseInt(c[g_keyPageSt]);var h=parseInt(c[g_keyPageEd]);var g=a;g_pagerSubComments.screen.empty();var f=[];for(var i=1;i<=b;++i){var j=e[i-1];var d=new Comment(j);f.push(d);if(g==g_pagerSubComments.page){generateSubCommentCell(g_pagerSubComments.screen,j,g_activity)}if(i%g_pagerSubComments.nItems!=0){continue}g_pagerSubComments.cache.putPage(g,f);f=[];++g}if(f!=null&&f.length>0){g_pagerSubComments.cache.putPage(g,f)}g_pagerSubComments.refreshBar()}function onListSubCommentsError(a){}var g_comment=null;var g_activityId=null;var g_activity=null;var g_replyEditor=null;var g_onCommentSubmitSuccess=null;var g_pagerComments=null;function CommentReplyEditor(a,b,c){this.input=a;this.submit=b;this.collapse=c;this.focus=function(){this.input.focus()};this.remove=function(){this.input.parent().remove()}}function listCommentsAndRefresh(b){var a=1;listComments(a,onListCommentsSuccess,onListCommentsError)}function listComments(b,d,a){var c=generateCommentsListParams(g_pagerComments,b);$.ajax({type:"GET",url:"/comment/list",data:c,success:function(f,e,g){d(f)},error:function(g,e,f){a(f)}})}function generateCommentsListParams(a,d){var f={};if(g_commentId!=null){f[g_keyParentId]=g_commentId}if(g_activity!=null){f[g_keyActivityId]=g_activity.id}var c=d-2;var b=d+2;var e=c<1?(c-1):0;c-=e;b-=e;f[g_keyPageSt]=c;f[g_keyPageEd]=b;f[g_keyNumItems]=a.nItems;f[g_keyOrientation]=g_orderDescend;return f}function onListCommentsSuccess(c){if(g_activity==null||c==null){return}var j=c[g_keyComments];var b=Object.keys(j).length;var a=parseInt(c[g_keyPageSt]);var g=parseInt(c[g_keyPageEd]);var f=a;g_pagerComments.screen.empty();var e=[];for(var h=1;h<=b;++h){var i=j[h-1];var d=new Comment(i);e.push(d);if(f==g_pagerComments.page){generateCommentCell(g_pagerComments.screen,i,g_activity,false)}if(h%g_pagerComments.nItems!=0){continue}g_pagerComments.cache.putPage(f,e);e=[];++f}if(e!=null&&e.length>0){g_pagerComments.cache.putPage(f,e)}g_pagerComments.refreshBar()}function onListCommentsError(a){}function removeReplyEditor(){if(g_replyEditor==null){return}g_replyEditor.remove();g_replyEditor=null}function generateReplyEditor(d,f,g){var b=$("<p>").appendTo(d);var a=$("<input>",{placeholder:HINTS.reply.format(g.fromUser.name)}).appendTo(b);var e=$("<button>",{text:TITLES.submit_comment_reply,"class":"comment-submit purple"}).appendTo(b);e.click(a,function(i){i.preventDefault();var h=i.data;var l=i.data.val();var k=$.cookie(g_keyToken);if(l==null||!validateCommentContent(l)){alert(ALERTS.comment_requirement);return}var n=g.parentId==(-1)?g.id:g.parentId;var m={};m[g_keyContent]=l;m[g_keyParentId]=n;m[g_keyPredecessorId]=g.id;m[g_keyActivityId]=f.id;m[g_keyToken]=k;m[g_keyTo]=g.from;var j=$(i.srcElement?i.srcElement:i.target);disableField(j);disableField(h);$.ajax({type:"POST",url:"/el/comment/sub/submit",data:m,success:function(p,o,q){enableField(j);enableField(h);if(isTokenExpired(p)){logout(null);return}removeReplyEditor();if(g_onCommentSubmitSuccess==null){return}g_onCommentSubmitSuccess()},error:function(q,o,p){enableField(j);enableField(h);alert(MESSAGES.comment_reply_not_submitted)}})});var c=$("<button>",{text:TITLES.collapse,"class":"comment-collapse gray"}).appendTo(b);c.click(function(h){h.preventDefault();removeReplyEditor()});return new CommentReplyEditor(a,e,c)}function generateCommentCell(j,a,c,n){var b=new Comment(a);var p=$("<div>",{"class":"comment-group"}).appendTo(j);var g=$("<div>",{"class":"comment-row clearfix"}).appendTo(p);if(n){g.addClass("single-row")}var l=$("<div>",{text:b.content,"class":"comment-content left"}).appendTo(g);var o=$("<div>",{"class":"comment-from left"}).appendTo(g);var f=$("<a>",{href:"#",text:b.fromUser.name,target:"_blank"}).appendTo(o);f.click(function(t){t.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+b.from.toString())});var q=$("<div>",{text:gmtMiilisecToLocalYmdhis(b.generatedTime),"class":"comment-time left"}).appendTo(g);if(!n&&b.numChildren>3){var k=$("<div>",{"class":"comment-view left"}).appendTo(g);var d=$("<a>",{text:TITLES.view_all_replies.format(b.numChildren)}).appendTo(k);d.click(b.id,function(t){t.preventDefault();g_pagerComments.squeeze();setOffset(g_pagerComments.screen.parent(),"-100%",null);g_pagerSubComments.expand(null);setOffset(g_pagerSubComments.screen.parent(),"0%",null);var u=t.data;listSubCommentsAndRefresh(u)})}if(!n){var i=a[g_keySubComments];for(var r in i){var s=i[r];generateSubCommentCell(p,s,c)}}var h=$.cookie(g_keyToken);if(h==null||c.hasBegun()){return}var m=$("<div>",{"class":"comment-action left"}).appendTo(g);var e=$("<button>",{text:TITLES.reply,"class":"purple comment-reply"}).appendTo(m);e.click(p,function(u){u.preventDefault();var t=u.data;removeReplyEditor();g_replyEditor=generateReplyEditor(t,c,b);g_replyEditor.focus()})}function generateSubCommentCell(j,m,d){var g=new Comment(m);var i=$("<div>",{"class":"comment-group subgroup"}).appendTo(j);var o=$("<div>",{"class":"comment-row clearfix"}).appendTo(i);var c=$("<div>",{"class":"comment-to left"}).appendTo(o);var l=$("<a>",{href:"#",text:TITLES.replied_to.format(g.toUser.name),target:"_blank"}).appendTo(c);l.click(function(p){p.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+g.to.toString())});var h=$("<div>",{text:g.content,"class":"comment-content left"}).appendTo(o);var k=$("<div>",{"class":"comment-from left"}).appendTo(o);var b=$("<a>",{href:"#",text:g.fromUser.name,target:"_blank"}).appendTo(k);b.click(function(p){p.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+g.from.toString())});var f=$("<div>",{text:gmtMiilisecToLocalYmdhis(g.generatedTime),"class":"comment-time left"}).appendTo(o);var e=$.cookie(g_keyToken);if(e==null||d.hasBegun()){return i}var a=$("<div>",{"class":"comment-action left"}).appendTo(o);var n=$("<button>",{text:TITLES.reply,"class":"purple comment-reply"}).appendTo(a);n.click(i,function(q){q.preventDefault();var p=q.data;removeReplyEditor();g_replyEditor=generateReplyEditor(p,d,g);g_replyEditor.focus()})}function generateCommentEditor(d,f){var c=$("<div>",{"class":"activity-comment"}).appendTo(d);var a=$("<input>",{}).appendTo(c);var e=$("<button>",{text:TITLES.submit_comment_question,"class":"purple"}).appendTo(c);var b=new WordCounter("",5,128,g_commentContentPattern,ALERTS.comment_requirement);b.appendCounter(c);a.on("input paste keyup",b,function(g){g.data.update($(this).val())});e.click({counter:b,input:a},function(h){h.preventDefault();var l=a.val();var j=$.cookie(g_keyToken);if(l==null||!validateCommentContent(l)){return}var m={};m[g_keyContent]=l;m[g_keyActivityId]=f.id;m[g_keyToken]=j;var k=h.data.counter;var g=h.data.input;var i=$(h.srcElement?h.srcElement:h.target);disableField(i);disableField(g);$.ajax({type:"POST",url:"/el/comment/submit",data:m,success:function(o,n,p){enableField(i);enableField(g);if(isTokenExpired(o)){logout(null);return}g.val("");k.update("");listCommentsAndRefresh(f,null,null)},error:function(p,n,o){enableField(i);enableField(g);alert(ALERTS.comment_question_not_submitted)}})})}var g_batchAssessmentEditor=null;var g_tabAssessments=null;var g_updatingAttendance=false;var g_onRefresh=null;var g_lockedCount=0;var g_btnSubmit=null;var g_sectionAssessmentEditors=null;var g_sectionAssessmentButtons=null;function createAssessment(b,c){var a={};a.content=b;a.to=c;return new Assessment(a)}function SingleAssessmentEditor(){this.participantId=0;this.name="";this.content="";this.lock=null}function BatchAssessmentEditor(){this.switchAttendance=null;this.selectAll=null;this.editors=null}function generateAssessmentEditor(f,a,g,c){var b=new SingleAssessmentEditor();var h=$("<div>",{"class":"assessment-input-row"}).appendTo(f);var e=$("<img>",{src:a.avatar,"class":"assessment-avatar"}).click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+a.id.toString())}).appendTo(h);var d=$("<a>",{href:"#",text:a.name}).appendTo(h);d.click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+a.id.toString())});b.participantId=a.id;b.name=a.name;if(g.containsRelation()&&((g.relation&assessed)==0)){generateUnassessedView(h,b,c)}else{generateAssessedView(h,a,g)}if(g_loggedInUser!=null&&g_loggedInUser.id==a.id){h.hide()}return b}function generateAssessmentEditors(e,g,a){e.empty();var b=g.selectedParticipants;var f=new Array();for(var c=0;c<b.length;c++){var d=generateAssessmentEditor(e,b[c],g,a);f.push(d)}return f}function generateAssessmentButtons(c,e,a){c.empty();if(a.editors==null||a.editors.length<=1){return}var f=$("<div>",{"class":"assessment-button"}).appendTo(c);var d=$("<button>",{text:TITLES.check_all,"class":"gray assessment-button"}).appendTo(f);d.click(a,function(g){g.preventDefault();for(var h=0;h<g.data.editors.length;h++){var j=g.data.editors[h];j.lock.prop("checked",true).change()}});var b=$("<button>",{text:TITLES.uncheck_all,"class":"gray assessment-button"}).appendTo(f);b.click(a,function(g){g.preventDefault();for(var h=0;h<g.data.editors.length;h++){var j=g.data.editors[h];j.lock.prop("checked",false).change()}});g_btnSubmit=$("<button>",{text:TITLES.submit,"class":"purple assessment-button"}).appendTo(f);g_btnSubmit.click({editor:a,activity:e},function(q){q.preventDefault();if(g_loggedInUser==null){return}var s=q.data.editor;var p=q.data.activity;var r=new Array();for(var l=0;l<s.editors.length;l++){var m=s.editors[l];var n=m.content;var o=m.participantId;if(o==g_loggedInUser.id){continue}var g=createAssessment(n,o);r.push(g)}if(r.length==0){return}var k={};var h=$.cookie(g_keyToken);k[g_keyToken]=h;k[g_keyActivityId]=p.id;k[g_keyBundle]=JSON.stringify(r);var j=$(this);disableField(j);$.ajax({type:"POST",url:"/assessment/submit",data:k,success:function(t,i,u){enableField(j);if(isTokenExpired(t)){logout(null);return}alert(ALERTS.assessment_submitted);p.relation|=assessed;refreshBatchEditor(p)},error:function(u,i,t){enableField(j);alert(ALERTS.assessment_not_submitted)}})}).appendTo(f);disableField(g_btnSubmit)}function generateBatchAssessmentEditor(h,a,f){h.empty();if(g_onRefresh==null){g_onRefresh=f}g_lockedCount=0;g_batchAssessmentEditor=new BatchAssessmentEditor();if(a==null){return g_batchAssessmentEditor}var g=[];var k=$("<div>",{"class":"assessment-container"}).appendTo(h);var d=false;var b=false;if(g_loggedInUser!=null&&a.host.id==g_loggedInUser.id){d=true;b=true}else{if((a.relation&present)>0){d=true}else{if((a.relation&selected)>0||(a.relation&absent)>0){d=false}else{b=true}}}var j=createBinarySwitch(k,b,d,TITLES.assessment_disabled,TITLES.present,TITLES.absent,"switch-attendance");g_sectionAssessmentEditors=$("<div>",{style:"margin-top: 5pt"}).appendTo(k);g_sectionAssessmentButtons=$("<div>",{style:"margin-top: 5pt"}).appendTo(k);if(g_loggedInUser!=null&&(((a.relation&present)>0)||(a.containsRelation()==false))){refreshBatchEditor(a)}var e=function(n){g_updatingAttendance=false;var l=n;a.relation=parseInt(l[g_keyRelation]);g_sectionAssessmentEditors.empty();g_sectionAssessmentButtons.empty();var m=getBinarySwitchState(j);if(!m){return}refreshBatchEditor(a)};var c=function(l){g_updatingAttendance=false;var n=getBinarySwitchState(j);var m=!n;setBinarySwitch(j,m)};var i=function(l){l.preventDefault();if(a.relation==invalid){return}if(!a.hasBegun()){alert(ALERTS.activity_not_begun);return}var n=getBinarySwitchState(j);var m=!n;setBinarySwitch(j,m);attendance=a.relation;if(m){attendance=present}else{attendance=absent}updateAttendance(a.id,attendance,e,c)};setBinarySwitchOnClick(j,i);return g_batchAssessmentEditor}function updateAttendance(a,f,e,c){if(g_updatingAttendance){return}var b=$.cookie(g_keyToken);if(b==null){return}var d={};d[g_keyRelation]=f;d[g_keyToken]=b;d[g_keyActivityId]=a;g_updatingAttendance=true;$.ajax({type:"PUT",url:"/activity/mark",data:d,success:function(h,g,i){if(isTokenExpired(h)){logout(null);return}e(h)},error:function(i,g,h){c(h)}})}function generateAssessedView(d,a,c){var b=$("<span>",{text:TITLES.view_assessment,style:"display: inline; color: blue; margin-left: 5pt; cursor: pointer"}).appendTo(d);b.click(function(e){e.preventDefault();queryAssessmentsAndRefresh(a.id,c.id)})}function generateUnassessedView(e,a,b){var c=$("<input>",{type:"checkbox","class":"left"}).appendTo(e);var d=$("<input>",{type:"text"}).appendTo(e);d.on("input paste keyup",a,function(f){f.data.content=$(this).val()});c.change({input:d,editor:b},function(g){var f=g.data.input;var i=g.data.editor;g.preventDefault();var h=isChecked($(this));if(!h){enableField(f);--g_lockedCount;if(g_btnSubmit!=null){disableField(g_btnSubmit)}}else{disableField(f);++g_lockedCount;if(g_lockedCount>=(i.editors.length-1)&&g_btnSubmit!=null){enableField(g_btnSubmit)}}});a.lock=c}function refreshBatchEditor(b){if(!b.hasBegun()){return}if(g_batchAssessmentEditor==null||g_sectionAssessmentEditors==null||g_sectionAssessmentButtons==null){return}var a=generateAssessmentEditors(g_sectionAssessmentEditors,b,g_batchAssessmentEditor);g_batchAssessmentEditor.editors=a;g_sectionAssessmentButtons.empty();if(!b.containsRelation()||(b.containsRelation()&&(b.relation&assessed)>0)||g_batchAssessmentEditor.editors.length<=1){return}generateAssessmentButtons(g_sectionAssessmentButtons,b,g_batchAssessmentEditor)}var g_sectionAssessmentsViewer=null;var g_modalAssessmentsViewer=null;var g_assessmentsViewer=null;var g_nAssessmentsPerPage=20;var g_pagerAssessments=null;function removeAssessmentsViewer(){if(g_sectionAssessmentsViewer==null){return}g_sectionAssessmentsViewer.hide();g_sectionAssessmentsViewer.modal("hide");if(g_modalAssessmentsViewer==null){return}g_modalAssessmentsViewer.empty();if(g_assessmentsViewer==null){return}g_assessmentsViewer.remove()}function initAssessmentsViewer(b){g_sectionAssessmentsViewer=$("<div class='modal fade' tabindex='-1' role='dialog' aria-labelledby='' aria-hidden='true'>",{style:"position: absolute; width: 80%; height: 80%;"}).appendTo(b);var a=$("<div>",{"class":"modal-dialog modal-lg"}).appendTo(g_sectionAssessmentsViewer);g_modalAssessmentsViewer=$("<div>",{"class":"modal-content"}).appendTo(a);removeAssessmentsViewer()}function showAssessmentsViewer(a){g_modalAssessmentsViewer.empty();g_assessmentsViewer=generateAssessmentsViewer(g_modalAssessmentsViewer,a);g_sectionAssessmentsViewer.modal({show:true})}function generateAssessmentsViewer(h,k){if(k==null){return null}var g=$("<div>",{style:"padding: 10%"}).appendTo(h);var c=$("<table class='assessments-viewer'>").appendTo(g);var j=$("<tr class='assessments-viewer-row'>").appendTo(c);$("<th>",{text:TITLES.content,"class":"assessments-viewer-header-content"}).appendTo(j);$("<th>",{text:TITLES.from,"class":"assessments-viewer-header-from"}).appendTo(j);for(var d=0;d<k.length;d++){var a=k[d];var l=$("<tr class='assessments-viewer-row'>").appendTo(c);$("<td>",{text:a.content}).appendTo(l);var b=$("<td>").appendTo(l);var e=$("<img>",{src:a.fromUser.avatar,"class":"assessments-viewer-avatar"}).appendTo(b);var f=$("<span>",{text:a.fromUser.name,"class":"assessments-viewer-name"}).appendTo(b)}return g}function onQueryAssessmentsSuccess(e){if(e==null||Object.keys(e).length==0){alert(ALERTS.no_assessment);return}var b=new Array();for(var d in e){var a=e[d];var c=new Assessment(a);b.push(c)}showAssessmentsViewer(b)}function onQueryAssessmentsError(a){}function queryAssessments(e,c,d,g,a){var b=$.cookie(g_keyToken);if(b==null){focusLogin();return}var f={};if(e!=null){f[g_keyRefIndex]=e}if(c!=null){f[g_keyNumItems]=c}if(d!=null){f[g_keyDirection]=parseInt(d)}f[g_keyToken]=b;f[g_keyTo]=g;f[g_keyActivityId]=a;$.ajax({type:"GET",url:"/assessment/query",data:f,success:function(i,h,j){onQueryAssessmentsSuccess(i)},error:function(j,h,i){onQueryAssessmentsError(i)}})}function generateAssessmentTag(c,b){var a=$("<span>",{text:b.content,"class":"assessment-tag"}).click(b,function(d){d.preventDefault();var e=d.data;window.location.hash=("detail?"+g_keyActivityId+"="+e.activityId)}).appendTo(c)}function queryAssessmentsAndRefresh(b,a){queryAssessments(0,g_nAssessmentsPerPage,g_directionForward,b,a)}function onListAssessmentsSuccess(f){if(f==null||Object.keys(f).length==0){return}var b=new Array();for(var e in f){var a=f[e];var d=new Assessment(a);b.push(d)}for(var c=0;c<b.length;++c){var d=b[c];generateAssessmentTag(g_pagerAssessments.screen,d)}}function onListAssessmentsError(a){}function generateAssessmentsListParams(c,h){if(h==null){return null}var d=$.cookie(g_keyToken);if(d==null){focusLogin();return}var e={};e[g_keyToken]=d;var a=h-2;var j=h+2;var f=a<1?(a-1):0;a-=f;j-=f;e[g_keyPageSt]=a;e[g_keyPageEd]=j;if(c.nItems!=null){e[g_keyNumItems]=c.nItems}if(g_activityId!=null){e[g_keyActivityId]=g_activityId}if(c.filters!=null){for(var g=0;g<c.filters.length;++g){var b=c.filters[g];e[b.key]=b.selector.val()}}if(c.extraParams==null){return e}for(var k in c.extraParams){e[k]=c.extraParams[k]}return e}function listAssessments(b,d,a){var c=generateAssessmentsListParams(g_pagerAssessments,b);$.ajax({type:"GET",url:"/assessment/list",data:c,success:function(f,e,g){if(isTokenExpired(f)){logout(null);return}d(f)},error:function(g,e,f){a(f)}})}function listAssessmentsAndRefresh(){var a=1;listAssessments(a,onListAssessmentsSuccess,onListAssessmentsError)}var g_sectionNotifications=null;var g_pagerNotifications=null;var g_notificationTrash=null;function emptySectionNotifications(){if(g_sectionNotifications==null){return}g_sectionNotifications.empty()}function clearNotifications(){var a=$("#toolbar");a.empty();setDimensions(a,"100%",0);$("#pager-filters").empty();$("#pager-bar-notifications").empty();$("#pager-screen-notifications").empty();emptySectionNotifications()}function countNotifications(){var a=$.cookie(g_keyToken);if(a==null){return}var b={};b[g_keyToken]=a;$.ajax({type:"GET",url:"/notification/count",data:b,success:function(e,c,f){if(g_loggedInUser==null){return}if(isTokenExpired(e)){logout(null);return}var d=parseInt(e[g_keyCount]);g_loggedInUser.unreadCount=d;g_postLoginMenu.bubble.update(d)},error:function(e,c,d){}})}function NotificationTrash(a){this.toolbar=a;this.btnTrash=null;this.btnDelete=null;this.btnBack=null;this.cells=[];this.isActive=false;this.activate=function(){for(var c=0;c<this.cells.length;++c){var b=this.cells[c];b.prependCheckbox()}this.btnTrash.hide();this.btnBack.show();this.btnDelete.show();this.isActive=true};this.deactivate=function(){for(var c=0;c<this.cells.length;++c){var b=this.cells[c];b.removeCheckbox()}this.btnTrash.show();this.btnBack.hide();this.btnDelete.hide();this.isActive=false};this.updateCells=function(b){this.cells=b;if(this.isActive){this.activate()}else{this.deactivate()}};this.init=function(){setDimensions(this.toolbar,"100%","30px");this.btnTrash=$("<button>",{style:"position: absolute;"}).appendTo(this.toolbar);this.btnTrash.width("25px");this.btnTrash.height("25px");setOffset(this.btnTrash,"0px",null);setBackgroundImageDefault(this.btnTrash,"/assets/icons/trash.png");this.btnTrash.click(this,function(b){b.preventDefault();var c=b.data;if(c.isActive){return}c.activate()});this.btnBack=$("<button>",{style:"position: absolute;"}).appendTo(this.toolbar);this.btnBack.width("25px");this.btnBack.height("25px");this.btnBack.hide();setOffset(this.btnBack,"0px",null);setBackgroundImageDefault(this.btnBack,"/assets/icons/back.png");this.btnBack.click(this,function(b){b.preventDefault();var c=b.data;c.deactivate()});this.btnDelete=$("<button>",{style:"position: absolute;"}).appendTo(this.toolbar);this.btnDelete.width("25px");this.btnDelete.height("25px");this.btnDelete.hide();setOffset(this.btnDelete,"50px",null);setBackgroundImageDefault(this.btnDelete,"/assets/icons/delete.png");this.btnDelete.click(this,function(d){d.preventDefault();var f=d.data;if(f.cells.length==0){return}var c=[];for(var h=0;h<f.cells.length;++h){var b=f.cells[h];if(b.checkbox==null||!b.checkbox.is(":checked")){continue}c.push(b.notification.id)}var j={};var g=$.cookie(g_keyToken);if(g==null){return}j[g_keyToken]=g;j[g_keyBundle]=JSON.stringify(c);var e=$(d.srcElement?d.srcElement:d.target);disableField(e);$.ajax({type:"POST",data:j,url:"/notification/delete",success:function(k,i,l){enableField(e);if(isTokenExpired(k)){logout(null);return}if(!isStandardSuccess(k)){return}listNotificationsAndRefresh()},error:function(l,i,k){enableField(e);alert("Error occurs!")}})})}}function listNotificationsAndRefresh(){var a=1;listNotifications(a,onListNotificationsSuccess,onListNotificationsError)}function listNotifications(b,d,a){var c=generateNotificationsListParams(g_pagerNotifications,b);$.ajax({type:"GET",url:"/notification/list",data:c,success:function(f,e,g){if(isTokenExpired(f)){logout(null);return}d(f)},error:function(g,e,f){a(f)}})}function generateNotificationsListParams(c,h){var e={};if(g_loggedInUser==null){return null}var d=$.cookie(g_keyToken);e[g_keyToken]=d;var a=h-2;var j=h+2;var f=a<1?(a-1):0;a-=f;j-=f;e[g_keyPageSt]=a;e[g_keyPageEd]=j;e[g_keyNumItems]=c.nItems;e[g_keyOrientation]=g_orderDescend;if(c.filters!=null){for(var g=0;g<c.filters.length;++g){var b=c.filters[g];if(b.selector.val()==null||b.selector.val()==""){continue}e[b.key]=b.selector.val()}}return e}function onListNotificationsSuccess(f){var c=f;if(c==null){return}var j=c[g_keyNotifications];var b=Object.keys(j).length;var a=parseInt(c[g_keyPageSt]);var i=parseInt(c[g_keyPageEd]);var h=a;g_pagerNotifications.screen.empty();var e=$("<table class='notifications-viewer'>").appendTo(g_pagerNotifications.screen);var l=[];var n=[];for(var k=1;k<=b;++k){var g=j[k-1];var d=new Notification(g);l.push(d);if(h==g_pagerNotifications.page){var m=generateNotificationCell(e,d);n.push(m)}if(k%g_pagerNotifications.nItems!=0){continue}g_pagerNotifications.cache.putPage(h,l);l=[];++h}g_notificationTrash.updateCells(n);if(l!=null&&l.length>0){g_pagerNotifications.cache.putPage(h,l)}g_pagerNotifications.refreshBar()}function onListNotificationsError(a){}function NotificationCell(b,e,a){this.container=b;this.notification=e;this.indicator=a;this.isSelected=false;this.checkbox=null;this.prependCheckbox=function(){var f=$("<td>").prependTo(this.container);this.checkbox=$("<input>",{type:"checkbox"}).appendTo(f)};this.removeCheckbox=function(){if(this.checkbox==null){return}this.checkbox.parent().remove();this.checkbox.remove();this.checkbox=null};this.container.click(this.notification,function(g){if(g_notificationTrash.isActive){return}g.preventDefault();var f=g.data;window.location.hash=("detail?"+g_keyActivityId+"="+f.activityId)});if(this.notification.isRead!=0){var c=$("<div>",{"class":"notification-read"}).appendTo(this.indicator);return}var d=$("<div>",{"class":"notification-unread"}).appendTo(this.indicator);this.container.click(this,function(g){if(g_notificationTrash.isActive){return}g.preventDefault();var i=g.data;var f=i.notification;var h=$.cookie(g_keyToken);if(h==null){return}var j={};j[g_keyToken]=h;j[g_keyId]=f.id;j[g_keyIsRead]=1;$.ajax({type:"POST",url:"/el/notification/mark",data:j,success:function(l,k,m){if(isTokenExpired(l)){logout(null);return}window.location.hash=("detail?"+g_keyActivityId+"="+f.activityId)},error:function(m,k,l){}})})}function generateNotificationCell(d,g){var b=$("<tr class = 'notifications-viewer-row'>",{}).appendTo(d);var c=$("<td>",{text:g.id,"class":"notification-id"}).appendTo(b);var e=$("<td>",{text:g.content,"class":"notification-content"}).appendTo(b);var f=$("<td>",{text:gmtMiilisecToLocalYmdhis(g.generatedTime),"class":"notification-time"}).appendTo(b);var a=$("<td>",{"class":"notification-envelope"}).appendTo(b);return new NotificationCell(b,g,a)}function requestNotifications(){clearHome();clearProfile();clearDetail();g_notificationTrash=new NotificationTrash($("#toolbar"));g_notificationTrash.init();var b=createSelector($("#pager-filters"),["全部","未讀","已讀"],["",0,1],null,null,null,null);var e=new PagerFilter(g_keyIsRead,b);var f=[e];var c=new PagerCache(5);g_pagerNotifications=new Pager($("#pager-screen-notifications"),$("#pager-bar-notifications"),10,"/notification/list",generateNotificationsListParams,null,c,f,onListNotificationsSuccess,onListNotificationsError);var d=function(i){countNotifications();listNotificationsAndRefresh()};var a=function(i){clearNotifications()};var h=function(i){clearNotifications()};var g=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,d,a,h,g);g_onActivitySaveSuccess=null;checkLoginStatus()}var g_vieweeId=null;var g_pager=null;var g_onJoined=null;function onBtnEditClicked(a){a.preventDefault();var b=a.data;var c=b[g_keyActivity];if(g_activityEditor==null){return}g_activityEditor.refresh(c);g_activityEditor.show()}function listActivities(b,d,a){var c=generateActivitiesListParams(g_pager,b);$.ajax({type:"GET",url:"/activity/list",data:c,success:function(f,e,g){if(isTokenExpired(f)){logout(null);return}d(f)},error:function(g,e,f){a(f)}})}function listActivitiesAndRefresh(){var a=1;listActivities(a,onListActivitiesSuccess,onListActivitiesError)}function generateActivitiesListParams(c,h){if(h==null){return null}var e={};if(g_vieweeId!=null){e[g_keyVieweeId]=g_vieweeId}var a=h-2;var j=h+2;var f=a<1?(a-1):0;a-=f;j-=f;e[g_keyPageSt]=a;e[g_keyPageEd]=j;if(c.nItems!=null){e[g_keyNumItems]=c.nItems}if(g_vieweeId!=null){e[g_keyVieweeId]=g_vieweeId}if(c.filters!=null){for(var g=0;g<c.filters.length;++g){var b=c.filters[g];e[b.key]=b.selector.val()}}if(!e.hasOwnProperty(g_keyOrientation)){e[g_keyOrientation]=g_orderDescend}var d=$.cookie(g_keyToken);if(d!=null){e[g_keyToken]=d}return e}function onListActivitiesSuccess(h){var d=h;var a=parseInt(d[g_keyPageSt]);var j=parseInt(d[g_keyPageEd]);var i=a;var g=d[g_keyActivities];var c=Object.keys(g).length;g_pager.screen.empty();var e=[];for(var k=1;k<=c;++k){var b=g[k-1];var f=new Activity(b);e.push(f);if(i==g_pager.page){generateActivityCell(g_pager.screen,f)}if(k%g_pager.nItems!=0){continue}g_pager.cache.putPage(i,e);e=[];++i}if(e!=null&&e.length>0){g_pager.cache.putPage(i,e)}g_pager.refreshBar()}function onListActivitiesError(a){}function displayTimesTable(d,h){var f=$("<div>",{"class":"time-table dealine clearfix"}).appendTo(d);var b=$("<div>",{text:TITLES.deadline,"class":"time-label left"}).appendTo(f);var e=$("<div>",{text:gmtMiilisecToLocalYmdhis(h.applicationDeadline),"class":"time-detail left"}).appendTo(f);if(h.isDeadlineExpired()){f.addClass("expired")}var c=$("<div>",{"class":"time-table begin clearfix"}).appendTo(d);var g=$("<div>",{text:TITLES.begin_time,"class":"time-label left"}).appendTo(c);var a=$("<div>",{text:gmtMiilisecToLocalYmdhis(h.beginTime),"class":"time-detail left"}).appendTo(c);if(h.hasBegun()){c.addClass("expired")}}function displayParticipantStatistics(b,d){var a=$("<ul>",{"class":"clearfix"}).appendTo(b);var e=$("<li>",{text:d.numSelected.toString()+" "+TITLES.selected,"class":"selected left"}).appendTo(a);var c=$("<li>",{text:(d.numApplied+d.numSelected).toString()+" "+TITLES.applied,"class":"applied left"}).appendTo(a)}function onBtnJoinClicked(a){var d=$(this);a.preventDefault();var e=a.data;if(e.isDeadlineExpired()){alert(ALERTS.deadline_expired);return}if(e.numApplied>=g_maxApplied){alert(ALERTS.applicant_num_exceeded);return}var c=$.cookie(g_keyToken).toString();var f={};f[g_keyActivityId]=e.id;f[g_keyToken]=c;var b=$(a.srcElement?a.srcElement:a.target);disableField(b);$.ajax({type:"POST",url:"/el/activity/join",data:f,success:function(h,g,i){enableField(b);if(isTokenExpired(h)){logout(null);return}if(isApplicationLimitExceeded(h)){alert(ALERTS.applicant_num_exceeded);return}if(!isStandardSuccess(h)){return}if(g_onJoined==null){return}g_onJoined(e.id)},error:function(i,g,h){enableField(b)}})}function attachJoinButton(b,c){if(c.relation==null&&!c.isDeadlineExpired()){var a=$("<button>",{"class":"btn-join purple right",text:TITLES.join}).appendTo(b);a.click(c,onBtnJoinClicked)}else{attachRelationIndicator(b,c,false)}}function attachRelationIndicator(c,d,b){if(d.relation==null||g_loggedInUser==null||g_loggedInUser.id==d.host.id){return}var a={};a[applied]=RELATION_NAMES.applied;a[selected]=RELATION_NAMES.selected;a[present]=RELATION_NAMES.present;a[absent]=RELATION_NAMES.absent;a[assessed]=RELATION_NAMES.assessed;a[hosted]=RELATION_NAMES.hosted;if(b){$("<div>",{"class":"activity-cell-relation",text:a[getPriorRelation(d)]}).appendTo(c)}else{$("<div>",{"class":"activity-detail-relation right",text:a[getPriorRelation(d)]}).appendTo(c)}}function attachStatusIndicator(c,d){if(d.status==null){return}var f=[STATUS_NAMES.created,STATUS_NAMES.pending,STATUS_NAMES.rejected,STATUS_NAMES.accepted];var b=$("<div>",{"class":"activity-cell-status",text:f[d.status]}).appendTo(c);if(d.status!=g_statusCreated&&d.status!=g_statusRejected){return}var a=$("<button>",{"class":"activity-edit"}).appendTo(b);var e={};e[g_keyActivity]=d;a.click(e,onBtnEditClicked)}function getPriorRelation(a){if((a.relation&assessed)>0){return assessed}if((a.relation&present)>0){return present}if((a.relation&absent)>0){return absent}if((a.relation&selected)>0){return selected}if((a.relation&applied)>0){return applied}}function generateActivityCell(j,b){var e=null;if(b.images!=null){for(var s in b.images){var u=b.images[s];e=u.url;break}}var r=null;if(b.priority>0){r=$("<div>",{"class":"cell-container clearfix prioritized"}).appendTo(j)}else{r=$("<div>",{"class":"cell-container clearfix"}).appendTo(j)}var d=$("<div>",{"class":"activity-cover left"}).appendTo(r);var a=$("<span>",{"class":"image-helper"}).appendTo(d);if(e!=null){var o=$("<img>",{src:e}).appendTo(d)}var q=$("<div>",{"class":"activity-info left"}).appendTo(r);var t=$("<p>",{"class":"activity-title truncate",text:b.title}).appendTo(q);var h=$("<p>",{"class":"activity-addr truncate",text:b.address}).appendTo(q);displayTimesTable(q,b);var k=$("<div>",{"class":"activity-attend"}).appendTo(q);displayParticipantStatistics(k,b);var v=$("<div>",{"class":"selected-snippet"}).appendTo(q);if(b.selectedParticipants!=null){var g=b.selectedParticipants.length<=3?b.selectedParticipants.length:3;for(var l=0;l<g;++l){var n=b.selectedParticipants[l];$("<img>",{title:n.name,src:n.avatar,"class":"selected-snippet-avatar left"}).click(n,function(i){i.preventDefault();var w=i.data;window.location.hash=("profile?"+g_keyVieweeId+"="+w.id.toString())}).appendTo(v)}}var c=$("<div>",{"class":"activity-action-small right"}).appendTo(q);var m=$("<button>",{"class":"activity-detail-small purple right"}).appendTo(c);m.click(b,function(w){w.preventDefault();var i=w.data;window.location.hash=("detail?"+g_keyActivityId+"="+i.id.toString())});attachStatusIndicator(c,b);attachRelationIndicator(c,b,true);var p=$("<div>",{"class":"activity-action right"}).appendTo(r);var f=$("<button>",{"class":"activity-detail purple",text:TITLES.view}).appendTo(p);f.click(b,function(w){w.preventDefault();var i=w.data;window.location.hash=("detail?"+g_keyActivityId+"="+i.id.toString())});attachStatusIndicator(p,b);attachRelationIndicator(p,b,true)}var g_deleteConfirmation=null;var g_activityEditor=null;var g_modalActivityEditor=null;var g_sectionActivityEditor=null;var g_classBtnSubmit="btn-submit purple";var g_classBtnDelete="btn-delete gray";var g_classBtnSave="btn-save purple";var g_classBtnCancel="btn-cancel gray";var g_indexOldImage="old_image";var g_indexNewImage="new_image";var g_wImageCell=200;var g_hImageCell=200;var g_hDelete=30;var g_imagesLimit=3;var g_onEditorRemoved=null;var g_onEditorCancelled=null;var g_onActivitySaveSuccess=null;var g_loadingWidget=null;function ImageSelector(c,b,a){this.id=c;this.image=b;this.indicator=a;this.checked=true}function AddressField(a,b){this.input=a;this.map=b}function ActivityEditor(){this.id=null;this.container=null;this.dialog=null;this.titleField=null;this.titleCounter=null;this.addressField=null;this.addressCounter=null;this.contentField=null;this.contentCounter=null;this.newImageFiles=null;this.newImageNodes=null;this.imageSelectors=null;this.beginTimePicker=null;this.deadlinePicker=null;this.btnSave=null;this.btnSubmit=null;this.btnDelete=null;this.explorerTrigger=null;this.hint=null;this.captcha=null;this.refresh=function(d){var g=false;if(d==null||d.id==null){g=true}var m=null;var f="";var i="";var a="";if(!g){this.id=d.id;m=d.id;f=d.title;i=d.address;a=d.content}this.content.empty();var c=$("<form>",{"class":"activity-editor-form"}).appendTo(this.content);this.titleField=$("<input>",{placeholder:HINTS.activity_title,"class":"input-title",type:"text",value:f}).appendTo(c);this.titleCounter=new WordCounter(f,1,64,g_activityTitlePattern,"");this.titleCounter.appendCounter(c);this.titleField.on("input paste keyup",this.titleCounter,function(v){g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();v.data.update($(this).val())});var b=$("<input>",{placeholder:HINTS.activity_address,"class":"input-address",type:"text",value:i}).appendTo(c);this.addressCounter=new WordCounter(i,1,256,g_activityAddressPattern,"");this.addressCounter.appendCounter(c);b.on("input paste keyup",this.addressCounter,function(v){g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();v.data.update($(this).val())});this.addressField=new AddressField(b,null);this.contentField=$("<textarea>",{placeholder:HINTS.activity_content,"class":"input-content"}).appendTo(c);this.contentField.val(a);this.contentCounter=new WordCounter(a,1,1024,g_activityContentPattern,"");this.contentCounter.appendCounter(c);this.contentField.on("input paste keyup",this.contentCounter,function(v){g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();v.data.update($(this).val())});$("<div>",{"class":"warning",html:MESSAGES.image_selection_requirement}).appendTo(c);this.newImageFiles={};this.newImageNodes={};this.imageSelectors=new Array();var u=$("<div>",{"class":"image-row new clearfix"});if(d!=null&&d.images!=null){generateOldImagesRow(c,editor,d)}u.appendTo(c);var n=function(v){v.preventDefault();if(g_activityEditor==null){return}if(countImages(g_activityEditor)>=g_imagesLimit){alert(ALERTS.image_selection_limit_exceeded.format(g_imagesLimit));return}g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();previewImage(u,g_activityEditor)};this.explorerTrigger=generateExplorerTriggerSpan(u,n,"/assets/icons/add.png",g_wImageCell,g_hImageCell,g_wImageCell*2/3,g_hImageCell*2/3);var r=reformatDate(new Date());if(d!=null&&d.applicationDeadline!=null){r=d.applicationDeadline}var l=reformatDate(new Date());if(d!=null&&d.beginTime!=null){l=d.beginTime}var t=$("<div>",{"class":"edit-deadline clearfix"}).appendTo(c);var k=$("<div>",{text:TITLES.deadline,"class":"left edit-label"}).appendTo(t);var j=$("<div>",{"class":"datetime-picker left"}).appendTo(t);this.deadlinePicker=generateDateSelection(j,gmtMiilisecToLocalYmdhi(r));var s=$("<div>",{"class":"edit-begin clearfix"}).appendTo(c);var q=$("<div>",{text:TITLES.begin_time,"class":"left edit-label"}).appendTo(s);var p=$("<div>",{"class":"datetime-picker left"}).appendTo(s);this.beginTimePicker=generateDateSelection(p,gmtMiilisecToLocalYmdhi(l));var e=null;this.captcha=null;if(g){e=generateUuid();this.captcha=new Captcha(e);this.captcha.appendTo(c)}var o=$("<div>",{"class":"edit-button-rows"}).appendTo(c);this.btnSave=$("<button>",{"class":g_classBtnSave,text:TITLES.save}).appendTo(o);this.btnSave.click(onSave);this.btnSubmit=$("<button>",{"class":g_classBtnSubmit,text:TITLES.submit}).appendTo(o);var h={};h[g_keyActivityId]=m;this.btnSubmit.click(h,onSubmit);this.btnCancel=$("<button>",{"class":g_classBtnCancel,text:TITLES.cancel}).appendTo(o);this.btnCancel.click(onCancel);this.btnDelete=null;if(!g){this.btnDelete=$("<button>",{"class":g_classBtnDelete,text:TITLES["delete"]}).appendTo(o);this.btnDelete.click(function(v){v.preventDefault();if(g_deleteConfirmation!=null){g_deleteConfirmation.remove()}g_deleteConfirmation=generateDeleteConfirmation(g_activityEditor.content,d)})}this.hint=$("<div>",{"class":"hint"}).appendTo(c);this.setNonSavable();this.setSubmittable()};this.appendTo=function(a){this.container=$("<div class='modal fade activity-editor' data-keyboard='false' data-backdrop='static' tabindex='-1' role='dialog' aria-labelledby='create' aria-hidden='true'>").appendTo(a);this.dialog=$("<div class='modal-dialog modal-lg'>").appendTo(this.container);this.content=$("<div class='modal-content'>").appendTo(this.dialog)};this.savable=false;this.submittable=true;this.disableEditorButtons=function(){disableField(this.btnSave);this.btnSave.addClass("disabled-button");disableField(this.btnSubmit);this.btnSubmit.addClass("disabled-button");if(this.btnDelete==null){return}disableField(this.btnDelete);this.btnDelete.addClass("disabled-button")};this.enableEditorButtons=function(){if(this.savable){enableField(this.btnSave);this.btnSave.removeClass("disabled-button")}if(this.submittable){enableField(this.btnSubmit);this.btnSubmit.removeClass("disabled-button")}if(this.btnDelete!=null){enableField(this.btnDelete);this.btnDelete.removeClass("disabled-button")}};this.setNonSavable=function(){this.savable=false;disableField(this.btnSave);this.btnSave.addClass("disabled-button")};this.setSavable=function(){this.savable=true;this.enableEditorButtons()};this.setNonSubmittable=function(){this.submittable=false;disableField(this.btnSubmit);this.btnSubmit.addClass("disabled-button")};this.setSubmittable=function(){this.submittable=true;this.enableEditorButtons()};this.show=function(){this.container.modal("show")};this.hide=function(){this.container.modal("hide")};this.remove=function(){this.container.remove()}}function initActivityEditor(b,a){g_onEditorRemoved=a;g_activityEditor=new ActivityEditor();g_onEditorCancelled=function(){g_activityEditor.container.modal("hide")};g_activityEditor.appendTo(b)}function DeleteConfirmation(b,c,a,d){this.container=b;this.activity=c;this.btnYes=a;this.btnNo=d;this.btnYes.click(this.activity.id,onDelete);this.btnNo.click(this.container,function(e){e.preventDefault();var f=e.data;f.remove()});this.remove=function(){this.container.remove()}}function formatDigits(c,b){var a=c.toString();while(a.length<b){a="0"+a}return a}function formatDate(g){g=g.replace(/-/g,"/");var c=new Date(Date.parse(g));var e=c.getFullYear();var f=c.getMonth()+1;var b=c.getDate();var a=c.getHours();var d=c.getMinutes();return e+"-"+formatDigits(f,2)+"-"+formatDigits(b,2)+" "+formatDigits(a,2)+":"+formatDigits(d,2)}function reformatDate(c){var e=c.getFullYear();var f=c.getMonth()+1;var b=c.getDate();var a=c.getHours();var d=c.getMinutes();return e+"-"+formatDigits(f,2)+"-"+formatDigits(b,2)+" "+formatDigits(a,2)+":"+formatDigits(d,2)}function countImages(d){var b=Object.keys(d.newImageFiles).length;for(var c in d.imageSelectors){var a=d.imageSelectors[c];if(!a.checked){continue}++b}return b}function onSave(f){f.preventDefault();if(g_activityEditor==null||!g_activityEditor.savable){return}var m=new FormData();var d=$.cookie(g_keyToken.toString());if(d==null){alert(ALERTS.please_log_in);return}m.append(g_keyToken,d);var a=0;for(var s in g_activityEditor.newImageFiles){var p=g_activityEditor.newImageFiles[s];if(!validateImage(p)){m=null;return}m.append(g_indexNewImage+"-"+s.toString(),p)}a=Object.keys(g_activityEditor.newImageFiles).length;var g=new Array();for(var o=0;o<g_activityEditor.imageSelectors.length;o++){var n=g_activityEditor.imageSelectors[o];if(!n.checked){continue}g.push(n.id);++a}m.append(g_indexOldImage,JSON.stringify(g));if(a>g_imagesLimit){alert(ALERTS.image_selection_requirement);return}var t=g_activityEditor.titleField.val();var b=g_activityEditor.addressField.input.val();var l=g_activityEditor.contentField.val();var r=g_activityEditor.titleCounter;var e=g_activityEditor.addressCounter;var h=g_activityEditor.contentCounter;if(!r.valid()||!e.valid()||!h.valid()){alert(ALERTS.please_follow_activity_field_instructions);return}m.append(g_keyTitle,t);m.append(g_keyAddress,b);m.append(g_keyContent,l);var k=localYmdhisToGmtMillisec(g_activityEditor.beginTimePicker.getDatetime());var q=localYmdhisToGmtMillisec(g_activityEditor.deadlinePicker.getDatetime());if(q<0||k<0||q>k){alert(ALERTS.deadline_behind_begin_time);return}m.append(g_keyBeginTime,k);m.append(g_keyDeadline,q);var c=false;var j=g_activityEditor.id;if(j==null){c=true}if(!c){m.append(g_keyActivityId,j)}else{m.append(g_keySid,g_activityEditor.captcha.sid);m.append(g_keyCaptcha,g_activityEditor.captcha.input.val())}g_activityEditor.disableEditorButtons();g_activityEditor.setNonSavable();g_activityEditor.setNonSubmittable();g_activityEditor.hint.text(MESSAGES.activity_saving);$.ajax({method:"POST",url:"/activity/save",data:m,mimeType:"mutltipart/form-data",contentType:false,processData:false,success:function(v,u,x){var i=JSON.parse(v);if(isTokenExpired(i)){logout(null);return}if(isCaptchaNotMatched(i)){alert(ALERTS.captcha_not_matched);g_activityEditor.setSavable();g_activityEditor.enableEditorButtons();g_activityEditor.hint.text(MESSAGES.activity_not_saved);return}if(isCreationLimitExceeded(i)){alert(ALERTS.creation_limit_exceeded);g_activityEditor.setSavable();g_activityEditor.enableEditorButtons();g_activityEditor.hint.text(MESSAGES.activity_not_saved);return}g_activityEditor.setSubmittable();g_activityEditor.enableEditorButtons();var w=new Activity(i);if(g_activityEditor.id==null){g_activityEditor.hint.text(MESSAGES.activity_created)}else{g_activityEditor.hint.text(MESSAGES.activity_saved)}g_activityEditor.id=w.id;g_activityEditor.refresh(w);if(g_onActivitySaveSuccess==null){return}g_onActivitySaveSuccess()},error:function(v,i,u){g_activityEditor.setSavable();g_activityEditor.enableEditorButtons();g_activityEditor.hint.text(MESSAGES.activity_not_saved)}})}function onSubmit(a){a.preventDefault();if(g_activityEditor==null||!g_activityEditor.submittable){return}var d=a.data;var e={};var c=$.cookie(g_keyToken);if(c==null){alert(ALERTS.please_log_in);return}e[g_keyToken]=c;var b=g_activityEditor.id;e[g_keyActivityId]=b;g_activityEditor.disableEditorButtons();g_activityEditor.setNonSavable();g_activityEditor.setNonSubmittable();$.ajax({method:"POST",url:"/activity/submit",data:e,success:function(g,f,h){if(isTokenExpired(g)){logout(null);return}if(!isStandardSuccess(g)){return}g_activityEditor.enableEditorButtons();g_activityEditor.hide();if(g_onEditorRemoved==null){return}g_onEditorRemoved()},error:function(h,f,g){g_activityEditor.enableEditorButtons();g_activityEditor.setSubmittable()}})}function previewImage(c,b){var d=b.explorerTrigger.getFile();if(!validateImage(d)){return}var a=new FileReader();a.onload=function(j){var g=new Date().getTime();var k=Object.keys(b.newImageFiles).length;b.newImageFiles[g]=d;var i=$("<div>",{"class":"preview-container left"}).appendTo(c);b.newImageNodes[g]=i;var h=$("<span>",{"class":"image-helper"}).appendTo(i);var f=$("<img>",{src:j.target.result}).appendTo(i);var l=$("<button>",{text:TITLES["delete"],"class":"purple image-delete"}).appendTo(i);b.explorerTrigger.shift(+1,g_wImageCell);l.click(function(e){e.preventDefault();b.setSavable();b.setNonSubmittable();if(!b.newImageFiles.hasOwnProperty(g)){return}delete b.newImageFiles[g];if(!b.newImageNodes.hasOwnProperty(g)){return}b.newImageNodes[g].remove();delete b.newImageNodes[g];for(var n in b.newImageNodes){if(n<g){continue}var m=b.newImageNodes[n]}b.explorerTrigger.shift(-1,g_wImageCell)})};a.readAsDataURL(d)}function onDelete(a){a.preventDefault();var c=a.data;var d=$.cookie(g_keyToken);var e={};e[g_keyActivityId]=c;e[g_keyToken]=d;var b=getTarget(a);disableField(b);$.ajax({type:"POST",url:"/activity/delete",data:e,success:function(g,f,h){enableField(b);if(isTokenExpired(g)){logout(null);return}g_activityEditor.hide();if(g_onEditorRemoved==null){return}g_onEditorRemoved()},error:function(h,f,g){enableField(b)}})}function onCancel(a){a.preventDefault();g_activityEditor.hide();if(g_onEditorCancelled==null){return}g_onEditorCancelled()}function generateOldImagesRow(h,g,a){var f=$("<div>",{"class":"image-row old clearfix"}).appendTo(h);var l=Object.keys(a.images).length;for(var e=0;e<l;e++){var b=$("<div>",{"class":"preview-container left"}).appendTo(f);var k=$("<span>",{"class":"image-helper"}).appendTo(b);var d=$("<img>",{src:a.images[e].url}).appendTo(b);var j=$("<img>",{"class":"checked-image",src:"/assets/icons/checked.png"}).appendTo(b);var c=new ImageSelector(a.images[e].id,d,j);b.click(c,function(m){m.preventDefault();var i=m.data;var n=!(i.checked);if(n&&countImages(g)>=g_imagesLimit){return}i.checked=n;if(n){i.indicator.show()}else{i.indicator.hide()}g.setSavable();g.setNonSubmittable()});g.imageSelectors.push(c)}}function generateDateSelection(a,b){return generateDatePicker(a,b,function(c){c.preventDefault();g_activityEditor.setSavable();g_activityEditor.setNonSubmittable()})}function generateDeleteConfirmation(c,e){if(g_activityEditor==null){return}var b=$("<div>",{style:"padding: 5pt;"}).appendTo(c);var g=$("<p>",{text:MESSAGES.delete_activity_confirmation,style:"font-size: 18pt;"}).appendTo(b);var d=$("<p>").appendTo(b);var a=$("<button>",{text:TITLES.yes,style:"font-size: 16pt; background-color: cornflowerblue; color: white; margin-right: 10pt;"}).appendTo(d);var f=$("<button>",{text:TITLES.no,style:"font-size: 16pt; background-color: crimson; color: white; margin-left: 10pt;"}).appendTo(d);return new DeleteConfirmation(b,e,a,f)}var g_sectionActivity=null;var g_sectionNav=null;var g_sectionPanes=null;var g_barButtons=null;var g_navTab=null;var g_activityId=null;var g_activity=null;function emptyBarButtons(){if(g_barButtons==null){return}g_barButtons.empty()}function clearDetail(){if(g_sectionActivity!=null){g_sectionActivity.empty()}if(g_sectionNav!=null){g_sectionNav.empty()}if(g_sectionPanes!=null){g_sectionPanes.empty()}emptyBarButtons()}function queryActivityDetail(a){var b=$.cookie(g_keyToken);var c={};c[g_keyActivityId]=a;if(b!=null){c[g_keyToken]=b}$.ajax({type:"GET",url:"/activity/detail",data:c,success:function(f,e,g){var d=f;g_activity=new Activity(d);displayActivityDetail(g_sectionActivity);if(g_loggedInUser==null||g_loggedInUser.id==g_activity.host.id){emptyBarButtons();return}if(g_activity.isDeadlineExpired()&&g_activity.relation==null){emptyBarButtons();return}g_barButtons.empty();attachJoinButton(g_barButtons,g_activity)},error:function(f,d,e){alert(ALERTS.not_permitted_to_view_detail);emptyBarButtons();g_sectionActivity.empty()}})}function displayActivityDetail(f){g_onJoined=queryActivityDetail;f.empty();var e=$("<div>",{"class":"activity-detail-page"}).appendTo(f);var g=$("<div>",{text:g_activity.title,"class":"activity-title"}).appendTo(e);var h=$("<div>",{text:g_activity.address,"class":"activity-address"}).appendTo(e);if(g_activity.host.id!=null&&g_activity.host.name!=null){var k=$("<a>",{href:"#",text:TITLES.by_host.format(g_activity.host.name),"class":"activity-host"}).appendTo(e);k.click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+g_activity.host.id.toString())})}displayTimesTable(e,g_activity);var d=$("<div>",{text:g_activity.content,"class":"activity-content"}).appendTo(e);if(g_activity.images!=null){var b=$("<div>",{"class":"activity-image-container clearfix"}).appendTo(e);for(var c=0;c<g_activity.images.length;++c){var j=$("<div>",{"class":"activity-image left"}).appendTo(b);$("<span>",{"class":"image-helper"}).appendTo(j);$("<img>",{src:g_activity.images[c].url}).appendTo(j)}}g_tabParticipants.empty();g_participantsForm=generateParticipantsSelectionForm(g_tabParticipants,g_activity);listCommentsAndRefresh(g_activity);initAssessmentsViewer($("#content"));g_batchAssessmentEditor=generateBatchAssessmentEditor(g_tabAssessments,g_activity,queryActivityDetail);var a=$.cookie(g_keyToken);if(a==null){return e}if(g_activity.hasBegun()){$("<p>",{"class":"comment-not-permitted",text:MESSAGES.comment_disabled_activity_has_begun}).appendTo(e);return e}if(g_activity.status!=null&&g_activity.status!=undefined&&g_activity.status!=g_statusAccepted){$("<p>",{"class":"comment-not-permitted",text:MESSAGES.comment_disabled_activity_not_accepted}).appendTo(e);return e}generateCommentEditor(e,g_activity);g_onCommentSubmitSuccess=function(){if(g_commentId==null){listCommentsAndRefresh(g_activity)}else{listSubCommentsAndRefresh(g_commentId)}};return e}function onBtnSubmitClicked(a){a.preventDefault();var b=$(this).parent();b.submit(onParticipantsSelectionFormSubmission);b.submit()}function requestActivityDetail(n){clearProfile();clearHome();clearNotifications();g_activityId=n;g_sectionActivity=$("#section-activity");g_sectionNav=$("#section-nav");g_sectionPanes=$("#section-panes");g_barButtons=$("#section-user");var b=["tab-comments","tab-participants","tab-assessments"];var s=[TITLES.question,TITLES.participant,TITLES.assessment];var g=b[0];var i=$("<div>",{"class":"tab-container"});var e=$("<div>",{}).appendTo(i);var q=$("<div>",{"class":"paginator"}).appendTo(e);var l=$("<div>",{"class":"comment-content"}).appendTo(e);var j=$("<div>",{"class":"subcomment-container"}).appendTo(i);var f=$("<button>",{text:"< BACK","class":"purple back-button"}).appendTo(j);f.click(function(t){t.preventDefault();g_commentId=null;g_pagerComments.expand(null);g_pagerSubComments.squeeze()});var m=$("<div>").appendTo(j);var c=$("<div>").appendTo(j);var p=[i,null,null];g_navTab=createNavTab(g_sectionNav,b,s,g,g_sectionPanes,p);g_tabComments=g_navTab.panes[0];g_tabParticipants=g_navTab.panes[1];g_tabAssessments=g_navTab.panes[2];var k=new PagerCache(5);g_pagerComments=new Pager(l,q,5,"/comment/list",generateCommentsListParams,null,k,null,onListCommentsSuccess,onListCommentsError);var d=new PagerCache(20);g_pagerSubComments=new Pager(c,m,20,"/comment/sub/list",generateCommentsListParams,null,d,null,onListSubCommentsSuccess,onListSubCommentsError);g_pagerSubComments.squeeze();var h=function(t){countNotifications();queryActivityDetail(g_activityId)};var o=function(t){queryActivityDetail(g_activityId)};var a=function(t){queryActivityDetail(g_activityId)};var r=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,h,o,a,r,true);checkLoginStatus()}var g_sectionUser=null;var g_viewee=null;function emptySectionUser(){if(g_sectionUser==null){return}g_sectionUser.empty()}function clearProfile(){$("#pager-filters").empty();$("#pager-bar-activities").empty();$("#pager-screen-activities").empty();emptySectionUser()}function queryUserDetail(){var b={};b[g_keyVieweeId]=g_vieweeId;var a=$.cookie(g_keyToken);if(a!=null){b[g_keyToken]=a}$.ajax({type:"GET",url:"/user/detail",data:b,success:function(t,q,m){if(g_sectionUser==null){return}var k=t;g_viewee=new User(k);var g=g_viewee.name;g_sectionUser.empty();var e=$("<div>",{"class":"user-profile clearfix"}).appendTo(g_sectionUser);var o=$("<div>",{"class":"section-user-avatar left"}).appendTo(e);var n=$("<span>",{"class":"image-helper"}).appendTo(o);var p=$("<img>",{src:g_viewee.avatar}).appendTo(o);var j=$("<div>",{"class":"section-user-info left"}).appendTo(e);var u=$("<div>",{text:g,"class":"section-user-name"}).appendTo(j);if(g_pagerAssessments!=null){g_pagerAssessments.remove()}var f=$("<div>",{id:"pager-bar-assessments"}).appendTo(g_sectionUser);var l=$("<div>",{id:"pager-screen-assessments"}).appendTo(g_sectionUser);var r=new PagerCache(5);var s={to:g_viewee.id};g_pagerAssessments=new Pager(l,f,10,"/assessment/list",generateAssessmentsListParams,s,r,null,onQueryAssessmentsSuccess,onQueryAssessmentsError);if(g_loggedInUser==null){return}if(g_loggedInUser.isVisitor()&&g_vieweeId==g_loggedInUser.id){var d=null;var s={};s[g_keyToken]=$.cookie(g_keyToken);var h=function(v){if(v==null){return}if(isTokenExpired(v)){logout(null);return}d.text(MESSAGES.email_verification_sent.format(v[g_keyEmail]))};var i=function(v){d.text(MESSAGES.email_verification_not_sent)};var c=new AjaxButton(TITLES.resend_email_verification,"/user/email/resend",null,"POST",s,h,i);c.appendTo(g_sectionUser);d=$("<p>",{text:"",style:"padding: 10px;"}).appendTo(g_sectionUser)}if(g_loggedInUser.id==g_vieweeId){return}listAssessmentsAndRefresh()}})}function requestProfile(b){clearHome();clearDetail();clearNotifications();g_vieweeId=b;g_sectionUser=$("#section-user");var c=createSelector($("#pager-filters"),[TITLES.hosted_activities,TITLES.joined_activities],[hosted,present],null,null,null,null);var j=createSelector($("#pager-filters"),[TITLES.time_descendant,TITLES.time_ascendant],[g_orderDescend,g_orderAscend],null,null,null,null);var d=new PagerFilter(g_keyRelation,c);var i=new PagerFilter(g_keyOrientation,j);var a=[d,i];var k=new PagerCache(5);g_pager=new Pager($("#pager-screen-activities"),$("#pager-bar-activities"),g_numItemsPerPage,"/activity/list",generateActivitiesListParams,null,k,a,onListActivitiesSuccess,onListActivitiesError);var e=function(l){queryUserDetail();listActivitiesAndRefresh()};var f=function(l){queryUserDetail();listActivitiesAndRefresh()};var h=function(l){queryUserDetail();listActivitiesAndRefresh()};var g=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,e,f,h,g,true);g_onActivitySaveSuccess=listActivitiesAndRefresh;checkLoginStatus()}var g_registerWidget=null;var g_modalRegister=null;var g_sectionRegister=null;function RegisterWidget(a,c,j,e,d,k,l,g,b,i,f,h){this.name=a;this.nameCheck=c;this.email=j;this.emailCheck=e;this.psw=d;this.pswCheck=k;this.pswConfirm=l;this.pswConfirmCheck=g;this.btn=b;this.onSuccess=i;this.onError=f;this.captcha=h;this.hide=function(){this.name.hide();this.nameCheck.hide();this.email.hide();this.emailCheck.hide();this.psw.hide();this.pswCheck.hide();this.pswConfirm.hide();this.pswConfirmCheck.hide();this.btn.hide();this.captcha.hide()};this.show=function(){this.name.show();this.nameCheck.show();this.email.show();this.emailCheck.show();this.psw.show();this.pswCheck.show();this.pswConfirm.show();this.pswConfirmCheck.show();this.btn.show();this.captcha.show()};this.empty=function(){this.name.val("");this.nameCheck.text("");this.email.val("");this.emailCheck.text("");this.psw.val("");this.pswCheck.text("");this.pswConfirm.val("");this.pswConfirmCheck.text("");this.captcha.input.val("");this.captcha.img.attr("src","/captcha?"+g_keySid+"="+this.captcha.sid+"&ts="+new Date().getTime())};this.btn.click(this,function(n){var r=n.data;var t=r.name.val();var p=r.email.val();var o=r.psw.val();var q=r.pswConfirm.val();if(t==null||t.length==0||!validateName(t)||p==null||p.length==0||!validateEmail(p)||o==null||o.length==0||!validatePassword(o)||!validatePasswordConfirm(o,q)){return}var m=$(this);disableField(m);var s={};s[g_keyName]=t;s[g_keyEmail]=p;s[g_keyPassword]=o;s[g_keySid]=r.captcha.sid;s[g_keyCaptcha]=r.captcha.input.val();$.ajax({type:"POST",url:"/user/register",data:s,success:function(v,u,w){enableField(m);if(isCaptchaNotMatched(v)){alert(ALERTS.captcha_not_matched);if(r.onError!=null){r.onError(v)}return}r.empty();if(r.onSuccess==null){return}r.onSuccess(v)},error:function(w,u,v){enableField(m);if(r.onError==null){return}r.onError(v)}})});this.name.on("focusin focusout",this.nameCheck,function(m){m.preventDefault();var n=m.data;n.empty();n.html("");n.removeClass("warn");var p=$(this).val();if(p==null||p.length==0){return}if(!validateName(p)){n.html("<p>"+MESSAGES.username_requirement+"</p>");n.addClass("warn");return}var o={};o[g_keyName]=p;$.ajax({type:"GET",url:"/user/name/duplicate",data:o,success:function(r,q,s){if(isStandardSuccess(r)){n.html("<p>"+MESSAGES.username_valid+"</p>")}else{n.addClass("warn");n.html("<p>"+MESSAGES.username_invalid+"</p>")}},error:function(s,q,r){}})});this.email.on("focusin focusout",this.emailCheck,function(m){m.preventDefault();var o=m.data;o.empty();o.html("");o.removeClass("warn");var n=$(this).val();if(n==null||n.length==0){return}if(!validateEmail(n)){o.addClass("warn");o.html("<p>"+MESSAGES.email_requirement+"</p>");return}var p={};p[g_keyEmail]=n;$.ajax({type:"GET",url:"/user/email/duplicate",data:p,success:function(r,q,s){if(isStandardSuccess(r)){o.html("<p>"+MESSAGES.email_valid+"</p>")}else{o.addClass("warn");o.html("<p>"+MESSAGES.email_invalid+"</p>")}},error:function(s,q,r){}})});this.psw.on("input keyup paste",this.pswCheck,function(m){m.preventDefault();var o=m.data;o.empty();o.html("");o.removeClass("warn");var n=$(this).val();if(n==null||n.length==0){return}if(validatePassword(n)){return}o.addClass("warn");o.html("<p>"+MESSAGES.password_requirement+"</p>")});this.pswConfirm.on("input keyup paste",{0:this.pswConfirmCheck,1:this.psw},function(m){m.preventDefault();var n=m.data[0];var o=$(this).val();var p=m.data[1].val();n.empty();n.html("");n.removeClass("warn");if(validatePasswordConfirm(p,o)){return}n.addClass("warn");n.html("<p>"+MESSAGES.password_confirm_requirement+"</p>")})}function removeRegisterWidget(){if(g_sectionRegister==null){return}g_sectionRegister.empty();if(g_modalRegister==null){return}g_modalRegister.empty();g_modalRegister=null;g_sectionRegister.modal("hide")}function initRegisterWidget(b,c){removeRegisterWidget();if(!c){g_sectionRegister=$("<div>").appendTo(b);return}g_sectionRegister=$("<div class='modal fade activity-editor' tabindex='-1' role='dialog' aria-labelledby='create' aria-hidden='true'>").appendTo(b);var a=$("<div>",{"class":"modal-dialog modal-lg"}).appendTo(g_sectionRegister);g_modalRegister=$("<div>",{"class":"modal-content"}).appendTo(a)}function generateRegisterWidget(n,u,e,f){initRegisterWidget(n,u);var p=(u?g_modalRegister:g_sectionRegister);var v=$("<div>",{id:"register-box"}).appendTo(p);var l=$("<div>",{"class":"register-name"}).appendTo(v);var b=$("<input>",{type:"text",placeHolder:HINTS.username}).appendTo(l);var m=$("<div>",{"class":"message"}).appendTo(l);var r=$("<div>",{"class":"register-email"}).appendTo(v);var h=$("<input>",{type:"text",placeHolder:HINTS.email}).appendTo(r);var c=$("<div>",{"class":"message"}).appendTo(r);var a=$("<div>",{"class":"register-password"}).appendTo(v);var t=$("<input>",{type:"password",placeHolder:HINTS.password}).appendTo(a);var i=$("<div>",{"class":"message"}).appendTo(a);var j=$("<div>",{"class":"register-pswconfirm"}).appendTo(v);var g=$("<input>",{type:"password",placeHolder:HINTS.confirm_password}).appendTo(j);var q=$("<div>",{"class":"message"}).appendTo(j);var d=generateUuid();var k=new Captcha(d);k.appendTo(v);var o=$("<div>",{"class":"register-button"}).appendTo(v);var s=$("<button>",{text:TITLES.register,"class":"purple"}).appendTo(o);return new RegisterWidget(b,m,h,c,t,i,g,q,s,e,f,k)}function validatePasswordConfirm(b,a){if(b==null||a==null){return false}if(b!=a){return false}return true}var g_sectionLogin=null;var g_loggedInUser=null;var g_preLoginForm=null;var g_postLoginMenu=null;function PreLoginForm(g,c,b,h,a,d,e,i,f){this.handle=g;this.psw=c;this.btn=b;this.forgot=h;this.registry=a;this.onLoginSuccess=d;this.onLoginError=e;this.onLogoutSuccess=i;this.onLogoutError=f;this.handle.keypress(this,function(j){if(j.which!=13){return}var k=j.data;j.preventDefault();k.btn.click()});this.psw.keypress(this,function(j){if(j.which!=13){return}var k=j.data;j.preventDefault();k.btn.click()});this.btn.click(this,function(j){var n=j.data;var m=n.handle.val();var l=n.psw.val();if(m==null||m.length==0||!validateEmail(m)){alert(ALERTS.invalid_email_format);return}if(l==null||l.length==0||!validatePassword(l)){alert(ALERTS.wrong_password);return}var o={};o[g_keyEmail]=m;o[g_keyPassword]=l;var k=$(j.srcElement?j.srcElement:j.target);disableField(k);$.ajax({type:"POST",url:"/user/login",data:o,success:function(q,p,r){enableField(k);if(isUserNotFound(q)){alert(ALERTS.user_not_existing);return}if(isPswErr(q)){alert(ALERTS.wrong_password);return}g_loggedInUser=new User(q);if(g_loggedInUser==null){return}$.cookie(g_keyToken,q[g_keyToken],{path:"/"});wsConnect();if(g_sectionLogin==null){return}g_postLoginMenu=generatePostLoginMenu(g_sectionLogin,n.onLoginSuccess,n.onLoginError,n.onLogoutSuccess,n.onLogoutError);if(n.onLoginSuccess==null){return}n.onLoginSuccess(q)},error:function(r,p,q){enableField(k);if(n.onLoginError==null){return}n.onLoginError(q)}})});this.forgot.click(function(j){j.preventDefault();window.open("/user/password/index")});if(this.registry){this.registry.click(function(j){j.preventDefault();g_registerWidget=generateRegisterWidget($("#content"),true,null,null);g_sectionRegister.modal("show")})}}function NotiBubble(b,a){this.num=b;this.view=a;this.increase=function(c){this.num+=c;this.view.text(this.num.toString())};this.decrease=function(c){this.num-=c;this.view.text(this.num.toString())};this.update=function(c){this.num=c;this.view.text(this.num.toString())}}function PostLoginMenu(b,c,d,a,f,e){this.bubble=b;this.dropdownMenu=c;this.onLoginSuccess=d;this.onLoginError=a;this.onLogoutSuccess=f;this.onLogoutError=e}function generatePreLoginForm(l,f,g,m,i,e){if(l==null){return null}l.empty();var b=$("<div>",{id:"login-box"}).appendTo(l);var o=$("<div>",{"class":"login-row1 clearfix"}).appendTo(b);var h=$("<div>",{"class":"login-inputs left"}).appendTo(o);var j=$("<input>",{placeHolder:HINTS.email,type:"text","class":"login-email"}).appendTo(h);var d=$("<input>",{placeHolder:HINTS.password,type:"password","class":"login-pw"}).appendTo(h);var c=$("<button>",{text:TITLES.login,"class":"login-btn right purple"}).appendTo(o);var n=$("<div>",{"class":"login-bottom"}).appendTo(b);var k=$("<button>",{text:TITLES.forgot_password,"class":"login-forgot"}).appendTo(n);var a=null;if(e){a=$("<button>",{text:TITLES.register,"class":"login-registry"}).appendTo(n)}return new PreLoginForm(j,d,c,k,a,f,g,m,i)}function logout(a){a.preventDefault();var e=((a&&a.data)?a.data:g_postLoginMenu);if(e==null){return}var c=$.cookie(g_keyToken);var d={};d[g_keyToken]=c;var b=(a?$(a.srcElement?a.srcElement:a.target):null);disableField(b);$.ajax({type:"POST",url:"/user/logout",data:d,success:function(g,f,h){enableField(b);g_loggedInUser=null;$.removeCookie(g_keyToken,{path:"/"});wsDisconnect();if(g_sectionLogin==null){return}g_preLoginForm=generatePreLoginForm(g_sectionLogin,e.onLoginSuccess,e.onLoginError,e.onLogoutSuccess,e.onLogoutError);if(e.onLogoutSuccess==null){return}e.onLogoutSuccess(g)},error:function(h,f,g){enableField(b);wsDisconnect();$.removeCookie(g_keyToken,{path:"/"});if(e.onLogoutError==null){return}e.onLogoutError(g)}})}function generatePostLoginMenu(k,h,r,d,z){if(k==null){return null}if(g_loggedInUser==null){return null}k.empty();var p=function(A){A.preventDefault();if(g_activityEditor==null){return}g_activityEditor.refresh(null);g_activityEditor.show()};var i=function(A){A.preventDefault();if(g_loggedInUser==null){return}window.location.hash=("profile?"+g_keyVieweeId+"="+g_loggedInUser.id.toString())};var t=logout;var n=$("<div>",{"class":"user-box clearfix"}).appendTo(k);var x=$("<div>",{"class":"post-login-avatar left"}).appendTo(n);var o=$("<img>",{src:g_loggedInUser.avatar}).appendTo(x);var e=$("<span>",{text:TITLES.edit}).appendTo(x);x.click(function(A){A.preventDefault();if(g_loggedInUser==null){return}showAvatarEditor(g_loggedInUser)});var s=$("<div>",{"class":"user-box-left left clearfix"}).appendTo(n);var c=$("<div>",{"class":"left-first-row clearfix"}).appendTo(s);var a=$("<div>",{"class":"noti-container left"}).appendTo(c);a.click(function(A){A.preventDefault();if(g_loggedInUser==null){return}window.location.hash="notifications"});var q=$("<span>",{"class":"noti-bubble",text:"0"}).appendTo(a);var l=new NotiBubble(0,q);l.update(g_loggedInUser.unreadCount);var j=$("<div>",{"class":"username left",html:g_loggedInUser.name}).appendTo(c);var m=$("<div>",{"class":"menu-action-row"}).appendTo(s);var w=["/assets/icons/new_activity.png","/assets/icons/profile.png","/assets/icons/logout.png"];var f=["create","profile","logout"];var y=[TITLES.create,TITLES.profile,TITLES.logout];var g=[p,i,t];var v=createDropdownMenu(m,"menu-post-login",g_loggedInUser.name,w,f,y,g);var b=new PostLoginMenu(l,v,h,r,d,z);var u=[b,b,b];v.setReactionParams(u);return b}function checkLoginStatus(){var a=$.cookie(g_keyToken);if(a==null){if(g_preLoginForm==null){return}g_preLoginForm.onLoginError(null);return}if(g_loggedInUser!=null){if(g_preLoginForm==null){return}g_postLoginMenu=generatePostLoginMenu(g_sectionLogin,g_preLoginForm.onLoginSuccess,g_preLoginForm.onLoginError,g_preLoginForm.onLogoutSuccess,g_preLoginForm.onLogoutError);if(g_preLoginForm.onLoginSuccess==null){return}g_preLoginForm.onLoginSuccess(null);return}var b={};b[g_keyToken]=a;$.ajax({type:"GET",url:"/user/status",data:b,success:function(d,c,f){if(isStandardFailure(d)){wsDisconnect();$.removeCookie(g_keyToken,{path:"/"});if(g_preLoginForm.onLoginError==null){return}g_preLoginForm.onLoginError(null);return}var e=d;g_loggedInUser=new User(e);if(g_loggedInUser==null){return}$.cookie(g_keyToken,e[g_keyToken],{path:"/"});wsConnect();if(g_preLoginForm==null){return}g_postLoginMenu=generatePostLoginMenu(g_sectionLogin,g_preLoginForm.onLoginSuccess,g_preLoginForm.onLoginError,g_preLoginForm.onLogoutSuccess,g_preLoginForm.onLogoutError);if(g_preLoginForm.onLoginSuccess==null){return}g_preLoginForm.onLoginSuccess(d)},error:function(e,c,d){}})}function focusLogin(){}var g_topbar=null;function initTopbar(c){g_topbar=c;g_topbar.empty();g_topbar.addClass("clearfix");var b=$("<div>",{id:"topbar-title","class":"left"}).appendTo(g_topbar);var a=$("<p>",{text:"Let's Date"}).appendTo(b);g_sectionLogin=$("<div>",{id:"login-section","class":"right"}).appendTo(g_topbar);a.click(function(d){d.preventDefault();window.location.href="/"})}var g_footer=null;var g_announcementContainer=null;function initFooter(g){g_footer=g;var e=$("<div>",{id:"footer-links","class":"left"}).appendTo(g_footer);var c=$("<ul>",{"class":"clearfix"}).appendTo(e);var b=$("<li>").appendTo(c);var f=$("<a>",{text:TITLES.about_us}).appendTo(b);var a=$("<li>").appendTo(c);f.click(function(i){i.preventDefault();if(g_announcementContainer!=null){removeModal(g_announcementContainer)}g_announcementContainer=createModal($("#content"),MESSAGES.about_us,"80","90");showModal(g_announcementContainer)});var d=$("<a>",{text:TITLES.privacy_policy}).appendTo(a);d.click(function(i){i.preventDefault();if(g_announcementContainer!=null){removeModal(g_announcementContainer)}g_announcementContainer=createModal($("#content"),MESSAGES.privacy_policy,"80","90");showModal(g_announcementContainer)});var h=$("<div>",{id:"footer-copy","class":"right",html:"Copyright &copy; All rights reserved."}).appendTo(g_footer)}function AjaxButton(e,b,a,g,f,d,c){this.text=e;this.url=b;this.clickData=a;this.method=g;this.extraParams=f;this.onSuccess=d;this.onError=c;this.button=null;this.appendTo=function(h){this.remove();this.button=$("<button>",{text:this.text,"class":"indianred"}).appendTo(h);var i={url:this.url,method:this.method,clickData:this.clickData,extraParams:this.extraParams,onSuccess:this.onSuccess,onError:this.onError};this.button.click(i,function(k){k.preventDefault();var m=k.data.clickData;var n=k.data.url;var p=k.data.method;var o=k.data.extraParams;var j=k.data.onSuccess;var q=k.data.onError;var l=$(k.srcElement?k.srcElement:k.target);disableField(l);$.ajax({url:n,type:p,data:o,success:function(s,r,t){enableField(l);if(j==null){return}j(s)},error:function(t,r,s){enableField(l);if(q==null){return}q(s)}})})};this.remove=function(){if(this.button==null){return}this.button.remove();this.button=null}}function ExplorerTrigger(c,a,b){this.node=c;this.pic=a;this.btn=b;this.disable=function(){disableField(b)};this.enable=function(){enableField(b)};this.getFile=function(){if(this.btn==null){return null}var d=this.btn[0].files;if(d==null){return null}if(d.length!=1){alert(ALERTS.choose_one_image);return null}return d[0]};this.hide=function(){if(this.node==null){return}this.node.hide()};this.show=function(){if(this.node==null){return}this.node.show()};this.remove=function(){if(this.pic==null){return}this.pic.remove();this.pic=null;if(this.btn==null){return}this.btn.remove();this.btn=null;if(this.node==null){return}this.node.empty();this.node.remove();this.node=null};this.shift=function(f,g){var d=getOffset(this.node);switch(f){case -1:var e=d.left-g;setOffset(this.node,e,null);break;case +1:var e=d.left+g;setOffset(this.node,e,null);break}};this.changePic=function(d){this.pic.attr("src",d)}}function generateExplorerTriggerSpan(h,g,i,d,j,e,a){var c=$("<div>",{"class":"add-image"}).appendTo(h);setDimensions(c,d,j);setOffset(c,0,0);var f=$("<span>",{"class":"pic"}).appendTo(c);setBackgroundImageDefault(f,i);setDimensions(f,e,a);setOffset(f,(d-e)/2,(j-a)/2);var b=$("<input>",{type:"file"}).appendTo(c);setDimensions(b,d,j);b.change(g);return new ExplorerTrigger(c,f,b)}function DatetimePicker(a){this.input=a;this.getDatetime=function(){var b=this.input.val();if(b==null||b==""||b.length==0){return null}return b+":00"}}function generateDatePicker(g,c,h){var b=$("<div>",{}).appendTo(g);var a=$("<div>",{}).appendTo(b);var d=$("<div>",{"class":"input-group date"}).appendTo(a);var i=$("<input>",{type:"text",value:c,disabled:true,"class":"form-control"}).appendTo(d);var f=$("<span>",{"class":"input-group-addon"}).appendTo(d);var e=$("<span>",{"class":"glyphicon glyphicon-calendar"}).appendTo(f);d.datetimepicker({format:"YYYY-MM-DD HH:mm",pickSeconds:false,pick12HourFormat:false});b.on("input change keyup",h);return new DatetimePicker(i)}function createSelector(h,f,l,a,m,d,j){if(f.length!=l.length){return}var b=f.length;var g=$("<select>").appendTo(h);for(var e=0;e<b;++e){var k=f[e];var c=l[e];$("<option>",{text:k,value:c}).appendTo(g)}return g}function PagerFilter(b,a){this.key=b;this.selector=a}function PagerCache(a){this.size=a;this.map={};this.first=1;this.last=1;this.prependPage=function(c){var b=Object.keys(this.map).length;if(this.map.hasOwnProperty(this.last)&&b==this.size){delete this.map[this.last];--this.last}this.map[--this.first]=c};this.appendPage=function(c){var b=Object.keys(this.map).length;if(this.map.hasOwnProperty(this.first)&&b==this.size){delete this.map[this.first];++this.first}this.map[++this.last]=c};this.putPage=function(c,b){if(c>this.last){this.appendPage(b)}else{if(c<this.first){this.prependPage(b)}else{this.map[c]=b}}}}function PagerButton(a,b){this.pager=a;this.page=b}function Pager(m,h,g,a,l,k,n,c,j,f){this.screen=m;this.nItems=g;this.page=1;this.total=0;this.st=-g_inf;this.ed=g_inf;this.url=a;this.paramsGenerator=l;this.extraParams=k;this.onSuccess=j;this.onError=f;this.cache=n;this.bar=h;if(h==null){return}this.refreshBar=function(){var o=this;var u=o.page;var p=o.cache;o.bar.empty();var s=Object.keys(p.map).length;if(s<=1){return}for(var r in p.map){var q=parseInt(r);var i=$("<button>",{text:q,"class":"gray"}).appendTo(o.bar);var t=new PagerButton(o,q);i.click(t,function(w){if(o.url==null){return}var x=w.data;o.page=x.page;var y=o.paramsGenerator(o,x.page);if(y==null){return}var v=$(this);disableField(v);$.ajax({type:"GET",url:o.url,data:y,success:function(A,z,B){enableField(v);o.onSuccess(A)},error:function(B,z,A){enableField(v);o.onError(A)}})});if(q!=u){continue}i.off("mouseenter mouseleave");i.addClass("active")}};this.squeeze=function(){setDimensions(this.screen.parent(),"0px",null);this.screen.parent().hide()};this.expand=function(i){if(i==null){i="100%"}setDimensions(this.screen.parent(),i,null);this.screen.parent().show()};this.remove=function(){if(this.screen==null){return}this.screen.remove()};this.filters=c;if(c==null){return}var d=this;for(var e=0;e<c.length;++e){var b=c[e];b.selector.change(d,function(p){var o=p.data;var q=o.paramsGenerator(o,1);if(q==null){return}var i=b.selector;disableField(i);$.ajax({type:"GET",url:o.url,data:q,success:function(t,r,u){var s=o.cache.size;o.cache=new PagerCache(s);enableField(i);o.onSuccess(t)},error:function(t,r,s){enableField(i);o.onError(s)}})})}}function createModal(d,f,g,c){var a=$("<div class='modal fade general-popup' tabindex='-1' role='dialog' aria-labelledby='none' aria-hidden='true'>").appendTo(d);var b=$("<div class='modal-dialog modal-lg'>").appendTo(a);var e=$("<div class='modal-content'>").appendTo(b);var h=$("<div>",{"class":"general-popup-paragraph",text:f}).appendTo(e);return a}function showModal(a){a.modal("show")}function hideModal(a){a.modal("hide")}function removeModal(a){a.empty();a.remove();a=null}function createBinarySwitch(e,c,d,i,f,b,k){var a=$("<div class='onoffswitch'>").appendTo(e);var h=$("<input type='checkbox' class='onoffswitch-checkbox' id='"+k+"'>").appendTo(a);var g=$("<label class='onoffswitch-label' for='"+k+"'>").appendTo(a);var l=$("<span class='onoffswitch-inner'>").appendTo(g);var j=$("<span class='onoffswitch-switch'>").appendTo(g);l.attr("left-text",f);l.attr("right-text",b);if(c){disableBinarySwitch(a);l.attr("right-text",i);j.hide()}else{j.show()}setBinarySwitch(a,d);return a}function setBinarySwitch(a,c){var b=firstChild(a,"input.onoffswitch-checkbox");b.prop("checked",c)}function setBinarySwitchOnClick(a,c){var b=firstChild(a,"input.onoffswitch-checkbox");if(b.is(":disabled")){return}a.off("click").on("click",c)}function getBinarySwitchState(a){var b=firstChild(a,"input.onoffswitch-checkbox");return b.is(":checked")}function disableBinarySwitch(a){a.off("click");var b=firstChild(a,"input.onoffswitch-checkbox");b.prop("checked",false);disableField(b)}function DropdownMenu(a,b,c){this.toggle=a;this.items=b;this.reactions=c;this.reactionParams=null;this.setReactionParams=function(f){this.reactionParams=f;var e=f.length;for(var d=0;d<e;d++){this.items[d].click(f[d],c[d])}}}function createDropdownMenu(l,b,d,n,p,h,j){var c=h.length;if(c!=n.length){return}var a=$("<div>",{"class":"menu-actions"}).appendTo(l);var g=null;var k=$("<ul>",{}).appendTo(a);var o=[];for(var f=0;f<h.length;f++){var m=$("<li class='action-"+p[f]+"'>").appendTo(k);var e=$("<a tabindex='-1' href='#' title='"+h[f]+"'>").appendTo(m);e.text(h[f]);o.push(m)}return new DropdownMenu(g,o,j)}function NavTab(a){this.panes=a}function createNavTab(h,k,f,n,o,d){var g=$("<ul class='nav nav-pills' role='tablist'>").appendTo(h);var b=k.length;for(var e=0;e<b;e++){var m=null;if(k[e]==n){m=$("<li role='presentation' class='active'>").appendTo(g)}else{m=$("<li role='presentation'>").appendTo(g)}var a=$("<a href='#"+k[e]+"' role='tab' data-toggle='tab'>").appendTo(m);a.text(f[e])}var j=[];for(var e=0;e<b;e++){var l=(k[e]==n);var c=createNavTabPane(o,k[e],l,d[e]);j.push(c)}return new NavTab(j)}function createNavTabPane(b,d,a,c){var e=null;if(a){e=$("<div role ='tabpanel' class='tab-pane fade in active' id='"+d+"'>").appendTo(b)}else{e=$("<div role='tabpanel' class='tab-pane' fade id='"+d+"'>").appendTo(b)}if(c==null){return e}e.append(c);return e}function Captcha(a){this.sid=a;this.input=null;this.img=null;this.hide=function(){this.input.hide();this.img.hide();this.input.parent().hide()};this.show=function(){this.input.parent().show();this.input.show();this.img.show()};this.appendTo=function(c){var d=$("<div>",{"class":"captcha"}).appendTo(c);this.input=$("<input>",{placeHolder:HINTS.captcha}).appendTo(d);this.img=$("<img>",{src:"/captcha?"+g_keySid+"="+this.sid}).appendTo(d);var b=$("<button>",{"class":"change"}).appendTo(d);b.click(this,function(e){e.preventDefault();var f=e.data;f.img.attr("src","/captcha?"+g_keySid+"="+f.sid+"&ts="+new Date().getTime())})}}function WordCounter(e,b,a,c,d){this.text=e;this.min=b;this.max=a;this.regex=c;this.violationHint=d;this.currentText=null;this.maxText=null;this.hintText=null;this.update=function(f){this.text=f;this.currentText.text(f.length);if(this.valid()){this.currentText.css("color","gray");this.hintText.text("")}else{this.currentText.css("color","red");this.hintText.text(this.violationHint)}};this.appendCounter=function(f){var g=$("<p>").appendTo(f);this.currentText=$("<span>",{"class":"word-counter-current",text:this.text.length}).appendTo(g);this.maxText=$("<span>",{"class":"word-counter-max",text:"/"+this.max.toString()}).appendTo(g);this.hintText=$("<span>",{"class":"word-counter-violation-hint",text:""}).appendTo(g);this.update(this.text)};this.valid=function(){return(c.test(this.text))}}var g_avatarEditor=null;var g_sectionAvatarEditor=null;var g_modalAvatarEditor=null;function AvatarEditor(b,d,a,c,e){this.container=b;this.image=d;this.btnChoose=a;this.btnUpload=c;this.hint=e;this.getFile=function(){if(this.btnChoose==null){return null}var f=this.btnChoose[0].files;if(f==null){return null}if(f.length!=1){alert(ALERTS.choose_one_image);return null}return f[0]};this.btnChoose.change(this,function(g){g.preventDefault();var i=g.data;var h=i.getFile();if(h==null){return}if(!validateImage(h)){return}var f=new FileReader();f.onload=function(j){i.image.attr("src",j.target.result)};f.readAsDataURL(h)});this.btnUpload.click(this,function(f){f.preventDefault();var j=f.data;var i=j.getFile();if(!validateImage(i)){return}var h=$.cookie(g_keyToken);if(h==null){return}var k=new FormData();k.append(g_keyAvatar,i);k.append(g_keyToken,h);var g=$(this);disableField(g);j.hint.text(MESSAGES.uploading);$.ajax({method:"POST",url:"/user/avatar/upload",data:k,mimeType:"mutltipart/form-data",contentType:false,processData:false,success:function(m,l,n){enableField(g);j.hint.text(MESSAGES.uploaded)},error:function(n,l,m){enableField(g);j.hint.text(MESSAGES.upload_failed)}})});this.show=function(){this.container.show()};this.hide=function(){this.container.hide()};this.remove=function(){this.container.remove()}}function removeAvatarEditor(){if(g_sectionAvatarEditor==null){return}g_sectionAvatarEditor.hide();g_sectionAvatarEditor.modal("hide");if(g_modalAvatarEditor==null){return}g_modalAvatarEditor.empty();if(g_avatarEditor==null){return}g_avatarEditor.remove()}function refreshAvatarEditor(a){g_modalAvatarEditor.empty();g_avatarEditor=generateAvatarEditor(g_modalAvatarEditor,a)}function showAvatarEditor(a){refreshAvatarEditor(a);g_sectionAvatarEditor.modal("show")}function initAvatarEditor(b){g_sectionAvatarEditor=$("<div class='modal fade avatar-editor' tabindex='-1' role='dialog' aria-labelledby='AvatarEditor' aria-hidden='true'>").appendTo(b);var a=$("<div>",{"class":"modal-dialog modal-lg"}).appendTo(g_sectionAvatarEditor);g_modalAvatarEditor=$("<div>",{"class":"modal-content"}).appendTo(a);removeAvatarEditor()}function generateAvatarEditor(h,b){if(b==null){return null}var f=$("<div>",{"class":"avatar-editor-form clearfix"}).appendTo(h);var i=$("<div>",{"class":"avatar left"}).appendTo(f);var e=$("<span>",{"class":"image-helper"}).appendTo(i);var d=$("<img>",{src:b.avatar}).appendTo(i);var j=$("<div>",{"class":"upload left"}).appendTo(f);var g=$("<input>",{type:"file",text:TITLES.choose_picture}).appendTo(j);var c=$("<button>",{text:TITLES.upload,"class":"purple"}).appendTo(j);var a=$("<p>").appendTo(j);return new AvatarEditor(h,d,g,c,a)}var WS=window.MozWebSocket?MozWebSocket:WebSocket;var g_ws=null;function wsConnect(){if(g_ws!=null){return}var a=$.cookie(g_keyToken);if(a==null){return}var b=window.location.host;g_ws=new WS("ws://"+b+"/el/ws?"+g_keyToken+"="+a);g_ws.onopen=function(){};g_ws.onmessage=function(c){var d=JSON.parse(c.data);if(g_postLoginMenu==null){return}g_postLoginMenu.bubble.increase(1)};g_ws.onclose=function(){}}function wsDisconnect(){if(g_ws==null){return}g_ws.close();g_ws=null}function clearHome(){$("#pager-filters").empty();$("#pager-bar-activities").empty();$("#pager-screen-activities").empty();removeRegisterWidget()}function requestHome(){clearProfile();clearDetail();clearNotifications();g_registerWidget=generateRegisterWidget($("#section-register"),false,function(k){alert(ALERTS.registered)},function(k){alert(ALERTS.not_registered)});var h=createSelector($("#pager-filters"),[TITLES["default"],TITLES.begin_time,TITLES.deadline],["",g_keyBeginTime,g_keyDeadline],null,null,null,null);var g=createSelector($("#pager-filters"),[TITLES.descendant,TITLES.ascendant],[g_orderDescend,g_orderAscend],null,null,null,null);var i=new PagerFilter(g_keyOrderKey,h);var f=new PagerFilter(g_keyOrientation,g);var a=[i,f];var j=new PagerCache(5);g_pager=new Pager($("#pager-screen-activities"),$("#pager-bar-activities"),g_numItemsPerPage,"/activity/list",generateActivitiesListParams,null,j,a,onListActivitiesSuccess,onListActivitiesError);var b=function(k){if(g_registerWidget!=null){g_registerWidget.hide()}listActivitiesAndRefresh()};var c=function(k){if(g_registerWidget!=null){g_registerWidget.show()}g_pager.screen.show();listActivitiesAndRefresh()};var e=function(k){if(g_registerWidget!=null){g_registerWidget.show()}g_pager.screen.show();listActivitiesAndRefresh()};var d=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,b,c,e,d,false);g_onActivitySaveSuccess=null;checkLoginStatus()}function routeByHash(){var c=window.location.href;var b=extractTagAndParams(c);if(b==null){requestHome();return}var a=b.tag;var d=b.params;if(a==null||a==""||a=="home"){requestHome();return}if(a=="notifications"){requestNotifications();return}if(a=="detail"){requestActivityDetail(parseInt(d.activity_id));return}if(a=="profile"){requestProfile(parseInt(d.viewee_id));return}}$(document).ready(function(){initTopbar($("#topbar"));initFooter($("#footer-content"));initActivityEditor($("#content"),listActivitiesAndRefresh);initAvatarEditor($("#content"));$(window).on("hashchange",function(a){routeByHash()});routeByHash()});