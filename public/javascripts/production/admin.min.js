String.prototype.format=function(){var c=this;for(var a=0;a<arguments.length;a++){var b=new RegExp("\\{"+a+"\\}","gi");c=c.replace(b,arguments[a])}return c};var RELATION_NAMES={applied:"已報名",selected:"被選上啦",present:"與席",absent:"缺席",assessed:"已評價",hosted:""};var STATUS_NAMES={created:"已創建",pending:"等待審核",rejected:"未通過審核",accepted:"已通過審核"};var TITLES={logo_alias:"一起玩吧",all:"全部",unread:"未讀",read:"已讀",back:"返回",create:"創建",profile:"個人",register:"註冊帳號",login:"登入",logout:"登出",forgot_password:"忘記密碼",upload:"上傳",choose_picture:"選擇圖片",edit:"編輯",del:"刪除",update:"更新",save:"保存",submit:"提交",cancel:"取消",detail:"詳情",view:"詳細",join:"報名",begin_time:"開始時間",deadline:"報名截止",selected:"選中",applied:"報名",yes:"是",no:"否",submit_comment_question:"提交問題",submit_comment_reply:"提交",collapse:"收起",reply:"回覆",replied_to:"對@{0}: ",time_ascendant:"時間順序",time_descendant:"時間倒序",joined_activities:"參與的活動",hosted_activities:"發起的活動",question:"Q & A",participant:"參與者",assessment:"評價",view_assessment:"查看Ta收到的評價 >",assessment_disabled:"不可用",present:"已出席",absent:"未出席",from:"來自",content:"內容",by_host:"由 @{0} 發起",view_all_replies:"查看全部回覆({0})",about_us:"關於我們",contact_us:"聯絡我們",privacy_policy:"隱私聲明",copyright:"&copy; 2015 HKR",resend_email_verification:"重發驗證郵件",submit_participant_selection:"提交",new_password:"新密碼",confirm_new_password:"確認新密碼",input_to_reset_password:"請輸入新密碼並提交以完成修改",add_image:"+",send:"發送",check_all:"全選",uncheck_all:"清空已選",ascendant:"順序",descendant:"倒序",automatic:"自動",time:"時間",last_accepted_time:"審核完成時間",defaulted:"默認",age:"年齡",gender:"性別",mood:"心情",first_foreign_party_registration:"這是你的首次登入, 請填寫一個用戶名以完成註冊, 同時建議填寫電郵地址",first_foreign_party_registration_qq:"Hi, <span class='highlight'>QQ</span>用戶<span class='highlight'>{0}</span>, 這是你的首次登入, 請填寫一個用戶名以完成註冊, 同時建議填寫電郵地址"};var MESSAGES={saving:"正在保存...",saved:"已保存",save_failed:"保存失敗",uploading:"正在上傳...",uploaded:"上傳成功",upload_failed:"上傳失敗",delete_activity_confirmation:"確定要刪除此活動嗎？",playername_requirement:"用戶名需為6-32位由英文字母， 數字或符號'_'組成",playername_valid:"此用戶名可以使用",playername_invalid:"此用戶名已被佔用",email_valid:"此電郵地址可以使用",email_invalid:"此電郵地址已被佔用",email_requirement:"請填寫有效的電郵地址",password_requirement:"密碼需為6~32位由英文字母，數字或符號'#'，'_'及'!'組成",password_confirm_requirement:"密碼不匹配",comment_reply_not_submitted:"回覆未提交",assessment_requirement:"請填寫0～64個字",age_requirement:"請填寫0～16個字",gender_requirement:"請填寫0～16個字",mood_requirement:"請填寫0～64個字",comment_disabled_activity_has_begun:"Q&A時間已經結束",comment_disabled_activity_not_accepted:"活動尚未通過審核",email_verification_success:"Hi @{0}， 你的電郵地址{1}已完成驗證， {2}秒後將為你跳轉到首頁",email_verification_failure:"Hi @{0}， 很遺憾你的電郵地址{1}未能通過驗證， 如需幫助請與{2}聯繫",about_us:"關於我們\n\r\n\r仲未寫",privacy_policy:"隱私聲明\n\r\n\r仲未寫",please_wait:"請稍後...",email_verification_sent:"驗證郵件已發送到你的註冊郵箱{0}, 請查收",email_verification_not_sent:"未能成功發送驗證郵件, 請重試",image_selection_requirement:"請選擇不多於3張圖片輔助活動說明, 每張圖片應不超過2MB(2048KB), 如需編輯或壓縮圖片可以使用<a target='_blank' href='http://www.pixlr.com'>Pixlr</a>",activity_created:"活動已創建, 你可以在個人主頁查看相關信息",activity_saved:"更新已保存",activity_not_saved:"保存不成功",activity_saving:"正在保存...",instructions_sent_to:"密碼重設郵件已發送至{0}, 請查收",instructions_not_sent:"郵件發送失敗， 請重試",password_reset_tips:"請輸入你的註冊電郵地址",notice:"請注意",password_reset_notice_1:"若電郵地址未在本站註冊， 你將無法收到所需郵件",password_reset_notice_2:"若電郵地址不存在， 你將無法收到所需郵件",password_reset_notice_3:"電郵地址所關聯帳號在申請密碼重設期間不會失效， 如需凍結帳號請通過<a href=\"mailto:admin@qiutongqu.com?subject='account suspension'\">admin@qiutongqu.com</a>聯繫我們",qq_welcome:"歡迎回來, <span class='highlight'>QQ</span>用戶<span class='highlight'>{0}</span>"};var HINTS={playername:"用戶名",email:"電郵地址",password:"密碼",confirm_password:"確認密碼",title:"標題",address:"地址",content:"內容",activity_title:"標題",activity_address:"活動地點",activity_content:"活動內容",captcha:"驗證碼",reply:"對@{0}說: "};var ALERTS={captcha_not_matched:"驗證碼錯誤",creation_limit_exceeded:"創建活動太頻繁囉， 請稍後片刻",applicant_num_exceeded:"報名人數已達到上限",selected_num_exceeded:"已選人數已達到上限",deadline_expired:"報名已截止",image_selection_limit_exceeded:"請選擇{0}張以內圖片",invalid_email_format:"無效的電郵地址",wrong_password:"密碼錯誤",player_not_existing:"用戶不存在",comment_requirement:"請填寫5～128個字",comment_question_not_submitted:"問題未提交",registered:"註冊成功",not_registered:"註冊不成功",not_permitted_to_view_detail:"你無權瀏覽此頁",activity_not_begun:"活動尚未開始",assessment_submitted:"評價已成功提交",assessment_not_submitted:"評價未提交",no_assessment:"Oops! 暫時沒有人給Ta留下評價喔",choose_one_image:"一次只能選擇一張圖片",please_log_in:"請先登入",image_selection_requirement:"請選擇不多於3張圖片輔助活動說明, 每張圖片應不超過2MB(2048KB)",deadline_behind_begin_time:"報名截止時間應在活動開始時間之前",please_follow_activity_field_instructions:"請根據字數要求填寫各項",not_updated:"更新不成功",email_not_authenticated:"註冊郵箱尚未完成驗證無法進行此操作， 如未收到驗證郵件請在個人主頁點擊重新發送",invalid_image_type:"圖片類型應為jpg, jpeg或png",player_not_found:"未找到用戶記錄",relogin_required:"請重新登入",participant_selection_not_submitted:"參與者選擇未提交",unknown_error:"未知錯誤"};var g_numItemsPerPage=6;var g_baseTwo=2;var g_baseTen=10;var g_rootElement=$(":root");var g_inf=(1<<53);var g_orderDescend=(-1);var g_orderAscend=(+1);var g_directionForward=(+1);var g_directionBackward=(-1);var g_modeHomepage=0;var g_modeProfile=1;var g_adminEmail="admin@qiutongqu.com";var g_idKeyboardEnter=13;var g_keyToken="token";var g_keyAccessToken="access_token";var g_keyParty="party";var g_keyPartyName="party_name";var g_keyPartyNickname="party_nickname";var g_keyId="id";var g_keyOrderKey="order_key";var g_keyRelation="relation";var g_keyBundle="bundle";var g_keyStateWithAction="state_with_action";var g_keyRet="ret";var g_keyCount="count";var g_keyData="data";var g_keyPlayer="player";var g_keyCode="code";var g_keyPlayerId="player_id";var g_keyVieweeId="viewee_id";var g_keyName="name";var g_keyEmail="email";var g_keyPassword="password";var g_keyAvatar="avatar";var g_keyPasswordResetCode="password_reset_code";var g_keyUnreadCount="unread_count";var g_keyUnassessedCount="unassessed_count";var g_keyAge="age";var g_keyGender="gender";var g_keyMood="mood";var g_keyButton="button";var g_keyActivities="activities";var g_keyActivity="activity";var g_keyActivityId="activity_id";var g_keyTitle="title";var g_keyAddress="address";var g_keyContent="content";var g_keyCreatedTime="created_time";var g_keyBeginTime="begin_time";var g_keyDeadline="application_deadline";var g_keyImages="images";var g_keyStatus="status";var g_keyHostId="host_id";var g_keyHostName="host_name";var g_keyPriority="priority";var g_keyOrderMask="order_mask";var g_keyAppliedParticipants="applied_participants";var g_keySelectedParticipants="selected_participants";var g_keyPresentParticipants="present_participants";var g_keyAbsentParticipants="absent_participants";var g_keyImageId="image_id";var g_keyUrl="url";var g_keyComment="comment";var g_keyCommentId="comment_id";var g_keyParentId="parent_id";var g_keyPredecessorId="predecessor_id";var g_keyCommentType="type";var g_keyGeneratedTime="generated_time";var g_keyComments="comments";var g_keySubComments="sub_comments";var g_keyFrom="from";var g_keyFromName="from_name";var g_keyTo="to";var g_keyToName="to_name";var g_keyNotification="notification";var g_keyNotifications="notifications";var g_keyIsRead="is_read";var g_keyTag="tag";var g_keyState="state";var g_keyCbfunc="cbfunc";var g_keyArgs="args";var g_keyParams="params";var g_keyPage="page";var g_keyPageSt="page_st";var g_keyPageEd="page_ed";var g_keyRefIndex="ref_index";var g_keyNumItems="num_items";var g_keyOrder="order";var g_keyOrientation="orientation";var g_keyDirection="direction";var g_keyCell="cell";var g_keySid="sid";var g_keyCaptcha="captcha";var g_statusCreated=0;var g_statusPending=1;var g_statusRejected=2;var g_statusAccepted=3;var g_maxApplied=500;var g_maxSelected=250;var g_emailPattern=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i;var g_passwordPattern=/^[0-9a-zA-Z_#\\!]{6,32}$/;var g_playernamePattern=/^[0-9a-zA-Z_]{6,32}$/;var g_playerAgePattern=/^.{0,16}$/;var g_playerGenderPattern=/^.{0,16}$/;var g_playerMoodPattern=/^.{0,64}$/;var g_activityTitlePattern=/^.{5,64}$/;var g_activityAddressPattern=/^.{5,128}$/;var g_activityContentPattern=/^[\s\S]{15,1024}$/;var g_commentContentPattern=/^.{5,128}$/;var g_assessmentContentPattern=/^.{0,64}$/;var g_errNotLoggedIn=1001;var g_errPlayerNotFound=1003;var g_errPswErr=1004;var g_errDuplicated=1006;var g_errActivityHasBegun=3007;var g_errActivityAppliedLimit=3008;var g_errActivitySelectedLimit=3009;var g_errActivityCreationLimit=3010;var g_errCaptcha=4001;var g_errForeignPartyRegistrationRequired=5001;var g_errTempForeignPartyRecordNotFound=5002;var g_theme="main";var g_partyQQ=1;var g_appIdQQ=101239106;var g_keyDomain="domain";var g_keyRemoteName="remote_name";var g_keyUptoken="uptoken";var g_keyFileref="fileref";var g_cdnQiniu=1;var g_srcQQLogo="http://7xljmm.dl1.z0.glb.clouddn.com/qq.png";function setCookie(c,e,d,f){if(!d){var d="/"}var a=null;if(!(!f)){var b=new Date();b.setTime(b.getTime()+(f*24*60*60*1000));a="; expires="+b.toGMTString()}else{a=""}document.cookie=c+"="+e+a+"; path="+d}function getCookie(a){if(document.cookie.length<=0){return null}var b=document.cookie.indexOf(a+"=");if(b==-1){return null}if(b-1>=0&&(document.cookie[b-1]!=" "&&document.cookie[b-1]!=";")){return null}b=b+a.length+1;end=document.cookie.indexOf(";",b);if(end==-1){end=document.cookie.length}return unescape(document.cookie.substring(b,end))}function removeCookie(a){setCookie(a,"","/",-1)}Function.prototype.method=function(a,b){this.prototype[a]=b;return this};Function.method("inherits",function(b){this.prototype=new b();var e={},c=this.prototype;this.prototype.constructor=b;this.method("uber",function a(g){if(!(g in e)){e[g]=0}var j,i,h=e[g],d=b.prototype;if(h){while(h){d=d.constructor.prototype;h-=1}j=d[g]}else{j=c[g];if(j==this[g]){j=d[g]}}e[g]+=1;i=j.apply(this,Array.prototype.slice.apply(arguments,[1]));e[g]-=1;return i});return this});Function.method("swiss",function(c){for(var b=1;b<arguments.length;b+=1){var a=arguments[b];this.prototype[a]=c.prototype[a]}return this});function callbackOnPageLoaded(c,a){if(a===null){return}var b=false;c.onload=c.onreadystatechange=function(){var d=(this.readyState===null||this.readyState=="complete");if(b||!d){return}b=true;a()}}function loadJavaScript(d,f,i){var g=d.document;if(g===null){return}var c=g.createElement("script");var b=g.createTextNode(f);c.appendChild(b);if(i!==null){var a=false;c.onload=c.onreadystatechange=function(){var j=(this.readyState===null||this.readyState=="complete");if(a||!j){return}a=true;i()}}var h=g.getElementsByTagName("head");if(h===null){return}var e=h[0];if(e===null){return}e.appendChild(c)}function loadScriptFile(g,h,e,a){var d=null;if(e=="js"){d=g.document.createElement("script");d.setAttribute("type","text/javascript");d.setAttribute("src",h)}else{if(e=="css"){d=g.document.createElement("link");d.setAttribute("rel","stylesheet");d.setAttribute("type","text/css");d.setAttribute("href",h)}else{}}if(typeof d=="undefined"){return}if(a!==null){var c=false;scriptNode.onload=scriptNode.onreadystatechange=function(){var i=(this.readyState===null||this.readyState=="complete");if(c||!i){return}c=true;a()}}var f=g.document.getElementsByTagName("head");if(f===null){return}var b=f[0];if(b===null){return}b.appendChild(d)}function validateEmail(a){var b=g_emailPattern;return b.test(a)}function validatePassword(a){var b=g_passwordPattern;return b.test(a)}function validateName(a){var b=g_playernamePattern;return b.test(a)}function validatePlayerAge(a){var b=g_playerAgePattern;return b.test(a)}function validatePlayerGender(a){var b=g_playerGenderPattern;return b.test(a)}function validatePlayerMood(b){var a=g_playerMoodPattern;return a.test(b)}function validateActivityTitle(b){var a=g_activityTitlePattern;return a.test(b)}function validateActivityAddress(a){var b=g_activityAddressPattern;return b.test(a)}function validateActivityContent(b){var a=g_activityContentPattern;return a.test(b)}function validateCommentContent(b){var a=g_commentContentPattern;return a.test(b)}function validateAssessmentContent(b){var a=g_assessmentContentPattern;return a.test(b)}function extractTagAndParams(c){var f=/https?:\/\/(.+)#(default|profile|detail|home|search|notifications|success|failure)\??(.*)/i;var d=f.exec(c);if(d===null){return null}var b={};var a=d[2];b[g_keyTag]=a;b[g_keyParams]={};var g=decodeURIComponent(d[3]);var e=/([^&]+)=([^&]+)/g;var h=e.exec(g);while(h!==null){b[g_keyParams][h[1]]=h[2];h=e.exec(g)}return b}function encodeStateWithAction(b,e){var l=window.location.href;var c=extractTagAndParams(l);if(!c){return}var i=c[g_keyTag];var h=c[g_keyParams];var a={};a[g_keyTag]=i;for(var d in h){a[d]=h[d]}var g=[];for(var j in e){g.push(e[j])}var f={};f[g_keyState]=a;if(b){f[g_keyCbfunc]=b.name}if(e){f[g_keyArgs]=g}f=JSON.stringify(f);f=encodeURIComponent(f);return f}function decodeStateWithAction(a){var b=decodeURIComponent(a);b=JSON.parse(b);return b}function extractQQLoginParams(a){var f=/https?:\/\/(.+)\/callback\/qq\?#(((expires_in|access_token|state)=([^&]+)&?)+)/i;var b=f.exec(a);if(b===null){return null}var e=decodeURIComponent(b[2]);var i={};var d=/([^&]+)=([^&]+)/g;var g=d.exec(e);while(g!==null){i[g[1]]=g[2];g=d.exec(e)}var h={};h[g_keyParty]=g_partyQQ;h[g_keyAccessToken]=i[g_keyAccessToken];if(!(!i.state)){var c=decodeStateWithAction(i.state);h[g_keyStateWithAction]=c;return h}return null}function extractAnyForeignPartyLogin(b){var a=extractQQLoginParams(b);if(!(!a)){return a}return null}function firstChild(b,a){return $(b.children(a)[0])}function truncateMillisec(a){try{var c=a.split(".");if(c.length<=1){throw"oops!"}return c[0]}catch(b){return a}}function getCurrentYmdhisDate(){var b=new Date();var a=b.getFullYear().toString()+"-"+(b.getMonth()+1).toString()+"-"+b.getDate().toString();var c=b.getHours().toString()+":"+b.getMinutes().toString()+":"+b.getSeconds().toString();return a+" "+c}function compareYmdhisDate(q,o){var h=[];var b=[];var e=q.split(" ");var d=e[0].split("-");var m=e[1].split(":");for(var p in d){h.push(parseInt(d[p]))}for(var l in m){h.push(parseInt(m[l]))}var c=o.split(" ");var a=c[0].split("-");var k=c[1].split(":");for(var j in a){b.push(parseInt(a[n]))}for(var g in k){b.push(parseInt(k[n]))}for(var f=0;f<h.length;f++){if(h[f]<b[f]){return -1}if(h[f]>b[f]){return +1}}return 0}function getTarget(a){return $(a.srcElement?a.srcElement:a.target)}function isChecked(a){return(a!==null&&a.is(":checked"))}function isHidden(a){return(a!==null&&a.is(":hidden"))}function checkField(a){if(a===null){return}a.prop("checked",true)}function uncheckField(a){if(a===null){return}a.prop("checked",false)}function disableField(a){if(a===null){return}a.prop("disabled",true)}function enableField(a){if(a===null){return}a.prop("disabled",false)}function setMargin(e,d,c,b,a){if(e===null){return}if(d!==null){e.css("margin-left",d)}if(c!==null){e.css("margin-top",c)}if(b!==null){e.css("margin-right",b)}if(a!==null){e.css("margin-bottom",a)}}function setBackgroundImageDefault(b,a){if(b===null){return}setBackgroundImage(b,a,"contain","no-repeat","center")}function setBackgroundImage(e,b,c,d,a){if(e===null){return}e.css("background-image","url("+b+")");e.css("background-size",c);e.css("-o-background-size",c);e.css("-moz-background-size",c);e.css("-webkit-background-size",c);e.css("background-repeat",d);e.css("background-position",a)}function setDimensions(c,b,a){if(c===null){return}if(b!==null){c.css("width",b)}else{c.css("width","auto")}if(a!==null){c.css("height",a)}else{c.css("height","auto")}}function getDimensions(a){if(a===null){return{width:"0px",height:"0px"}}return{width:a.css("width"),height:a.css("height")}}function setOffset(c,b,a){if(c===null){return}if(b!==null){c.css("left",b)}else{c.css("left","auto")}if(a!==null){c.css("top",a)}else{c.css("top","auto")}}function getOffset(a){if(a===null){return{left:"0px",top:"0px"}}return{left:parseFloat(a.css("left")),top:parseFloat(a.css("top"))}}function stencilize(a){if(a===null){return}a.css("background-color","DimGray");a.css("color","Gainsboro")}function isFileValid(b){if(b===null){return false}var a=(1<<21);if(b.size>a){return false}return true}function validateImage(b){if(!b){return false}if(!isFileValid(b)){return false}var a=b.type;var c=a.split("/").pop().toLowerCase();if(!c){return false}if($.inArray(c,["png","jpg","jpeg"])==-1){alert(ALERTS.invalid_image_type);return false}return true}var date=new Date();moment().utcOffset(date.getTimezoneOffset());function currentMillis(){return 1000*moment().unix()}function gmtMiilisecToLocalYmdhis(a){return moment(a).format("YYYY-MM-DD HH:mm:ss")}function gmtMiilisecToLocalYmdhi(a){return moment(a).format("YYYY-MM-DD HH:mm")}function localYmdhisToGmtMillisec(a){return 1000*moment(a,"YYYY-MM-DD HH:mm:ss").unix()}function generateUuid(){function a(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function isStandardSuccess(b){if(b===null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a===0}function isStandardFailure(b){if(b===null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==1}function isCaptchaNotMatched(b){if(b===null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errCaptcha}function isTokenExpired(b){if(b===null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errNotLoggedIn}function isPlayerNotFound(b){if(b===null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errPlayerNotFound}function isPswErr(b){if(b===null){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errPswErr}function isDuplicated(b){if(!b){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errDuplicated}function isApplicantLimitExceeded(b){if(!b){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errActivityAppliedLimit}function isSelectedLimitExceeded(b){if(!b){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errActivitySelectedLimit}function isCreationLimitExceeded(b){if(!b){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errActivityCreationLimit}function isForeignPartyRegistrationRequired(b){if(!b){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errForeignPartyRegistrationRequired}function isTempForeignPartyRecordNotFound(b){if(!b){return false}if(!b.hasOwnProperty(g_keyRet)){return false}var a=parseInt(b[g_keyRet]);return a==g_errTempForeignPartyRecordNotFound}function addWarningStyle(a){a.removeClass("patch-block-sigma");a.addClass("warning")}function removeWarningStyle(a){a.removeClass("warning");a.addClass("patch-block-sigma")}function getToken(){return getCookie(g_keyToken)}function saveToken(a){setCookie(g_keyToken,a)}function clearToken(){removeCookie(g_keyToken)}function getAccessToken(){return getCookie(g_keyAccessToken)}function getParty(){return getCookie(g_keyParty)}function saveAccessTokenAndParty(b,a){setCookie(g_keyParty,a);setCookie(g_keyAccessToken,b)}function clearAccessTokenAndParty(){removeCookie(g_keyAccessToken);removeCookie(g_keyParty)}function queryCDNDomainSync(){var b=null;var c=getToken();var a=apiCDNDomain(g_cdnQiniu);var d={};d[g_keyToken]=c;$.ajax({type:"POST",url:a,data:d,async:false,success:function(f,e,g){if(isTokenExpired(f)){return null}if(isPlayerNotFound(f)){return null}if(!f.domain){return null}b=f.domain},error:function(g,e,f){return null}});return b}function apiCDNDomain(a){if(a==g_cdnQiniu){return"/image/cdn/qiniu/domain"}return null}var invalid=0;var applied=(1<<0);var selected=(1<<1);var present=(1<<2);var absent=(1<<3);var assessed=(1<<4);var hosted=(1<<5);function Player(a){this.id=parseInt(a.id);this.email=a.email;this.name=a.name;this.avatar=(a.hasOwnProperty("avatar")?a.avatar:"/assets/icons/anonymous.png");this.unreadCount=parseInt(a.unread_count);this.hasAvatar=function(){return !(!this.avatar)};this.groupId=parseInt(a.group_id);this.authenticationStatus=parseInt(a.authentication_status);this.isVisitor=function(){return(!this.groupId||this.groupId===0)};this.hasEmail=function(){return !(!this.email)};this.isEmailAuthenticated=function(){return(!(!this.authenticationStatus)&&((this.authenticationStatus&1)>0))};this.age=a.age;this.gender=a.gender;this.mood=a.mood;this.party=a.party;this.partyNickname=a.party_nickname}function Image(a){this.id=parseInt(a.id);this.url=a.url}function Activity(f){this.id=parseInt(f.id);this.title=f.title;this.address=f.address;this.content=f.content;this.createdTime=parseInt(f.created_time);this.applicationDeadline=parseInt(f.application_deadline);this.isDeadlineExpired=function(){var q=new Date();var p=1000*moment().utcOffset(q.getTimezoneOffset()).unix();return p>this.applicationDeadline};this.beginTime=parseInt(f.begin_time);this.hasBegun=function(){var q=new Date();var p=1000*moment().utcOffset(q.getTimezoneOffset()).unix();return p>this.beginTime};this.capacity=parseInt(f.capacity);this.numApplied=parseInt(f.num_applied);this.numSelected=parseInt(f.num_selected);this.status=parseInt(f.status);this.relation=null;this.containsRelation=function(){return !(!this.relation)};this.relation=parseInt(f.relation);if(f.hasOwnProperty("images")){var k=[];var i=f.images;for(var m in i){var a=i[m];var d=new Image(a);k.push(d)}this.images=k}if(!(!f.applied_participants)){var h=new Array();var c=f.applied_participants;for(var m in c){var j=c[m];var l=new Player(j);h.push(l)}this.appliedParticipants=h}if(!(!f.selected_participants)){var h=[];var c=f.selected_participants;for(var m in c){var j=c[m];var l=new Player(j);h.push(l)}this.selectedParticipants=h}if(!(!f.present_participants)){var h=[];var c=f.present_participants;for(var m in c){var j=c[m];var l=new Player(j);h.push(l)}this.presentParticipants=h}var e=f.host;var o=new Player(e);this.host=o;if(!(!f.viewer)){var b=f.viewer;var g=new Player(b);this.viewer=g}if(!(!f.priority)){this.priority=parseInt(f.priority)}if(!(!f.order_mask)){this.orderMask=parseInt(f.order_mask)}}function Comment(a){this.id=parseInt(a.id);this.content=a.content;this.activityId=parseInt(a.activity_id);if(!(!a.parent_id)){this.parentId=parseInt(a.parent_id)}if(!(!a.predecessor_id)){this.predecessorId=parseInt(a.predecessor_id)}if(!(!a.generated_time)){this.generatedTime=parseInt(a.generated_time)}if(!(!a.num_children)){this.numChildren=parseInt(a.num_children)}if(!(!a.from)){this.from=parseInt(a.from)}if(!(!a.from_player)){this.fromPlayer=new Player(a.from_player)}if(!(!a.to)){this.to=parseInt(a.to)}if(!(!a.to_player)){this.toPlayer=new Player(a.to_player)}}function Assessment(a){this.content=a.content;this.activityId=parseInt(a.activity_id);this.from=parseInt(a.from);this.to=parseInt(a.to);this.fromPlayer=new Player(a.from_player);this.toPlayer=new Player(a.to_player)}function Notification(a){this.id=parseInt(a.id);this.isRead=parseInt(a.is_read);this.from=parseInt(a.from);this.to=parseInt(a.to);this.content=a.content;this.activityId=parseInt(a.activity_id);this.commentId=parseInt(a.comment_id);this.assessmentId=parseInt(a.assessment_id);this.cmd=parseInt(a.cmd);this.relation=parseInt(a.relation);this.status=parseInt(a.status);this.generatedTime=parseInt(a.generated_time)}function BaseWidget(){this.refresh=function(a){if(!this.content){return}this.content.empty();this.composeContent(a)};this.appendTo=function(a){this.content=$("<div>").appendTo(a)};this.show=function(){this.content.show()};this.hide=function(){this.content.hide()};this.remove=function(){this.content.remove()}}function BaseModalWidget(){}BaseModalWidget.inherits(BaseWidget);BaseModalWidget.method("appendTo",function(b,a,c){this.container=$("<div class='modal fade' data-keyboard='false' tabindex='-1' role='dialog' aria-labelledby='create' aria-hidden='true'>").appendTo(b);if(!(!c)){this.container.addClass(c)}if(!(!a)){this.container.attr("data-backdrop","static")}this.dialog=$("<div class='modal-dialog modal-lg'>").appendTo(this.container);this.content=$("<div class='modal-content'>").appendTo(this.dialog)});BaseModalWidget.method("show",function(){this.container.modal("show")});BaseModalWidget.method("hide",function(){this.container.modal("hide")});BaseModalWidget.method("remove",function(){this.container.remove()});var SLOT_IDLE=0;var SLOT_UPLOADING=1;var SLOT_UPLOAD_FAILED=2;var SLOT_AJAX_PENDING=3;var SLOT_UPLOADED=4;function ImageNode(){this.state=SLOT_IDLE;this.uploader=null;this.wrap=null;this.preview=null;this.editor=null;this.btnChoose=null;this.setCDNCredentials=function(a,e,d,c){this.cdn=a;this.bucketDomain=e;var b=currentMillis();this.remoteName="{0}_{1}".format(c.id,b);var f=[g_keyToken+"="+d,g_keyDomain+"="+this.bucketDomain,g_keyRemoteName+"="+this.remoteName];this.uptokenUrl="/image/cdn/qiniu/uptoken?"+f.join("&")}}ImageNode.inherits(BaseWidget);function AjaxButton(f,b,a,c,g,e,d){this.text=f;this.url=b;this.clickData=a;this.type=c;this.extraParams=g;this.onSuccess=e;this.onError=d;this.composeContent=function(h){this.button=$("<button>",{text:this.text}).appendTo(this.content).click(h,function(k){k.preventDefault();var m=k.data.clickData;var o=k.data.url;var j=k.data.type;var p=k.data.extraParams;var i=k.data.onSuccess;var q=k.data.onError;var l=getTarget(k);disableField(l);$.ajax({url:o,type:j,data:p,success:function(s,r,t){enableField(l);if(!i){return}i(s)},error:function(t,r,s){enableField(l);if(!q){return}q(s)}})})}}AjaxButton.inherits(BaseWidget);function DatetimePicker(a){this.input=a;this.getDatetime=function(){var b=this.input.val();if(!b||b===""||b.length===0){return null}return b+":00"}}function generateDatePicker(g,c,h){var b=$("<div>",{"class":"col-sm-6"}).appendTo(g);var a=$("<div>",{"class":"form-group"}).appendTo(b);var d=$("<div>",{"class":"input-group date"}).appendTo(a);var i=$("<input type='text' class='form-control right' style='cursor: default;' readonly>").appendTo(d).val(c);var f=$("<span>",{"class":"input-group-addon"}).appendTo(d);var e=$("<span>",{"class":"glyphicon glyphicon-calendar"}).appendTo(f);d.datetimepicker({format:"YYYY-MM-DD HH:mm",ignoreReadonly:true,sideBySide:true});d.on("dp.change",h);return new DatetimePicker(i)}function PagerFilter(b,a){this.key=b;this.selector=a}function PagerCache(a){this.size=a;this.map={};this.first=1;this.last=1;this.prependPage=function(c){var b=Object.keys(this.map).length;if(this.map.hasOwnProperty(this.last)&&b==this.size){delete this.map[this.last];--this.last}this.map[--this.first]=c};this.appendPage=function(c){var b=Object.keys(this.map).length;if(this.map.hasOwnProperty(this.first)&&b==this.size){delete this.map[this.first];++this.first}this.map[++this.last]=c};this.putPage=function(c,b){if(c>this.last){this.appendPage(b)}else{if(c<this.first){this.prependPage(b)}else{this.map[c]=b}}}}function PagerButton(a,b){this.pager=a;this.page=b}function Pager(h,a,b,g,f,e,d,c){this.init=function(q,i,j,p,o,m,l,k){this.nItems=q;this.page=1;this.total=0;this.st=-g_inf;this.ed=g_inf;this.url=i;this.paramsGenerator=j;this.extraParams=p;this.onSuccess=l;this.onError=k;this.cache=new PagerCache(o);this.filterMap=m};this.refreshFilters=function(){this.filterList=[];if(!this.filterMap){return}for(var u in this.filterMap){var q=this.filterMap[u];var r=q[0];var m=q[1];var o=$("<select>").appendTo(this.filterBar);var l=r.length;for(var p=0;p<l;++p){var s=r[p];var t=m[p];$("<option>",{text:s,value:t}).appendTo(o)}var j=function(w){var v=w.data;var x=v.paramsGenerator(v,1);if(!x){return}var i=k.selector;disableField(i);$.ajax({type:"GET",url:v.url,data:x,success:function(A,y,B){var z=v.cache.size;v.cache=new PagerCache(z);enableField(i);v.onSuccess(A)},error:function(A,y,z){enableField(i);v.onError(z)}})};o.change(this,j);var k=new PagerFilter(u,o);this.filterList.push(k)}};this.createFilters=function(){this.filterBar=$("<div>").appendTo(this.content);this.refreshFilters()};this.refreshBar=function(){var j=this;var m=j.page;var r=j.cache;j.bar.empty();var i=Object.keys(r.map).length;if(i<=1){return}var o=function(t){if(!j.url){return}var s=getTarget(t);var u=t.data;j.page=u.page;var v=j.paramsGenerator(j,u.page);if(!v){return}disableField(s);$.ajax({type:"GET",url:j.url,data:v,success:function(x,w,y){enableField(s);j.onSuccess(x)},error:function(y,w,x){enableField(s);j.onError(x)}})};for(var q in r.map){var l=parseInt(q);var p=$("<button>",{text:l,"class":"plain-button pager-button"}).appendTo(j.bar);var k=new PagerButton(j,l);p.click(k,o);if(l!=m){continue}p.off("mouseenter mouseleave");p.addClass("active-button")}};this.createBar=function(){this.bar=$("<div>").appendTo(this.content);this.refreshBar()};this.refreshScreen=function(i){this.screen.empty();this.updateScreen(i);this.refreshBar()};this.createScreen=function(i){this.screen=$("<div>").appendTo(this.content);this.refreshScreen(i)};this.composeContent=function(i){if(!this.filterBar){this.createFilters()}if(!this.bar){this.createBar()}if(!this.screen){this.createScreen(i)}};this.goToPage=function(j){var i=this;i.page=j;var k=i.paramsGenerator(i,j);if(!k){return}$.ajax({type:"GET",url:i.url,data:k,success:function(m,l,o){i.onSuccess(m)},error:function(o,l,m){i.onError(m)}})}}Pager.inherits(BaseWidget);function Announcement(){this.composeContent=function(b){var a=b;var c=$("<div>",{"class":"general-popup-paragraph",text:a}).appendTo(this.content)}}Announcement.inherits(BaseModalWidget);function createBinarySwitch(e,c,d,i,f,b,k){var a=$("<div class='onoffswitch'>").appendTo(e);var h=$("<input type='checkbox' class='onoffswitch-checkbox' id='"+k+"'>").appendTo(a);var g=$("<label class='onoffswitch-label' for='"+k+"'>").appendTo(a);var l=$("<span class='onoffswitch-inner'>").appendTo(g);var j=$("<span class='onoffswitch-switch'>").appendTo(g);l.attr("left-text",f);l.attr("right-text",b);if(c){disableBinarySwitch(a);l.attr("right-text",i);j.hide()}else{j.show()}setBinarySwitch(a,d);return a}function setBinarySwitch(a,c){var b=firstChild(a,"input.onoffswitch-checkbox");b.prop("checked",c)}function setBinarySwitchOnClick(a,c){var b=firstChild(a,"input.onoffswitch-checkbox");if(b.is(":disabled")){return}a.off("click").on("click",c)}function getBinarySwitchState(a){var b=firstChild(a,"input.onoffswitch-checkbox");return b.is(":checked")}function disableBinarySwitch(a){a.off("click");var b=firstChild(a,"input.onoffswitch-checkbox");b.prop("checked",false);disableField(b)}function DropdownMenu(a,b,c){this.toggle=a;this.items=b;this.reactions=c;this.setReactionParams=function(f){this.reactionParams=f;var e=f.length;for(var d=0;d<e;d++){this.items[d].click(f[d],c[d])}}}function createDropdownMenu(k,b,d,p,l,h){var c=l.length;var a=$("<div>",{"class":"menu-actions"}).appendTo(k);var g=null;var j=$("<ul>").appendTo(a);var o=[];for(var f=0;f<l.length;f++){var m=$("<li class='glyphicon glyphicon-"+p[f]+"'>").appendTo(j);var e=$("<a class='patch-block-gamma' tabindex='-1' href='#' title='"+l[f]+"'>").appendTo(m);e.text(l[f]);o.push(m)}return new DropdownMenu(g,o,h)}function NavTab(a){this.panes=a}function createNavTab(h,m,k,q,r,d){var g=$("<ul class='nav nav-pills' role='tablist'>").appendTo(h);var b=m.length;for(var f=0;f<b;f++){var p=null;if(m[f]==q){p=$("<li role='presentation' class='active'>").appendTo(g)}else{p=$("<li role='presentation'>").appendTo(g)}var a=$("<a href='#"+m[f]+"' role='tab' data-toggle='tab'>").appendTo(p);a.text(k[f])}var l=[];for(var e=0;e<b;e++){var o=(m[e]==q);var c=createNavTabPane(r,m[e],o,d[e]);l.push(c)}return new NavTab(l)}function createNavTabPane(b,d,a,c){var e=null;if(a){e=$("<div role ='tabpanel' class='tab-pane fade in active' id='"+d+"'>").appendTo(b)}else{e=$("<div role='tabpanel' class='tab-pane' fade id='"+d+"'>").appendTo(b)}if(!c){return e}e.append(c);return e}function Captcha(a){this.sid=a;this.hasImg=function(){var b=this.img.attr("src");return(!(!b)&&b.length!==0)};this.updateImg=function(){this.img.attr("src","/captcha?"+g_keySid+"="+this.sid+"&ts="+new Date().getTime())};this.composeContent=function(c){var d=$("<div>",{"class":"captcha"}).appendTo(this.content);this.input=$("<input>",{placeHolder:HINTS.captcha}).on("focusin",this,function(e){var f=e.data;if(f.hasImg()){return}f.updateImg()}).appendTo(d);this.img=$("<img>",{src:""}).appendTo(d);var b=$("<div>",{"class":"captcha-change glyphicon glyphicon-refresh glyphicon-button"}).appendTo(d).click(this,function(e){e.preventDefault();var f=e.data;f.updateImg()})}}Captcha.inherits(BaseWidget);function WordCounter(e,b,a,c,d){this.text=e;this.min=b;this.max=a;this.regex=c;this.violationHint=d;this.update=function(f){this.text=f;this.currentText.text(f.length);if(this.valid()){this.currentText.css("color","gray");this.hintText.text("")}else{this.currentText.css("color","red");this.hintText.text(this.violationHint)}};this.appendCounter=function(f){var g=$("<p>").appendTo(f);this.currentText=$("<span>",{"class":"word-counter-current",text:this.text.length}).appendTo(g);this.maxText=$("<span>",{"class":"word-counter-max",text:"/"+this.max.toString()}).appendTo(g);this.hintText=$("<span>",{"class":"word-counter-violation-hint",text:""}).appendTo(g);this.update(this.text)};this.valid=function(){return(c.test(this.text))}}function RegexInputWidget(){}function SearchWidget(){this.collapse=function(){};this.expand=function(){}}SearchWidget.inherits(BaseWidget);function createSelector(h,f,l,a,m,d,j){if(f.length!=l.length){return}var b=f.length;var g=$("<select>").appendTo(h);for(var e=0;e<b;++e){var k=f[e];var c=l[e];$("<option>",{text:k,value:c}).appendTo(g)}return g}var g_participantsForm=null;var g_aliasApplied=0;var g_aliasSelected=1;var g_tabParticipants=null;function ParticipantsForm(d,e,a,b,c){this.activity=d;this.idList=b;this.labels=e;this.boxes=a;this.relationList=c}function appendParticipantLabels(l,a,c,q,d,f,g,j){if(!q){return}var b=q.length;var k=function(i){i.preventDefault();var t=i.data;window.location.hash=("profile?"+g_keyVieweeId+"="+t.id.toString())};for(var e=0;e<b;++e){var p=q[e];if(a==g_aliasApplied){f.push(p.id)}d.push(a);var s=$("<p>").appendTo(l);var o=$("<label>",{"class":"participant-label"}).appendTo(s);j.push(o);var h=$("<input>",{type:"checkbox","class":"participant-checkbox"}).appendTo(o);g.push(h);if(a==g_aliasSelected){h.hide()}else{if(!c){h.hide()}}var m=$("<img>",{src:p.avatar,"class":"participant-avatar"}).click(p,k).appendTo(o);var r=$("<plaintext>",{"class":"participant-label-name selected-participant title-beta",text:p.name}).appendTo(o)}}function generateParticipantsSelectionForm(k,d){var b=$("<form>",{"class":"participant-form"}).appendTo(k);var l=currentMillis();var c=(!(!g_loggedInPlayer)&&g_loggedInPlayer.id==d.host.id&&l<d.beginTime);var h=[];var g=[];var f=[];var e=[];appendParticipantLabels(b,g_aliasSelected,c,d.selectedParticipants,e,f,g,h);appendParticipantLabels(b,g_aliasApplied,c,d.appliedParticipants,e,f,g,h);var i=new ParticipantsForm(d,h,g,f,e);var j=((!d.appliedParticipants)?0:d.appliedParticipants.length);if(!c||j===0||g.length<=1){return i}var a=$("<button>",{text:TITLES.submit_participant_selection,"class":"positive-button"}).appendTo(b).click(i,function(u){u.preventDefault();var m=u.data;var v=[];for(var r=0;r<m.labels.length;r++){var s=m.boxes[r];if(isHidden(s)||!isChecked(s)){continue}var t=m.idList[r];if(t==m.activity.host.id){continue}v.push(t)}if(v.length===0){return}var o=getToken();if(!o){return}if(v.length+m.activity.numSelected>g_maxSelected){alert(ALERTS.selected_num_exceeded);return}var q={};q[g_keyToken]=o;q[g_keyActivityId]=m.activity.id;q[g_keyBundle]=JSON.stringify(v);var p=getTarget(u);disableField(p);$.ajax({type:"POST",url:"/el/activity/participants/update",data:q,success:function(A,w,B){enableField(p);if(isTokenExpired(A)){logout(null);return}if(isSelectedLimitExceeded(A)){alert(ALERTS.selected_num_exceeded);return}if(!isStandardSuccess(A)){alert(ALERTS.participant_selection_not_submitted);return}for(var y=0;y<m.labels.length;++y){var x=m.labels[y];if(m.relationList[y]==g_aliasSelected){continue}var z=m.boxes[y];if(isHidden(z)||!isChecked(z)){continue}x.removeClass("applied-participant");x.addClass("selected-participant title-beta");z.hide();m.relationList[y]=g_aliasSelected}},error:function(y,w,x){enableField(p)}})});$("<hr>").appendTo(b);return i}var g_commentId=null;var g_pagerSubComments=null;function SubCommentPager(h,a,b,g,f,e,d,c){this.init(h,a,b,g,f,e,d,c);this.updateScreen=function(k){if(!k){return}var m=k[g_keySubComments];var j=Object.keys(m).length;var i=parseInt(k[g_keyPageSt]);var q=parseInt(k[g_keyPageEd]);var p=i;var o=[];for(var r=1;r<=j;++r){var s=m[r-1];var l=new Comment(s);o.push(l);if(p==this.page){generateSubCommentCell(this.screen,s,g_activity)}if(r%this.nItems!==0){continue}this.cache.putPage(p,o);o=[];++p}if(!(!o)&&o.length>0){this.cache.putPage(p,o)}}}SubCommentPager.inherits(Pager);SubCommentPager.method("appendTo",function(b){var a=this;this.content=$("<div>").appendTo(b);this.btnBack=$("<button>",{text:"< "+TITLES.back,"class":"back-button patch-block-lambda"}).appendTo(this.content).click(function(c){c.preventDefault();a.hide();g_commentId=null;g_pagerComments.show()})});function listSubCommentsAndRefresh(b){var a=1;listSubComments(a,b,onListSubCommentsSuccess,onListSubCommentsError)}function listSubComments(b,e,d,a){g_commentId=e;var c=generateCommentsListParams(g_pagerSubComments,b);$.ajax({type:"GET",url:"/comment/sub/list",data:c,success:function(g,f,h){d(g)},error:function(h,f,g){a(g)}})}function onListSubCommentsSuccess(a){if(!g_activity){return}g_pagerSubComments.refreshScreen(a)}function onListSubCommentsError(a){}var g_comment=null;var g_activityId=null;var g_activity=null;var g_replyEditor=null;var g_onCommentSubmitSuccess=null;var g_pagerComments=null;function CommentPager(h,a,b,g,f,e,d,c){this.init(h,a,b,g,f,e,d,c);this.updateScreen=function(k){if(!k){return}var s=k[g_keyComments];var j=Object.keys(s).length;var i=parseInt(k[g_keyPageSt]);var p=parseInt(k[g_keyPageEd]);var o=i;var m=[];for(var q=1;q<=j;++q){var r=s[q-1];var l=new Comment(r);m.push(l);if(o==this.page){generateCommentCell(this.screen,r,g_activity,false)}if(q%this.nItems!==0){continue}this.cache.putPage(o,m);m=[];++o}if(!(!m)&&m.length>0){this.cache.putPage(o,m)}}}CommentPager.inherits(Pager);function CommentReplyEditor(a,b,c){this.input=a;this.submit=b;this.collapse=c;this.focus=function(){this.input.focus()};this.remove=function(){this.input.parent().remove()}}function listCommentsAndRefresh(b){var a=1;listComments(a,onListCommentsSuccess,onListCommentsError)}function listComments(b,d,a){var c=generateCommentsListParams(g_pagerComments,b);$.ajax({type:"GET",url:"/comment/list",data:c,success:function(f,e,g){d(f)},error:function(g,e,f){a(f)}})}function generateCommentsListParams(a,d){var f={};if(!(!g_commentId)){f[g_keyParentId]=g_commentId}if(!(!g_activity)){f[g_keyActivityId]=g_activity.id}var c=d-2;var b=d+2;var e=(c<1?(c-1):0);c-=e;b-=e;f[g_keyPageSt]=c;f[g_keyPageEd]=b;f[g_keyNumItems]=a.nItems;f[g_keyOrientation]=g_orderDescend;return f}function onListCommentsSuccess(a){if(!g_activity){return}g_pagerComments.refreshScreen(a)}function onListCommentsError(a){}function removeReplyEditor(){if(!g_replyEditor){return}g_replyEditor.remove();g_replyEditor=null}function generateReplyEditor(d,f,g){var b=$("<p>").appendTo(d);var a=$("<input>",{placeholder:HINTS.reply.format(g.fromPlayer.name)}).appendTo(b);var e=$("<button>",{text:TITLES.submit_comment_reply,"class":"comment-submit positive-button"}).appendTo(b);e.click(a,function(i){i.preventDefault();var h=i.data;var l=i.data.val();var k=getToken();if(!l||!validateCommentContent(l)){alert(ALERTS.comment_requirement);return}var o=g.parentId==(-1)?g.id:g.parentId;var m={};m[g_keyContent]=l;m[g_keyParentId]=o;m[g_keyPredecessorId]=g.id;m[g_keyActivityId]=f.id;m[g_keyToken]=k;m[g_keyTo]=g.from;var j=getTarget(i);disableField(j);disableField(h);$.ajax({type:"POST",url:"/el/comment/sub/submit",data:m,success:function(q,p,r){enableField(j);enableField(h);if(isTokenExpired(q)){logout(null);return}removeReplyEditor();if(!g_onCommentSubmitSuccess){return}g_onCommentSubmitSuccess()},error:function(r,p,q){enableField(j);enableField(h);alert(MESSAGES.comment_reply_not_submitted)}})});var c=$("<button>",{text:TITLES.collapse,"class":"negative-button"}).appendTo(b);c.click(function(h){h.preventDefault();removeReplyEditor()});return new CommentReplyEditor(a,e,c)}function generateCommentCell(j,a,c,o){var b=new Comment(a);var q=$("<div>",{"class":"comment-group"}).appendTo(j);var g=$("<div>",{"class":"comment-row clearfix"}).appendTo(q);if(o){g.addClass("single-row")}var l=$("<div>",{text:b.content,"class":"comment-content left"}).appendTo(g);var p=$("<div>",{"class":"comment-from left"}).appendTo(g);var f=$("<a>",{"class":"patch-block-lambda",href:"#",text:b.fromPlayer.name,target:"_blank"}).appendTo(p);f.click(function(u){u.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+b.from.toString())});var r=$("<div>",{text:gmtMiilisecToLocalYmdhis(b.generatedTime),"class":"comment-time left"}).appendTo(g);if(!o&&b.numChildren>3){var k=$("<div>",{"class":"comment-view left patch-block-lambda"}).appendTo(g);var d=$("<a>",{text:TITLES.view_all_replies.format(b.numChildren)}).appendTo(k).click(b.id,function(u){u.preventDefault();g_pagerComments.hide();g_pagerSubComments.show();var v=u.data;listSubCommentsAndRefresh(v)})}if(!o){var i=a[g_keySubComments];for(var s in i){var t=i[s];generateSubCommentCell(q,t,c)}}var h=getToken();if(!h||c.hasBegun()){return}var m=$("<div>",{"class":"comment-action left"}).appendTo(g);var e=$("<button>",{text:TITLES.reply,"class":"comment-reply positive-button"}).appendTo(m);e.click(q,function(v){v.preventDefault();var u=v.data;removeReplyEditor();g_replyEditor=generateReplyEditor(u,c,b);g_replyEditor.focus()})}function generateSubCommentCell(j,m,d){var g=new Comment(m);var i=$("<div>",{"class":"comment-group subgroup"}).appendTo(j);var p=$("<div>",{"class":"comment-row clearfix"}).appendTo(i);var c=$("<div>",{"class":"comment-to left"}).appendTo(p);var l=$("<a>",{"class":"patch-block-lambda",href:"#",text:TITLES.replied_to.format(g.toPlayer.name),target:"_blank"}).appendTo(c);l.click(function(q){q.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+g.to.toString())});var h=$("<div>",{text:g.content,"class":"comment-content left"}).appendTo(p);var k=$("<div>",{"class":"comment-from left"}).appendTo(p);var b=$("<a>",{"class":"patch-block-lambda",href:"#",text:g.fromPlayer.name,target:"_blank"}).appendTo(k);b.click(function(q){q.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+g.from.toString())});var f=$("<div>",{text:gmtMiilisecToLocalYmdhis(g.generatedTime),"class":"comment-time left"}).appendTo(p);var e=getToken();if(!e||d.hasBegun()){return i}var a=$("<div>",{"class":"comment-action left"}).appendTo(p);var o=$("<button>",{text:TITLES.reply,"class":"comment-reply positive-button"}).appendTo(a);o.click(i,function(r){r.preventDefault();var q=r.data;removeReplyEditor();g_replyEditor=generateReplyEditor(q,d,g);g_replyEditor.focus()})}function generateCommentEditor(d,f){var c=$("<div>",{"class":"activity-comment"}).appendTo(d);var a=$("<input>",{}).appendTo(c);var e=$("<button>",{text:TITLES.submit_comment_question,"class":"positive-button"}).appendTo(c);var b=new WordCounter("",5,128,g_commentContentPattern,ALERTS.comment_requirement);b.appendCounter(c);a.on("input paste keyup",b,function(g){g.data.update($(this).val())});e.click({counter:b,input:a},function(h){h.preventDefault();var l=a.val();var j=getToken();if(!l||!validateCommentContent(l)){return}var m={};m[g_keyContent]=l;m[g_keyActivityId]=f.id;m[g_keyToken]=j;var k=h.data.counter;var g=h.data.input;var i=$(h.srcElement?h.srcElement:h.target);disableField(i);disableField(g);$.ajax({type:"POST",url:"/el/comment/submit",data:m,success:function(p,o,q){enableField(i);enableField(g);if(isTokenExpired(p)){logout(null);return}g.val("");k.update("");listCommentsAndRefresh(f,null,null)},error:function(q,o,p){enableField(i);enableField(g);alert(ALERTS.comment_question_not_submitted)}})})}var g_batchAssessmentEditor=null;var g_tabAssessments=null;var g_updatingAttendance=false;var g_onRefresh=null;var g_lockedCount=0;var g_btnSubmit=null;var g_sectionAssessmentEditors=null;var g_sectionAssessmentButtons=null;function createAssessment(b,c){var a={};a.content=b;a.to=c;return new Assessment(a)}function SingleAssessmentEditor(){this.participantId=0;this.name="";this.content="";this.lock=null}function BatchAssessmentEditor(){this.switchAttendance=null;this.selectAll=null;this.editors=null}function generateAssessmentEditor(f,a,g,c){var b=new SingleAssessmentEditor();var h=$("<div>",{"class":"assessment-input-row"}).appendTo(f);var e=$("<img>",{src:a.avatar,"class":"assessment-avatar"}).click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+a.id.toString())}).appendTo(h);var d=$("<a>",{href:"#",text:a.name}).appendTo(h);d.click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+a.id.toString())});b.participantId=a.id;b.name=a.name;if(g.containsRelation()&&((g.relation&assessed)===0)){generateUnassessedView(h,b,c)}else{generateAssessedView(h,a,g)}if(!(!g_loggedInPlayer)&&g_loggedInPlayer.id==a.id){h.hide()}return b}function generateAssessmentEditors(e,g,a){e.empty();var b=g.selectedParticipants;var f=[];for(var c=0;c<b.length;c++){var d=generateAssessmentEditor(e,b[c],g,a);f.push(d)}return f}function generateAssessmentButtons(c,e,a){c.empty();if(!a.editors||a.editors.length<=1){return}var f=$("<div>",{"class":"assessment-button"}).appendTo(c);var d=$("<button>",{text:TITLES.check_all,"class":"gray assessment-button"}).appendTo(f);d.click(a,function(g){g.preventDefault();for(var h=0;h<g.data.editors.length;h++){var j=g.data.editors[h];j.lock.prop("checked",true).change()}});var b=$("<button>",{text:TITLES.uncheck_all,"class":"gray assessment-button"}).appendTo(f).click(a,function(g){g.preventDefault();for(var h=0;h<g.data.editors.length;h++){var j=g.data.editors[h];j.lock.prop("checked",false).change()}});g_btnSubmit=$("<button>",{text:TITLES.submit,"class":"assessment-button positive-button"}).appendTo(f).click({editor:a,activity:e},function(r){r.preventDefault();if(!g_loggedInPlayer){return}var t=r.data.editor;var q=r.data.activity;var s=[];for(var l=0;l<t.editors.length;l++){var m=t.editors[l];var o=m.content;var p=m.participantId;if(p==g_loggedInPlayer.id){continue}var g=createAssessment(o,p);s.push(g)}if(s.length===0){return}var k={};var h=getToken();k[g_keyToken]=h;k[g_keyActivityId]=q.id;k[g_keyBundle]=JSON.stringify(s);var j=$(this);disableField(j);$.ajax({type:"POST",url:"/assessment/submit",data:k,success:function(u,i,v){enableField(j);if(isTokenExpired(u)){logout(null);return}alert(ALERTS.assessment_submitted);q.relation|=assessed;refreshBatchEditor(q)},error:function(v,i,u){enableField(j);alert(ALERTS.assessment_not_submitted)}})}).appendTo(f);disableField(g_btnSubmit)}function generateBatchAssessmentEditor(h,a,f){h.empty();if(!g_onRefresh){g_onRefresh=f}g_lockedCount=0;g_batchAssessmentEditor=new BatchAssessmentEditor();if(!a){return g_batchAssessmentEditor}var g=[];var k=$("<div>",{"class":"assessment-container"}).appendTo(h);var d=false;var b=false;if(!(!g_loggedInPlayer)&&a.host.id==g_loggedInPlayer.id){d=true;b=true}else{if((a.relation&present)>0){d=true}else{if((a.relation&selected)>0||(a.relation&absent)>0){d=false}else{b=true}}}var j=createBinarySwitch(k,b,d,TITLES.assessment_disabled,TITLES.present,TITLES.absent,"switch-attendance");g_sectionAssessmentEditors=$("<div>",{style:"margin-top: 5pt"}).appendTo(k);g_sectionAssessmentButtons=$("<div>",{style:"margin-top: 5pt"}).appendTo(k);if(!(!g_loggedInPlayer)&&(((a.relation&present)>0)||(!a.containsRelation()))){refreshBatchEditor(a)}var e=function(o){g_updatingAttendance=false;var l=o;a.relation=parseInt(l[g_keyRelation]);g_sectionAssessmentEditors.empty();g_sectionAssessmentButtons.empty();var m=getBinarySwitchState(j);if(!m){return}refreshBatchEditor(a)};var c=function(l){g_updatingAttendance=false;var o=getBinarySwitchState(j);var m=!o;setBinarySwitch(j,m)};var i=function(l){l.preventDefault();if(a.relation==invalid){return}if(!a.hasBegun()){alert(ALERTS.activity_not_begun);return}var o=getBinarySwitchState(j);var m=!o;setBinarySwitch(j,m);attendance=a.relation;if(m){attendance=present}else{attendance=absent}updateAttendance(a.id,attendance,e,c)};setBinarySwitchOnClick(j,i);return g_batchAssessmentEditor}function updateAttendance(a,f,e,c){if(g_updatingAttendance){return}var b=getToken();if(!b){return}var d={};d[g_keyRelation]=f;d[g_keyToken]=b;d[g_keyActivityId]=a;g_updatingAttendance=true;$.ajax({type:"PUT",url:"/activity/mark",data:d,success:function(h,g,i){if(isTokenExpired(h)){logout(null);return}e(h)},error:function(i,g,h){c(h)}})}function generateAssessedView(d,a,c){var b=$("<span>",{text:TITLES.view_assessment,style:"display: inline; color: blue; margin-left: 5pt; cursor: pointer"}).appendTo(d);b.click(function(e){e.preventDefault();queryAssessmentsAndRefresh(a.id,c.id)})}function generateUnassessedView(e,a,b){var c=$("<input>",{type:"checkbox","class":"left"}).appendTo(e);var d=$("<input>",{type:"text"}).appendTo(e);d.on("input paste keyup",a,function(f){f.data.content=$(this).val()});c.change({input:d,editor:b},function(g){var f=g.data.input;var i=g.data.editor;g.preventDefault();var h=isChecked($(this));if(!h){enableField(f);--g_lockedCount;if(!(!g_btnSubmit)){disableField(g_btnSubmit)}}else{disableField(f);++g_lockedCount;if(g_lockedCount>=(i.editors.length-1)&&!(!g_btnSubmit)){enableField(g_btnSubmit)}}});a.lock=c}function refreshBatchEditor(b){if(!b.hasBegun()){return}if(!g_batchAssessmentEditor||!g_sectionAssessmentEditors||!g_sectionAssessmentButtons){return}var a=generateAssessmentEditors(g_sectionAssessmentEditors,b,g_batchAssessmentEditor);g_batchAssessmentEditor.editors=a;g_sectionAssessmentButtons.empty();if(!b.containsRelation()||(b.containsRelation()&&(b.relation&assessed)>0)||g_batchAssessmentEditor.editors.length<=1){return}generateAssessmentButtons(g_sectionAssessmentButtons,b,g_batchAssessmentEditor)}var g_pagerAssessments=null;var g_assessmentModalWidget=null;function AssessmentModalWidget(){this.composeContent=function(e){if(e==null||Object.keys(e).length==0){alert(ALERTS.no_assessment);return}var m=[];for(var l in e){var g=e[l];var a=new Assessment(g);m.push(a)}var j=$("<div>",{style:"padding: 10%"}).appendTo(par);var d=$("<table class='assessments-viewer'>").appendTo(j);var k=$("<tr class='assessments-viewer-row'>").appendTo(d);$("<th>",{text:TITLES.content,"class":"assessments-viewer-header-content"}).appendTo(k);$("<th>",{text:TITLES.from,"class":"assessments-viewer-header-from"}).appendTo(k);for(var c=0;c<m.length;c++){var a=m[c];var o=$("<tr class='assessments-viewer-row'>").appendTo(d);$("<td>",{text:a.content}).appendTo(o);var b=$("<td>").appendTo(o);var f=$("<img>",{src:a.fromPlayer.avatar,"class":"assessments-viewer-avatar"}).appendTo(b);var h=$("<span>",{text:a.fromPlayer.name,"class":"assessments-viewer-name"}).appendTo(b)}}}AssessmentModalWidget.inherits(BaseModalWidget);function initAssessmentModalWidget(a){g_assessmentModalWidget=new AssessmentModalWidget();g_assessmentModalWidget.appendTo(a,false)}function onQueryAssessmentsSuccess(a){g_assessmentModalWidget.refresh(a);g_assessmentModalWidget.show()}function onQueryAssessmentsError(a){}function queryAssessments(e,c,d,g,a){var b=getToken();if(b==null){focusLogin();return}var f={};if(e!=null){f[g_keyRefIndex]=e}if(c!=null){f[g_keyNumItems]=c}if(d!=null){f[g_keyDirection]=parseInt(d)}f[g_keyToken]=b;f[g_keyTo]=g;f[g_keyActivityId]=a;$.ajax({type:"GET",url:"/assessment/query",data:f,success:function(i,h,j){onQueryAssessmentsSuccess(i)},error:function(j,h,i){onQueryAssessmentsError(i)}})}function queryAssessmentsAndRefresh(b,a){queryAssessments(0,20,g_directionForward,b,a)}function AssessmentPager(h,a,b,g,f,e,d,c){this.init(h,a,b,g,f,e,d,c);this.updateScreen=function(l){if(!l||Object.keys(l).length===0){return}for(var k in l){var j=l[k];var i=new Assessment(j);generateAssessmentTag(this.screen,i)}}}AssessmentPager.inherits(Pager);function generateAssessmentTag(b,a){$("<span>",{text:a.content,"class":"assessment-tag"}).click(a,function(c){c.preventDefault();var d=c.data;window.location.hash=("detail?"+g_keyActivityId+"="+d.activityId)}).appendTo(b)}function onListAssessmentsSuccess(a){g_pagerAssessments.refreshScreen(a)}function onListAssessmentsError(a){}function generateAssessmentsListParams(c,h){if(h==null){return null}var d=getToken();if(d==null){focusLogin();return}var e={};e[g_keyToken]=d;var a=h-2;var j=h+2;var f=a<1?(a-1):0;a-=f;j-=f;e[g_keyPageSt]=a;e[g_keyPageEd]=j;if(c.nItems!=null){e[g_keyNumItems]=c.nItems}if(g_activityId!=null){e[g_keyActivityId]=g_activityId}if(c.filters!=null){for(var g=0;g<c.filters.length;++g){var b=c.filters[g];e[b.key]=b.selector.val()}}if(c.extraParams==null){return e}for(var k in c.extraParams){e[k]=c.extraParams[k]}return e}function listAssessments(b,d,a){var c=generateAssessmentsListParams(g_pagerAssessments,b);$.ajax({type:"GET",url:"/assessment/list",data:c,success:function(f,e,g){if(isTokenExpired(f)){logout(null);return}d(f)},error:function(g,e,f){a(f)}})}function listAssessmentsAndRefresh(){var a=1;listAssessments(a,onListAssessmentsSuccess,onListAssessmentsError)}var g_pagerNotifications=null;function NotificationPager(h,a,b,g,f,e,d,c){this.init(h,a,b,g,f,e,d,c);this.updateScreen=function(m){if(!m){return}var r=m[g_keyNotifications];var j=Object.keys(r).length;var i=parseInt(m[g_keyPageSt]);var q=parseInt(m[g_keyPageEd]);var p=i;var l=$("<table class='notifications-viewer'>").appendTo(this.screen);var t=[];var v=[];for(var s=1;s<=j;++s){var o=r[s-1];var k=new Notification(o);t.push(k);if(p==this.page){var u=generateNotificationCell(l,k);v.push(u)}if(s%this.nItems!==0){continue}this.cache.putPage(p,t);t=[];++p}g_notificationTrash.updateCells(v);if(!(!t)&&t.length>0){this.cache.putPage(p,t)}}}NotificationPager.inherits(Pager);var g_notificationTrash=null;function clearNotifications(){var a=$("#toolbar");a.empty();setDimensions(a,"100%",0);$("#pager-notifications").empty()}function countNotifications(){var a=getToken();if(!a){return}var b={};b[g_keyToken]=a;$.ajax({type:"GET",url:"/notification/count",data:b,success:function(e,c,f){if(!g_loggedInPlayer){return}if(isTokenExpired(e)){logout(null);return}var d=parseInt(e[g_keyCount]);g_loggedInPlayer.unreadCount=d;g_postLoginMenu.bubble.update(d)},error:function(e,c,d){}})}function NotificationTrash(a){this.toolbar=a;this.btnTrash=null;this.btnDelete=null;this.btnBack=null;this.cells=[];this.isActive=false;this.activate=function(){for(var c=0;c<this.cells.length;++c){var b=this.cells[c];b.prependCheckbox()}this.btnTrash.hide();this.btnBack.show();this.btnDelete.show();this.isActive=true};this.deactivate=function(){for(var c=0;c<this.cells.length;++c){var b=this.cells[c];b.removeCheckbox()}this.btnTrash.show();this.btnBack.hide();this.btnDelete.hide();this.isActive=false};this.updateCells=function(b){this.cells=b;if(this.isActive){this.activate()}else{this.deactivate()}};this.init=function(){setDimensions(this.toolbar,"100%","30px");this.btnTrash=$("<button>",{style:"position: absolute;"}).appendTo(this.toolbar);this.btnTrash.width("25px");this.btnTrash.height("25px");setOffset(this.btnTrash,"0px",null);setBackgroundImageDefault(this.btnTrash,"/assets/icons/trash.png");this.btnTrash.click(this,function(b){b.preventDefault();var c=b.data;if(c.isActive){return}c.activate()});this.btnBack=$("<button>",{style:"position: absolute;"}).appendTo(this.toolbar);this.btnBack.width("25px");this.btnBack.height("25px");this.btnBack.hide();setOffset(this.btnBack,"0px",null);setBackgroundImageDefault(this.btnBack,"/assets/icons/back.png");this.btnBack.click(this,function(b){b.preventDefault();var c=b.data;c.deactivate()});this.btnDelete=$("<button>",{style:"position: absolute;"}).appendTo(this.toolbar);this.btnDelete.width("25px");this.btnDelete.height("25px");this.btnDelete.hide();setOffset(this.btnDelete,"50px",null);setBackgroundImageDefault(this.btnDelete,"/assets/icons/delete.png");this.btnDelete.click(this,function(d){d.preventDefault();var f=d.data;if(f.cells.length===0){return}var c=[];for(var h=0;h<f.cells.length;++h){var b=f.cells[h];if(!b.checkbox||!isChecked(b.checkbox)){continue}c.push(b.notification.id)}var j={};var g=getToken();if(!g){return}j[g_keyToken]=g;j[g_keyBundle]=JSON.stringify(c);var e=$(d.srcElement?d.srcElement:d.target);disableField(e);$.ajax({type:"POST",data:j,url:"/notification/delete",success:function(k,i,l){enableField(e);if(isTokenExpired(k)){logout(null);return}if(!isStandardSuccess(k)){return}listNotificationsAndRefresh()},error:function(l,i,k){enableField(e);alert("Error occurs!")}})})}}function listNotificationsAndRefresh(){var a=1;listNotifications(a,onListNotificationsSuccess,onListNotificationsError)}function listNotifications(b,d,a){var c=generateNotificationsListParams(g_pagerNotifications,b);$.ajax({type:"GET",url:"/notification/list",data:c,success:function(f,e,g){if(isTokenExpired(f)){logout(null);return}d(f)},error:function(g,e,f){a(f)}})}function generateNotificationsListParams(c,h){var e={};if(!g_loggedInPlayer){return null}var d=getToken();e[g_keyToken]=d;var a=h-2;var j=h+2;var f=a<1?(a-1):0;a-=f;j-=f;e[g_keyPageSt]=a;e[g_keyPageEd]=j;e[g_keyNumItems]=c.nItems;e[g_keyOrientation]=g_orderDescend;if(!(!c.filters)){for(var g=0;g<c.filters.length;++g){var b=c.filters[g];if(!b.selector.val()||b.selector.val()===""){continue}e[b.key]=b.selector.val()}}return e}function onListNotificationsSuccess(a){g_pagerNotifications.refreshScreen(a)}function onListNotificationsError(a){}function NotificationCell(b,e,a){this.container=b;this.notification=e;this.indicator=a;this.isSelected=false;this.checkbox=null;this.prependCheckbox=function(){var f=$("<td>").prependTo(this.container);this.checkbox=$("<input>",{type:"checkbox"}).appendTo(f)};this.removeCheckbox=function(){if(!this.checkbox){return}this.checkbox.parent().remove();this.checkbox.remove();this.checkbox=null};this.container.click(this.notification,function(g){if(g_notificationTrash.isActive){return}g.preventDefault();var f=g.data;window.location.hash=("detail?"+g_keyActivityId+"="+f.activityId)});if(this.notification.isRead!==0){var c=$("<div>",{"class":"notification-read"}).appendTo(this.indicator);return}var d=$("<div>",{"class":"notification-unread"}).appendTo(this.indicator);this.container.click(this,function(g){if(g_notificationTrash.isActive){return}g.preventDefault();var i=g.data;var f=i.notification;var h=getToken();if(!h){return}var j={};j[g_keyToken]=h;j[g_keyId]=f.id;j[g_keyIsRead]=1;$.ajax({type:"POST",url:"/el/notification/mark",data:j,success:function(l,k,m){if(isTokenExpired(l)){logout(null);return}window.location.hash=("detail?"+g_keyActivityId+"="+f.activityId)},error:function(m,k,l){}})})}function generateNotificationCell(d,g){var b=$("<tr class = 'notifications-viewer-row'>",{}).appendTo(d);var c=$("<td>",{text:g.id,"class":"notification-id"}).appendTo(b);var e=$("<td>",{text:g.content,"class":"notification-content"}).appendTo(b);var f=$("<td>",{text:gmtMiilisecToLocalYmdhis(g.generatedTime),"class":"notification-time"}).appendTo(b);var a=$("<td>",{"class":"notification-envelope"}).appendTo(b);return new NotificationCell(b,g,a)}function requestNotifications(){clearHome();clearProfile();clearDetail();g_notificationTrash=new NotificationTrash($("#toolbar"));g_notificationTrash.init();var e={};e[g_keyIsRead]=[[TITLES.all,TITLES.unread,TITLES.read],["",0,1]];g_pagerNotifications=new NotificationPager(10,"/notification/list",generateNotificationsListParams,null,5,e,onListNotificationsSuccess,onListNotificationsError);g_pagerNotifications.appendTo($("#pager-notifications"));g_pagerNotifications.refresh();var b=function(f){countNotifications();listNotificationsAndRefresh()};var a=function(f){clearNotifications()};var d=function(f){clearNotifications()};var c=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,b,a,d,c);g_onActivitySaveSuccess=null;checkLoginStatus()}var g_vieweeId=null;var g_pagerActivity=null;var g_onJoined=null;function onBtnEditClicked(a){a.preventDefault();a.stopPropagation();var b=a.data;if(!g_activityEditor){return}g_activityEditor.refresh(b);g_activityEditor.show()}function listActivities(b,d,a){var c=generateActivitiesListParams(g_pagerActivity,b);$.ajax({type:"GET",url:"/activity/list",data:c,success:function(f,e,g){if(isTokenExpired(f)){logout(null);return}d(f)},error:function(g,e,f){a(f)}})}function listActivitiesAndRefresh(){var a=1;listActivities(a,onListActivitiesSuccess,onListActivitiesError)}function generateActivitiesListParams(c,h){if(!h){return null}var e={};if(!(!g_vieweeId)){e[g_keyVieweeId]=g_vieweeId}var a=h-2;var j=h+2;var f=a<1?(a-1):0;a-=f;j-=f;e[g_keyPageSt]=a;e[g_keyPageEd]=j;if(!(!c.nItems)){e[g_keyNumItems]=c.nItems}if(!(!g_vieweeId)){e[g_keyVieweeId]=g_vieweeId}if(!(!c.filterList)){for(var g=0;g<c.filterList.length;++g){var b=c.filterList[g];e[b.key]=b.selector.val()}}if(!e.hasOwnProperty(g_keyOrientation)){e[g_keyOrientation]=g_orderDescend}var d=getToken();if(!(!d)){e[g_keyToken]=d}return e}function onListActivitiesSuccess(a){g_pagerActivity.refreshScreen(a)}function onListActivitiesError(a){}function displayTimesTable(d,h){var f=$("<div>",{"class":"time-table dealine clearfix"}).appendTo(d);var b=$("<div>",{text:TITLES.deadline,"class":"time-label left label-active-alpha"}).appendTo(f);var e=$("<div>",{text:gmtMiilisecToLocalYmdhis(h.applicationDeadline),"class":"time-detail left"}).appendTo(f);if(h.isDeadlineExpired()){b.addClass("label-disabled")}var c=$("<div>",{"class":"time-table begin clearfix"}).appendTo(d);var g=$("<div>",{text:TITLES.begin_time,"class":"time-label left label-active-beta"}).appendTo(c);var a=$("<div>",{text:gmtMiilisecToLocalYmdhis(h.beginTime),"class":"time-detail left"}).appendTo(c);if(h.hasBegun()){g.addClass("label-disabled")}}function displayParticipantStatistics(b,d){var a=$("<ul>",{"class":"clearfix"}).appendTo(b);var e=$("<li>",{text:d.numSelected.toString()+" "+TITLES.selected,"class":"selected left"}).appendTo(a);var c=$("<li>",{text:(d.numApplied+d.numSelected).toString()+" "+TITLES.applied,"class":"applied left"}).appendTo(a)}function onBtnJoinClicked(a){var d=$(this);a.preventDefault();var e=a.data;if(e.isDeadlineExpired()){alert(ALERTS.deadline_expired);return}if(e.numApplied>=g_maxApplied){alert(ALERTS.applicant_num_exceeded);return}var c=getToken();var f={};f[g_keyActivityId]=e.id;f[g_keyToken]=c;var b=$(a.srcElement?a.srcElement:a.target);disableField(b);$.ajax({type:"POST",url:"/activity/join",data:f,success:function(h,g,i){enableField(b);if(isTokenExpired(h)){logout(null);return}if(isApplicantLimitExceeded(h)){alert(ALERTS.applicant_num_exceeded);return}if(!isStandardSuccess(h)){return}if(!g_onJoined){return}g_onJoined(e.id)},error:function(i,g,h){enableField(b)}})}function attachJoinButton(b,c){if(!c.relation&&!c.isDeadlineExpired()){var a=$("<button>",{"class":"btn-join right positive-button",text:TITLES.join}).appendTo(b);a.click(c,onBtnJoinClicked)}else{attachRelationIndicator(b,c,false)}}function attachRelationIndicator(c,d,b){if(!d.relation||!g_loggedInPlayer||g_loggedInPlayer.id==d.host.id){return}var a={};a[applied]=RELATION_NAMES.applied;a[selected]=RELATION_NAMES.selected;a[present]=RELATION_NAMES.present;a[absent]=RELATION_NAMES.absent;a[assessed]=RELATION_NAMES.assessed;a[hosted]=RELATION_NAMES.hosted;if(b){$("<div>",{"class":"activity-cell-relation",text:a[getPriorRelation(d)]}).appendTo(c)}else{$("<div>",{"class":"activity-detail-relation right",text:a[getPriorRelation(d)]}).appendTo(c)}}function attachStatusIndicator(c,d){if(d.status===null||d.status===undefined){return}var e=[STATUS_NAMES.created,STATUS_NAMES.pending,STATUS_NAMES.rejected,STATUS_NAMES.accepted];var b=$("<div>",{"class":"activity-cell-status",text:e[d.status]}).appendTo(c);if(d.status!=g_statusCreated&&d.status!=g_statusRejected){return}var a=$("<button>",{"class":"activity-btn-edit"}).appendTo(b).click(d,onBtnEditClicked)}function getPriorRelation(a){if((a.relation&assessed)>0){return assessed}if((a.relation&present)>0){return present}if((a.relation&absent)>0){return absent}if((a.relation&selected)>0){return selected}if((a.relation&applied)>0){return applied}}function generateActivityCell(l,d){var h=null;if(!(!d.images)){for(var r in d.images){var g=d.images[r];h=g.url;break}}var k=null;if(d.priority>0){k=$("<div>",{"class":"cell-container clearfix prioritized-cell"}).appendTo(l)}else{k=$("<div>",{"class":"cell-container clearfix non-prioritized-cell"}).appendTo(l)}k.click(d,function(t){t.preventDefault();var i=t.data;window.location.hash=("detail?"+g_keyActivityId+"="+i.id)});var s=$("<div>",{"class":"activity-cover left"}).appendTo(k);var c=$("<span>",{"class":"image-helper"}).appendTo(s);if(!(!h)){var s=$("<img>",{src:h}).appendTo(s)}var e=$("<div>",{"class":"activity-info left"}).appendTo(k);var p=$("<p>",{"class":"activity-title truncate title-alpha",text:d.title}).appendTo(e);var o=$("<p>",{"class":"activity-addr truncate title-beta",text:d.address}).appendTo(e);displayTimesTable(e,d);var m=$("<div>",{"class":"activity-attend"}).appendTo(e);displayParticipantStatistics(m,d);var a=$("<div>",{"class":"selected-snippet"}).appendTo(e);if(!(!d.selectedParticipants)){var j=d.selectedParticipants.length<=3?d.selectedParticipants.length:3;for(var f=0;f<j;++f){var q=d.selectedParticipants[f];$("<img>",{title:q.name,src:q.avatar,"class":"selected-snippet-avatar left"}).appendTo(a)}}var b=$("<div>",{"class":"activity-action left"}).appendTo(k);attachStatusIndicator(b,d);attachRelationIndicator(b,d,true)}var g_deleteConfirmation=null;var g_activityEditor=null;var g_keyOldImage="old_image";var g_keyNewImage="new_image";var g_imagesLimit=3;var g_onActivitySaveSuccess=null;var g_loadingWidget=null;function ActivityEditorImageNode(a,b){this.setCDNCredentials(a,b,getToken(),g_loggedInPlayer);this.requestDel=function(g,d){var c=getToken();if(!c){return}if(!this.remoteName){return}if(this.state!=SLOT_IDLE&&this.state!=SLOT_UPLOADED){return}var f={};f[g_keyToken]=c;var e=[];e.push(this.remoteName);f[g_keyBundle]=JSON.stringify(e);this.state=SLOT_AJAX_PENDING;$.ajax({type:"POST",url:"/image/cdn/qiniu/delete",data:f,success:function(i,h,j){this.state=SLOT_IDLE;if(!g){return}g(i)},error:function(j,h,i){this.state=SLOT_IDLE;if(!d){return}d(i)}})};this.composeContent=function(d){this.editor=d;this.editor.newImageNodes[this.remoteName]=this;this.wrap=$("<div>",{"class":"preview-container left"}).appendTo(this.content);this.preview=$("<img>").hide().appendTo(this.wrap);this.btnChoose=$("<button>",{text:TITLES.choose_picture,"class":"positive-button"}).appendTo(this.wrap);setDimensions(this.btnChoose,"100%","100%");this.btnDel=$("<button>",{text:TITLES.del,"class":"positive-button"}).hide().appendTo(this.wrap).click(this,function(e){e.preventDefault();var j=e.data.remoteName;var g=e.data.editor;if(!g.newImageNodes.hasOwnProperty(j)){return}var i=g.newImageNodes[j];var f=getTarget(e);var k=function(l){enableField(f);delete g.newImageNodes[j];i.remove();g.addNewImageNode(false,true)};var h=function(l){enableField(f)};disableField(f);i.requestDel(k,h)});setDimensions(this.btnDel,"90%","10%");if(a==g_cdnQiniu){var c=this;this.uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:c.btnChoose[0],uptoken_url:c.uptokenUrl,unique_names:false,save_key:false,domain:c.bucketDomain,container:c.preview[0],max_file_size:"2mb",max_retries:2,chunk_size:"4mb",auto_start:true,init:{FilesAdded:function(e,g){if(!g){return null}if(g.length!=1){alert(ALERTS.choose_one_image);return}var f=g[0];if(!validateImage(f)){return}c.state=SLOT_UPLOADING;c.uploader.disableBrowse();disableField(c.btnChoose);c.editor.setNonSubmittable();c.editor.setNonSavable()},BeforeUpload:function(e,f){},UploadProgress:function(e,f){},FileUploaded:function(e,f,g){},Error:function(e,g,f){c.state=SLOT_UPLOAD_FAILED},UploadComplete:function(){c.editor.setNonSubmittable();c.editor.setSavable();if(c.state==SLOT_UPLOAD_FAILED){c.uploader.disableBrowse(false);enableField(c.btnChoose);return}c.btnChoose.remove();var e=["ts="+currentMillis()];var f="http://";var g=f+c.bucketDomain+"/"+c.remoteName+"?"+e.join("&");c.preview.show();c.preview.attr("src",g);c.state=SLOT_UPLOADED;c.btnDel.show();c.editor.addNewImageNode(false,false)},Key:function(e,f){return c.remoteName}}})}}}ActivityEditorImageNode.inherits(ImageNode);function ImageSelector(c,b,a){this.id=c;this.image=b;this.indicator=a;this.checked=true}function AddressField(a,b){this.input=a;this.map=b}function ActivityEditor(){this.id=null;this.titleField=null;this.titleCounter=null;this.addressField=null;this.addressCounter=null;this.contentField=null;this.contentCounter=null;this.newImageRow=null;this.newImageNodes=null;this.imageSelectors=null;this.beginTimePicker=null;this.deadlinePicker=null;this.btnSave=null;this.btnSubmit=null;this.btnDelete=null;this.explorerTrigger=null;this.hint=null;this.captcha=null;this.addNewImageNode=function(j,e){j=(j===undefined?false:j);e=(e===undefined?false:e);if(!j&&!e){var d=queryCDNDomainSync();var c=new ActivityEditorImageNode(g_cdnQiniu,d);c.appendTo(this.newImageRow);c.refresh(this)}var b=Object.keys(this.newImageNodes).length;var a=countImages(this);var f=a-a;var h=null;for(var g in this.newImageNodes){if(!h){h=g}else{if(g>h){h=g}else{}}}var i=this.newImageNodes[h];if(a-1>=g_imagesLimit){i.uploader.disableBrowse();disableField(i.btnChoose)}else{i.uploader.disableBrowse(false);enableField(i.btnChoose)}};this.composeContent=function(d){this.id=null;var f=false;if(!d||!d.id){f=true}var l=null;var e="";var h="";var a="";if(!f){this.id=d.id;l=d.id;e=d.title;h=d.address;a=d.content}var c=$("<form>",{"class":"activity-editor-form"}).appendTo(this.content);this.titleField=$("<input>",{placeholder:HINTS.activity_title,"class":"input-title",type:"text",value:e}).appendTo(c);this.titleCounter=new WordCounter(e,1,64,g_activityTitlePattern,"");this.titleCounter.appendCounter(c);this.titleField.on("input paste keyup",this.titleCounter,function(t){g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();t.data.update($(this).val())});var b=$("<input>",{placeholder:HINTS.activity_address,"class":"input-address",type:"text",value:h}).appendTo(c);this.addressCounter=new WordCounter(h,1,256,g_activityAddressPattern,"");this.addressCounter.appendCounter(c);b.on("input paste keyup",this.addressCounter,function(t){g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();t.data.update($(this).val())});this.addressField=new AddressField(b,null);this.contentField=$("<textarea>",{placeholder:HINTS.activity_content,"class":"input-content"}).appendTo(c);this.contentField.val(a);this.contentCounter=new WordCounter(a,1,1024,g_activityContentPattern,"");this.contentCounter.appendCounter(c);this.contentField.on("input paste keyup",this.contentCounter,function(t){g_activityEditor.setSavable();g_activityEditor.setNonSubmittable();t.data.update($(this).val())});$("<div>",{"class":"warning",html:MESSAGES.image_selection_requirement}).appendTo(c);this.newImageNodes={};this.imageSelectors=[];this.newImageRow=$("<div>",{"class":"edit-image-row clear"}).appendTo(c);if(!(!d)&&!(!d.images)){generateOldImagesRow(c,this,d)}this.addNewImageNode(false,false);var q=reformatDate(new Date());if(!(!d)&&!(!d.applicationDeadline)){q=d.applicationDeadline}var k=reformatDate(new Date());if(!(!d)&&!(!d.beginTime)){k=d.beginTime}var s=$("<div>",{"class":"edit-datetime-deadline clearfix clear"}).appendTo(c);var j=$("<div>",{text:TITLES.deadline,"class":"left edit-datetime-label"}).appendTo(s);var i=$("<div>",{"class":"datetime-picker left"}).appendTo(s);this.deadlinePicker=generateDateSelection(i,gmtMiilisecToLocalYmdhi(q));var r=$("<div>",{"class":"edit-datetime-begin clearfix clear"}).appendTo(c);var p=$("<div>",{text:TITLES.begin_time,"class":"left edit-datetime-label"}).appendTo(r);var o=$("<div>",{"class":"datetime-picker left"}).appendTo(r);this.beginTimePicker=generateDateSelection(o,gmtMiilisecToLocalYmdhi(k));this.captcha=null;if(f){this.captcha=new Captcha(generateUuid());this.captcha.appendTo(c);this.captcha.refresh()}var m=$("<div>",{"class":"edit-button-rows clear"}).appendTo(c);this.btnSave=$("<button>",{"class":"btn-save positive-button",text:TITLES.save}).appendTo(m).click(onSave);this.btnSubmit=$("<button>",{"class":"btn-submit positive-button",text:TITLES.submit}).appendTo(m);var g={};g[g_keyActivityId]=l;this.btnSubmit.click(g,onSubmit);this.btnCancel=$("<button>",{"class":"btn-cancel negative-button",text:TITLES.cancel}).appendTo(m).click(onCancel);this.btnDelete=null;if(!f){this.btnDelete=$("<button>",{"class":"btn-delete caution-button",text:TITLES.del}).appendTo(m).click(function(t){t.preventDefault();if(!(!g_deleteConfirmation)){g_deleteConfirmation.remove()}g_deleteConfirmation=generateDeleteConfirmation(g_activityEditor.content,d)})}this.hint=$("<div>",{"class":"clear"}).appendTo(c);this.setNonSavable();this.setSubmittable()};this.savable=false;this.submittable=true;this.disableEditorButtons=function(){disableField(this.btnSave);this.btnSave.addClass("disabled-button");disableField(this.btnSubmit);this.btnSubmit.addClass("disabled-button");if(!this.btnDelete){return}disableField(this.btnDelete);this.btnDelete.addClass("disabled-button")};this.enableEditorButtons=function(){if(this.savable){enableField(this.btnSave);this.btnSave.removeClass("disabled-button")}if(this.submittable){enableField(this.btnSubmit);this.btnSubmit.removeClass("disabled-button")}if(!(!this.btnDelete)){enableField(this.btnDelete);this.btnDelete.removeClass("disabled-button")}};this.setNonSavable=function(){this.savable=false;disableField(this.btnSave);this.btnSave.addClass("disabled-button")};this.setSavable=function(){this.savable=true;this.enableEditorButtons()};this.setNonSubmittable=function(){this.submittable=false;disableField(this.btnSubmit);this.btnSubmit.addClass("disabled-button")};this.setSubmittable=function(){this.submittable=true;this.enableEditorButtons()}}ActivityEditor.inherits(BaseModalWidget);function initActivityEditor(a){g_activityEditor=new ActivityEditor();g_activityEditor.appendTo(a,true,"activity-editor")}function DeleteConfirmation(b,c,a,d){this.container=b;this.activity=c;this.btnYes=a;this.btnNo=d;this.btnYes.click(this.activity.id,onDelete);this.btnNo.click(this.container,function(e){e.preventDefault();var f=e.data;f.remove()});this.remove=function(){this.container.remove()}}function formatDigits(c,b){var a=c.toString();while(a.length<b){a="0"+a}return a}function formatDate(g){g=g.replace(/-/g,"/");var c=new Date(Date.parse(g));var e=c.getFullYear();var f=c.getMonth()+1;var b=c.getDate();var a=c.getHours();var d=c.getMinutes();return e+"-"+formatDigits(f,2)+"-"+formatDigits(b,2)+" "+formatDigits(a,2)+":"+formatDigits(d,2)}function reformatDate(c){var e=c.getFullYear();var f=c.getMonth()+1;var b=c.getDate();var a=c.getHours();var d=c.getMinutes();return e+"-"+formatDigits(f,2)+"-"+formatDigits(b,2)+" "+formatDigits(a,2)+":"+formatDigits(d,2)}function countImages(d){var b=Object.keys(d.newImageNodes).length;for(var c in d.imageSelectors){var a=d.imageSelectors[c];if(!a.checked){continue}++b}return b}function onSave(g){g.preventDefault();if(!g_activityEditor||!g_activityEditor.savable){return}var s={};var d=getToken();if(!d){alert(ALERTS.please_log_in);return}s[g_keyToken]=d;var a=Object.keys(g_activityEditor.newImageNodes).length-1;var e=null;for(var x in g_activityEditor.newImageNodes){if(!e){e=x}else{if(x>e){e=x}else{}}}var h=[];for(var r in g_activityEditor.newImageNodes){if(r==e){continue}var m=g_activityEditor.newImageNodes[r];h.push(m.remoteName)}s[g_keyNewImage]=JSON.stringify(h);var j=[];for(var u=0;u<g_activityEditor.imageSelectors.length;++u){var t=g_activityEditor.imageSelectors[u];if(!t.checked){continue}j.push(t.id);++a}s[g_keyOldImage]=JSON.stringify(j);if(a>g_imagesLimit){alert(ALERTS.image_selection_requirement);return}var y=g_activityEditor.titleField.val();var b=g_activityEditor.addressField.input.val();var q=g_activityEditor.contentField.val();var w=g_activityEditor.titleCounter;var f=g_activityEditor.addressCounter;var l=g_activityEditor.contentCounter;if(!w.valid()||!f.valid()||!l.valid()){alert(ALERTS.please_follow_activity_field_instructions);return}s[g_keyTitle]=y;s[g_keyAddress]=b;s[g_keyContent]=q;var p=localYmdhisToGmtMillisec(g_activityEditor.beginTimePicker.getDatetime());var v=localYmdhisToGmtMillisec(g_activityEditor.deadlinePicker.getDatetime());if(v<0||p<0||v>p){alert(ALERTS.deadline_behind_begin_time);return}s[g_keyBeginTime]=p;s[g_keyDeadline]=v;var c=false;var o=g_activityEditor.id;if(!o){c=true}if(!c){s[g_keyActivityId]=o}else{s[g_keySid]=g_activityEditor.captcha.sid;s[g_keyCaptcha]=g_activityEditor.captcha.input.val()}g_activityEditor.disableEditorButtons();g_activityEditor.setNonSavable();g_activityEditor.setNonSubmittable();g_activityEditor.hint.text(MESSAGES.activity_saving);$.ajax({type:"POST",url:"/activity/save",data:s,success:function(k,i,A){if(isTokenExpired(k)){logout(null);return}if(isCaptchaNotMatched(k)){alert(ALERTS.captcha_not_matched);g_activityEditor.setSavable();g_activityEditor.enableEditorButtons();g_activityEditor.hint.text(MESSAGES.activity_not_saved);return}if(isCreationLimitExceeded(k)){alert(ALERTS.creation_limit_exceeded);g_activityEditor.setSavable();g_activityEditor.enableEditorButtons();g_activityEditor.hint.text(MESSAGES.activity_not_saved);return}g_activityEditor.setSubmittable();g_activityEditor.enableEditorButtons();var z=new Activity(k);if(!g_activityEditor.id){g_activityEditor.hint.text(MESSAGES.activity_created)}else{g_activityEditor.hint.text(MESSAGES.activity_saved)}g_activityEditor.id=z.id;g_activityEditor.refresh(z);if(!g_onActivitySaveSuccess){return}g_onActivitySaveSuccess()},error:function(z,i,k){g_activityEditor.setSavable();g_activityEditor.enableEditorButtons();g_activityEditor.hint.text(MESSAGES.activity_not_saved)}})}function onSubmit(a){a.preventDefault();if(!g_activityEditor||!g_activityEditor.submittable){return}var d=a.data;var e={};var c=getToken();if(!c){alert(ALERTS.please_log_in);return}e[g_keyToken]=c;var b=g_activityEditor.id;e[g_keyActivityId]=b;g_activityEditor.disableEditorButtons();g_activityEditor.setNonSavable();g_activityEditor.setNonSubmittable();$.ajax({type:"POST",url:"/activity/submit",data:e,success:function(g,f,h){if(isTokenExpired(g)){logout(null);return}if(!isStandardSuccess(g)){return}g_activityEditor.enableEditorButtons();g_activityEditor.hide();if(!g_onActivitySaveSuccess){return}g_onActivitySaveSuccess()},error:function(h,f,g){g_activityEditor.enableEditorButtons();g_activityEditor.setSubmittable()}})}function onDelete(a){a.preventDefault();var c=a.data;var d=getToken();var e={};e[g_keyActivityId]=c;e[g_keyToken]=d;var b=getTarget(a);disableField(b);$.ajax({type:"POST",url:"/activity/delete",data:e,success:function(g,f,h){enableField(b);if(isTokenExpired(g)){logout(null);return}g_activityEditor.hide();if(!g_onActivitySaveSuccess){return}g_onActivitySaveSuccess()},error:function(h,f,g){enableField(b)}})}function onCancel(h){h.preventDefault();g_activityEditor.hide();var b=getToken();if(!b){return}var d=g_activityEditor.newImageNodes;if(Object.keys(d).length<=1){return}var i=null;for(var g in this.newImageNodes){if(!i){i=g}else{if(g>i){i=g}else{}}}var f=[];for(var e in d){if(e==i){continue}var a=d[e];f.push(a.remoteName)}var c={};c[g_keyBundle]=JSON.stringify(f);c[g_keyToken]=b;$.ajax({type:"POST",url:"/image/cdn/qiniu/delete",data:c,success:function(k,j,l){if(!isStandardSuccess(k)){return}},error:function(l,j,k){}})}function generateOldImagesRow(j,h,b){var g=$("<div>",{"class":"edit-image-row clear"}).appendTo(j);var m=Object.keys(b.images).length;var a=function(o){o.preventDefault();var i=o.data;var p=!(i.checked);if(p&&countImages(h)>=g_imagesLimit){return}i.checked=p;if(p){i.indicator.show()}else{i.indicator.hide()}h.setSavable();h.setNonSubmittable();h.addNewImageNode(true,false)};for(var f=0;f<m;++f){var c=$("<div>",{"class":"preview-container left"}).appendTo(g);var l=$("<span>",{"class":"image-helper"}).appendTo(c);var e=$("<img>",{src:b.images[f].url}).appendTo(c);var k=$('<div aria-hidden="true">',{"class":"checked-image glyphicon glyphicon-ok"}).appendTo(c);var d=new ImageSelector(b.images[f].id,e,k);c.click(d,a);h.imageSelectors.push(d)}}function generateDateSelection(a,b){return generateDatePicker(a,b,function(c){c.preventDefault();g_activityEditor.setSavable();g_activityEditor.setNonSubmittable()})}function generateDeleteConfirmation(c,e){if(!g_activityEditor){return}var b=$("<div>",{style:"padding: 5pt;"}).appendTo(c);var g=$("<p>",{text:MESSAGES.delete_activity_confirmation,"class":"delete-confirmation-question"}).appendTo(b);var d=$("<p>").appendTo(b);var a=$("<button>",{text:TITLES.yes,"class":"delete-confirmation-button negative-button"}).appendTo(d);var f=$("<button>",{text:TITLES.no,"class":"delete-confirmation-button positive-button"}).appendTo(d);return new DeleteConfirmation(b,e,a,f)}var g_sectionActivity=null;var g_sectionNav=null;var g_sectionPanes=null;var g_barButtons=null;var g_navTab=null;var g_activityId=null;var g_activity=null;function emptyBarButtons(){if(!g_barButtons){return}g_barButtons.empty()}function clearDetail(){if(!(!g_sectionActivity)){g_sectionActivity.empty()}if(!(!g_sectionNav)){g_sectionNav.empty()}if(!(!g_sectionPanes)){g_sectionPanes.empty()}emptyBarButtons()}function queryActivityDetail(a){var b=getToken();var c={};c[g_keyActivityId]=a;if(!(!b)){c[g_keyToken]=b}$.ajax({type:"GET",url:"/activity/detail",data:c,success:function(f,e,g){var d=f;g_activity=new Activity(d);displayActivityDetail(g_sectionActivity);if(!g_loggedInPlayer||g_loggedInPlayer.id==g_activity.host.id){emptyBarButtons();return}if(g_activity.isDeadlineExpired()&&!g_activity.relation){emptyBarButtons();return}g_barButtons.empty();attachJoinButton(g_barButtons,g_activity)},error:function(f,d,e){alert(ALERTS.not_permitted_to_view_detail);emptyBarButtons();g_sectionActivity.empty()}})}function displayActivityDetail(f){g_onJoined=queryActivityDetail;f.empty();var e=$("<div>",{"class":"activity-detail-page"}).appendTo(f);var g=$("<div>",{text:g_activity.title,"class":"activity-title title-delta"}).appendTo(e);var h=$("<div>",{text:g_activity.address,"class":"activity-addr-detail title-beta"}).appendTo(e);if(!(!g_activity.host.id)&&!(!g_activity.host.name)){var k=$("<a>",{href:"#",text:TITLES.by_host.format(g_activity.host.name),"class":"activity-host patch-block-lambda"}).appendTo(e);k.click(function(i){i.preventDefault();window.location.hash=("profile?"+g_keyVieweeId+"="+g_activity.host.id.toString())})}displayTimesTable(e,g_activity);var d=$("<div>",{text:g_activity.content,"class":"activity-content title-lambda"}).appendTo(e);if(!(!g_activity.images)){var b=$("<div>",{"class":"activity-image-container clearfix"}).appendTo(e);for(var c=0;c<g_activity.images.length;++c){var j=$("<div>",{"class":"activity-image left"}).appendTo(b);$("<span>",{"class":"image-helper"}).appendTo(j);$("<img>",{src:g_activity.images[c].url}).appendTo(j)}}g_tabParticipants.empty();g_participantsForm=generateParticipantsSelectionForm(g_tabParticipants,g_activity);listCommentsAndRefresh(g_activity);initAssessmentModalWidget($("#content"));g_batchAssessmentEditor=generateBatchAssessmentEditor(g_tabAssessments,g_activity,queryActivityDetail);var a=getToken();if(!a){return e}if(g_activity.hasBegun()){$("<p>",{"class":"comment-not-permitted .warning",text:MESSAGES.comment_disabled_activity_has_begun}).appendTo(e);return e}if(!(!g_activity.status)&&g_activity.status!=g_statusAccepted){$("<p>",{"class":"comment-not-permitted .warning",text:MESSAGES.comment_disabled_activity_not_accepted}).appendTo(e);return e}generateCommentEditor(e,g_activity);g_onCommentSubmitSuccess=function(){if(!g_commentId){listCommentsAndRefresh(g_activity)}else{listSubCommentsAndRefresh(g_commentId)}};return e}function onBtnSubmitClicked(a){a.preventDefault();var b=$(this).parent();b.submit(onParticipantsSelectionFormSubmission);b.submit()}function requestActivityDetail(a){clearProfile();clearHome();clearNotifications();g_activityId=a;g_sectionActivity=$("#section-activity");g_sectionNav=$("#section-nav");g_sectionPanes=$("#section-panes");g_barButtons=$("#section-player");var i=["tab-comments","tab-participants","tab-assessments"];var g=[TITLES.question,TITLES.participant,TITLES.assessment];var j=i[0];var e=$("<div>",{"class":"tab-container"});var b=[e,null,null];g_navTab=createNavTab(g_sectionNav,i,g,j,g_sectionPanes,b);g_tabComments=g_navTab.panes[0];g_tabParticipants=g_navTab.panes[1];g_tabAssessments=g_navTab.panes[2];g_pagerComments=new CommentPager(5,"/comment/list",generateCommentsListParams,null,5,null,onListCommentsSuccess,onListCommentsError);g_pagerComments.appendTo(e);g_pagerComments.refresh();g_pagerSubComments=new SubCommentPager(10,"/comment/sub/list",generateCommentsListParams,null,5,null,onListSubCommentsSuccess,onListSubCommentsError);g_pagerSubComments.appendTo(e);g_pagerSubComments.hide();g_pagerSubComments.refresh();var c=function(k){countNotifications();queryActivityDetail(g_activityId)};var d=function(k){queryActivityDetail(g_activityId)};var h=function(k){queryActivityDetail(g_activityId)};var f=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,c,d,h,f,true);checkLoginStatus()}var g_sectionPlayer=null;var g_viewee=null;var g_profileEditor=null;function ProfileEditorImageNode(a,b){this.setCDNCredentials(a,b,getToken(),g_loggedInPlayer);this.composeContent=function(d){this.editor=d;this.wrap=$("<div>",{"class":"preview-container"}).appendTo(this.content);this.preview=$("<img>",{src:this.editor.player.avatar}).appendTo(this.wrap);this.btnChoose=$("<button>",{text:TITLES.choose_picture,"class":"positive-button"}).appendTo(this.wrap);setDimensions(this.btnChoose,"100%",null);if(a==g_cdnQiniu){var c=this;this.uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:c.btnChoose[0],uptoken_url:c.uptokenUrl,unique_names:false,save_key:false,domain:c.bucketDomain,container:c.preview[0],max_file_size:"2mb",max_retries:2,chunk_size:"4mb",auto_start:true,init:{FilesAdded:function(e,g){if(!g){return null}if(g.length!=1){alert(ALERTS.choose_one_image);return}var f=g[0];if(!validateImage(f)){return}c.state=SLOT_UPLOADING;disableField(c.btnChoose)},BeforeUpload:function(e,f){},UploadProgress:function(e,f){},FileUploaded:function(e,f,g){},Error:function(e,g,f){c.state=SLOT_UPLOAD_FAILED},UploadComplete:function(){enableField(c.btnChoose);if(c.state==SLOT_UPLOAD_FAILED){return}var e="http://";var f=e+c.bucketDomain+"/"+c.remoteName;c.preview.attr("src",f);c.state=SLOT_UPLOADED},Key:function(e,f){return c.remoteName}}})}}}ProfileEditorImageNode.inherits(ImageNode);function refreshProfileInfoTable(c,a,e,g,d,f,b){if(!c[a]){c[a]=$("<div>",{"class":"profile-info-table-row"}).appendTo(c)}if(!c[a].title){c[a].title=$("<div>",{"class":"profile-info-table-title",text:g}).appendTo(c[a])}if(!c[a].input){c[a].input=$("<input>",{"class":"profile-info-table-input"}).appendTo(c[a])}c[a].input.val(e);if(b){disableField(c[a].input)}if(!c[a].hint){c[a].hint=$("<div>",{"class":"profile-info-table-hint"}).appendTo(c[a]);c[a].hint.regex=d;c[a].input.on("input keyup paste",c[a].hint,function(i){i.preventDefault();var k=i.data;var h=getTarget(i);k.empty();k.html("");k.removeClass("warn");var j=h.val();if(!j||j.length===0){return}if(d.test(j)){return}k.addClass("warn");k.html(f)})}}function ProfileEditor(){this.NORMAL=0;this.EDITING=1;this.mode=this.NORMAL;this.infoTableVarList=[["age",TITLES.age,g_playerAgePattern,MESSAGES.age_requirement],["gender",TITLES.gender,g_playerGenderPattern,MESSAGES.gender_requirement],["mood",TITLES.mood,g_playerMoodPattern,MESSAGES.mood_requirement]];this.composeContent=function(b){if(!b){return}this.player=b;if(!this.avatarBox){this.avatarBox=$("<div>",{"class":"profile-avatar-box"}).appendTo(this.content)}if(!this.avatarPreview){this.avatarPreview=$("<div>",{"class":"preview-container"}).hide().appendTo(this.content);$("<img>",{src:b.avatar}).appendTo(this.avatarPreview)}if(this.mode==this.NORMAL){this.avatarPreview.show()}else{this.avatarPreview.hide()}if(!this.infoTable){this.infoTable=$("<div>",{"class":"profile-info-table clear"}).appendTo(this.content);var d=(this.mode==this.NORMAL);for(var a in this.infoTableVarList){var e=this.infoTableVarList[a];refreshProfileInfoTable(this.infoTable,e[0],b[e[0]],e[1],e[2],e[3],d)}}if(!g_loggedInPlayer||b.id!=g_loggedInPlayer.id){return}if(!this.avatarNode){var f=queryCDNDomainSync();this.avatarNode=new ProfileEditorImageNode(g_cdnQiniu,f);this.avatarNode.appendTo(this.avatarBox);this.avatarNode.refresh(this);this.avatarHint=$("<p>",{"class":"profile-avatar-hint"}).appendTo(this.avatarBox)}if(this.mode==this.EDITING){this.avatarNode.show();this.avatarHint.show()}else{this.avatarNode.hide();this.avatarHint.hide()}if(!this.buttonRow){this.buttonRow=$("<p>").appendTo(this.content)}if(!this.btnEdit){this.btnEdit=$("<button>",{text:TITLES.edit,"class":"profile-btn-edit positive-button"}).hide().appendTo(this.buttonRow).click(this,function(h){var i=h.data;i.mode=i.EDITING;i.refresh(b)})}if(this.mode==this.NORMAL){this.btnEdit.show()}else{this.btnEdit.hide()}if(!this.btnCancel){this.btnCancel=$("<button>",{text:TITLES.cancel,"class":"profile-btn-cancel negative-button"}).hide().appendTo(this.buttonRow).click(this,function(h){var i=h.data;i.mode=i.NORMAL;i.refresh(b)})}if(this.mode==this.EDITING){this.btnCancel.show()}else{this.btnCancel.hide()}if(!this.btnSave){this.btnSave=$("<button>",{text:TITLES.save,"class":"btn-save positive-button"}).hide().appendTo(this.buttonRow).click(this,function(h){h.preventDefault();var k=h.data;var j=getToken();if(!j){return}var l={};l[g_keyToken]=j;if(k.avatarNode.state==SLOT_UPLOADED){l[g_keyAvatar]=k.avatarNode.remoteName}l[g_keyAge]=k.infoTable.age.input.val();l[g_keyGender]=k.infoTable.gender.input.val();l[g_keyMood]=k.infoTable.mood.input.val();var i=getTarget(h);disableField(i);k.avatarHint.text(MESSAGES.saving);$.ajax({method:"POST",url:"/player/save",data:l,success:function(o,m,p){enableField(i);b=g_viewee=g_loggedInPlayer=new Player(o);k.avatarHint.text(MESSAGES.saved)},error:function(p,m,o){enableField(i);k.avatarHint.text(MESSAGES.save_failed)}})})}if(this.mode==this.EDITING){this.btnSave.show()}else{this.btnSave.hide()}if(!g_loggedInPlayer){return}if(g_loggedInPlayer.hasEmail()&&!g_loggedInPlayer.isEmailAuthenticated()&&g_vieweeId==g_loggedInPlayer.id){if(!this.btnResend){this.resendHint=$("<p>",{"class":"profile-resend-hint"}).hide().appendTo(this.content);this.btnResend=new AjaxButton(TITLES.resend_email_verification);var c=this;var g={url:"/player/email/resend",type:"POST",clickData:null,extraParams:{token:getToken()},onSuccess:function(h){if(!h||isStandardFailure(h)||isTokenExpired(h)||isPlayerNotFound(h)){logout(null);return}c.resendHint.text(MESSAGES.email_verification_sent.format(h[g_keyEmail]))},onError:function(h){c.resendHint.text(MESSAGES.email_verification_not_sent)}};this.btnResend.appendTo(this.content);this.btnResend.refresh(g);this.btnResend.button.addClass("caution-button")}if(this.mode==this.NORMAL){this.btnResend.show();this.resendHint.show()}else{this.btnResend.hide();this.resendHint.hide()}}}}ProfileEditor.inherits(BaseWidget);ProfileEditor.method("refresh",function(a){if(!this.content){return}this.composeContent(a)});function ProfileActivityPager(h,a,b,g,f,e,d,c){this.init(h,a,b,g,f,e,d,c);this.updateScreen=function(p){if(!p){return}var i=parseInt(p[g_keyPageSt]);var r=parseInt(p[g_keyPageEd]);var q=i;var o=p[g_keyActivities];var k=Object.keys(o).length;var l=[];for(var s=1;s<=k;++s){var j=o[s-1];var m=new Activity(j);l.push(m);if(q==this.page){generateActivityCell(this.screen,m)}if(s%this.nItems!=0){continue}this.cache.putPage(q,l);l=[];++q}if(l!=null&&l.length>0){this.cache.putPage(q,l)}}}ProfileActivityPager.inherits(Pager);function clearProfile(){$("#pager-activities").empty();if(!g_sectionPlayer){return}g_sectionPlayer.empty()}function queryPlayerDetail(){var b={};b[g_keyVieweeId]=g_vieweeId;var a=getToken();if(!(!a)){b[g_keyToken]=a}$.ajax({type:"POST",url:"/player/detail",data:b,success:function(f,e,j){if(!g_sectionPlayer){return}g_viewee=new Player(f);var k=g_viewee.name;g_sectionPlayer.empty();var d=$("<div>",{"class":"player-profile clearfix"}).appendTo(g_sectionPlayer);var g=$("<div>",{"class":"section-player-info"}).appendTo(d);var c=$("<div>",{text:k,"class":"section-player-name"}).appendTo(g);if(!g_profileEditor){g_profileEditor=new ProfileEditor()}g_profileEditor.appendTo(d);g_profileEditor.refresh(g_viewee);var h=$("#pager-assessments");if(!(!g_pagerAssessments)){g_pagerAssessments.remove()}var i={to:g_viewee.id};g_pagerAssessments=new AssessmentPager(10,"/assessment/list",generateAssessmentsListParams,i,5,null,onListAssessmentsSuccess,onListAssessmentsError);g_pagerAssessments.appendTo(h);g_pagerAssessments.refresh();if(!g_loggedInPlayer||g_loggedInPlayer.id==g_vieweeId){return}listAssessmentsAndRefresh()}})}function requestProfile(c){clearHome();clearDetail();clearNotifications();g_vieweeId=c;g_sectionPlayer=$("#section-player");var f={};f[g_keyRelation]=[[TITLES.hosted_activities,TITLES.joined_activities],[hosted,present]];f[g_keyOrientation]=[[TITLES.time_descendant,TITLES.time_ascendant],[g_orderDescend,g_orderAscend]];g_pagerActivity=new ProfileActivityPager(g_numItemsPerPage,"/activity/list",generateActivitiesListParams,null,5,f,onListActivitiesSuccess,onListActivitiesError);g_pagerActivity.appendTo("#pager-activities");g_pagerActivity.refresh();var b=function(g){queryPlayerDetail();listActivitiesAndRefresh()};var a=function(g){queryPlayerDetail();listActivitiesAndRefresh()};var e=function(g){queryPlayerDetail();listActivitiesAndRefresh()};var d=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,b,a,e,d,true);g_onActivitySaveSuccess=listActivitiesAndRefresh;checkLoginStatus()}var g_registerWidgetX=null;var g_registerWidgetY=null;function RegisterWidgetX(b,a){this.name=null;this.nameCheck=null;this.email=null;this.emailCheck=null;this.psw=null;this.pswCheck=null;this.pswConfirm=null;this.pswConfirmCheck=null;this.btn=null;this.captcha=null;this.onSuccess=b;this.onError=a;this.composeContent=function(f){var e=$("<div>",{id:"register-box"}).appendTo(this.content);var d=$("<div>").appendTo(e);this.name=$("<input>",{type:"text",placeHolder:HINTS.playername}).appendTo(d);this.nameCheck=$("<div>",{"class":"message"}).appendTo(d);this.name.on("focusin focusout",this.nameCheck,function(j){j.preventDefault();var k=j.data;k.empty();k.html("");var m=$(this).val();if(!m||m.length===0){return}if(!validateName(m)){addWarningStyle(k);k.html("<p>"+MESSAGES.playername_requirement+"</p>");return}var l={};l[g_keyName]=m;$.ajax({type:"GET",url:"/player/name/duplicate",data:l,success:function(p,o,q){if(isStandardSuccess(p)){removeWarningStyle(k);k.html("<p>"+MESSAGES.playername_valid+"</p>")}else{addWarningStyle(k);k.html("<p>"+MESSAGES.playername_invalid+"</p>")}}})});var i=$("<div>").appendTo(e);this.email=$("<input>",{type:"text",placeHolder:HINTS.email}).appendTo(i);this.emailCheck=$("<div>",{"class":"message"}).appendTo(i);this.email.on("focusin focusout",this.emailCheck,function(j){j.preventDefault();var l=j.data;l.empty();l.html("");var k=$(this).val();if(!k||k.length===0){return}if(!validateEmail(k)){addWarningStyle(l);l.html("<p>"+MESSAGES.email_requirement+"</p>");return}var m={};m[g_keyEmail]=k;$.ajax({type:"GET",url:"/player/email/duplicate",data:m,success:function(p,o,q){if(isStandardSuccess(p)){removeWarningStyle(l);l.html("<p>"+MESSAGES.email_valid+"</p>")}else{addWarningStyle(l);l.html("<p>"+MESSAGES.email_invalid+"</p>")}}})});var g=$("<div>").appendTo(e);this.psw=$("<input>",{type:"password",placeHolder:HINTS.password}).appendTo(g);this.pswCheck=$("<div>",{"class":"message"}).appendTo(g);this.psw.on("input keyup paste",this.pswCheck,function(j){j.preventDefault();var l=j.data;l.empty();l.html("");var k=$(this).val();if(!k||k.length===0){return}if(validatePassword(k)){return}addWarningStyle(l);l.html("<p>"+MESSAGES.password_requirement+"</p>")});var c=$("<div>").appendTo(e);this.pswConfirm=$("<input>",{type:"password",placeHolder:HINTS.confirm_password}).appendTo(c);this.pswConfirmCheck=$("<div>",{"class":"message"}).appendTo(c);this.pswConfirm.on("input keyup paste",{0:this.pswConfirmCheck,1:this.psw},function(j){j.preventDefault();var k=j.data[0];var l=$(this).val();var m=j.data[1].val();k.empty();k.html("");if(validatePasswordConfirm(m,l)){return}addWarningStyle(k);k.html("<p>"+MESSAGES.password_confirm_requirement+"</p>")});this.captcha=new Captcha(generateUuid());this.captcha.appendTo(e);this.captcha.refresh();var h=$("<div>",{"class":"register-button"}).appendTo(e);this.btn=$("<button>",{text:TITLES.register,"class":"positive-button"}).click(this,function(k){var p=k.data;var q=p.name.val();var m=p.email.val();var l=p.psw.val();var o=p.pswConfirm.val();if(!q||q.length===0||!validateName(q)||!m||m.length===0||!validateEmail(m)||!l||l.length===0||!validatePassword(l)||!validatePasswordConfirm(l,o)){return}var j=getTarget(k);disableField(j);var r={};r[g_keyName]=q;r[g_keyEmail]=m;r[g_keyPassword]=l;r[g_keySid]=p.captcha.sid;r[g_keyCaptcha]=p.captcha.input.val();$.ajax({type:"POST",url:"/player/register",data:r,success:function(t,s,u){enableField(j);if(isCaptchaNotMatched(t)){alert(ALERTS.captcha_not_matched);if(!(!p.onError)){p.onError(t)}return}p.refresh();if(!p.onSuccess){return}p.onSuccess(t)},error:function(u,s,t){enableField(j);if(!p.onError){return}p.onError(t)}})}).appendTo(h)}}RegisterWidgetX.inherits(BaseWidget);function RegisterWidgetY(b,a){this.onSuccess=b;this.onError=a;this.container=null;this.dialog=null}RegisterWidgetY.inherits(RegisterWidgetX);RegisterWidgetY.swiss(BaseModalWidget,"appendTo");RegisterWidgetY.swiss(BaseModalWidget,"show");RegisterWidgetY.swiss(BaseModalWidget,"hide");RegisterWidgetY.swiss(BaseModalWidget,"remove");function initRegisterWidgetX(a,c,b){g_registerWidgetX=new RegisterWidgetX(c,b);g_registerWidgetX.appendTo(a)}function initRegisterWidgetY(a,c,b){g_registerWidgetY=new RegisterWidgetY(c,b);g_registerWidgetY.appendTo(a)}function validatePasswordConfirm(b,a){if(!b||!a){return false}if(b!=a){return false}return true}var g_sectionLogin=null;var g_loggedInPlayer=null;var g_preLoginForm=null;var g_postLoginMenu=null;var g_nameCompletionForm=null;function PreLoginForm(g,c,b,h,a,d,e,i,f){this.handle=g;this.psw=c;this.btn=b;this.forgot=h;this.registry=a;this.onLoginSuccess=d;this.onLoginError=e;this.onLogoutSuccess=i;this.onLogoutError=f;this.handle.keypress(this,function(j){if(j.which!=13){return}var k=j.data;j.preventDefault();k.btn.click()});this.psw.keypress(this,function(j){if(j.which!=13){return}var k=j.data;j.preventDefault();k.btn.click()});this.btn.click(this,function(j){var o=j.data;var m=o.handle.val();var l=o.psw.val();if(!m||m.length===0||!validateEmail(m)){alert(ALERTS.invalid_email_format);return}if(!l||l.length===0||!validatePassword(l)){alert(ALERTS.wrong_password);return}var p={};p[g_keyEmail]=m;p[g_keyPassword]=l;var k=$(j.srcElement?j.srcElement:j.target);disableField(k);$.ajax({type:"POST",url:"/player/login",data:p,success:function(r,q,s){enableField(k);if(isPlayerNotFound(r)){alert(ALERTS.player_not_existing);return}if(isPswErr(r)){alert(ALERTS.wrong_password);return}g_loggedInPlayer=new Player(r);if(!g_loggedInPlayer){return}saveToken(r.token);wsConnect();if(!g_sectionLogin){return}g_postLoginMenu=generatePostLoginMenu(g_sectionLogin,o.onLoginSuccess,o.onLoginError,o.onLogoutSuccess,o.onLogoutError);if(!o.onLoginSuccess){return}o.onLoginSuccess(r)},error:function(s,q,r){enableField(k);if(!o.onLoginError){return}o.onLoginError(r)}})});this.forgot.click(function(j){j.preventDefault();window.open("/player/password/index")});if(!(!this.registry)){this.registry.click(function(j){j.preventDefault();g_registerWidgetY.show()})}}function NotiBubble(b,a){this.num=b;this.view=a;this.increase=function(c){this.num+=c;this.view.text(this.num.toString())};this.decrease=function(c){this.num-=c;this.view.text(this.num.toString())};this.update=function(c){this.num=c;this.view.text(this.num.toString())}}function PostLoginMenu(b,c,d,a,f,e){this.bubble=b;this.dropdownMenu=c;this.onLoginSuccess=d;this.onLoginError=a;this.onLogoutSuccess=f;this.onLogoutError=e}function NameCompletionForm(){this.composeContent=function(f){this.partyNickname=f;var a=getParty();var e=(a==g_partyQQ?TITLES.first_foreign_party_registration_qq.format(this.partyNickname):TITLES.first_foreign_party_registration);var g=$("<div>",{"class":"title-alpha first-foreign-party-registration-title",html:e}).appendTo(this.content);var c=$("<div>",{id:"register-box"}).appendTo(this.content);var b=$("<div>").appendTo(c);this.name=$("<input>",{type:"text",placeHolder:HINTS.playername}).appendTo(b);this.nameCheck=$("<div>",{"class":"message"}).appendTo(b);var h=$("<div>").appendTo(c);this.email=$("<input>",{type:"text",placeHolder:HINTS.email}).appendTo(h);this.emailCheck=$("<div>",{"class":"message"}).appendTo(h);this.name.on("focusin focusout",this.nameCheck,function(i){i.preventDefault();var j=i.data;j.empty();j.html("");var l=$(this).val();if(!l||l.length===0){return}if(!validateName(l)){addWarningStyle(j);j.html("<p>"+MESSAGES.playername_requirement+"</p>");return}var k={};k[g_keyName]=l;$.ajax({type:"GET",url:"/player/name/duplicate",data:k,success:function(o,m,p){if(isStandardSuccess(o)){removeWarningStyle(j);j.html("<p>"+MESSAGES.playername_valid+"</p>")}else{addWarningStyle(j);j.html("<p>"+MESSAGES.playername_invalid+"</p>")}},error:function(p,m,o){}})});this.email.on("focusin focusout",this.emailCheck,function(i){i.preventDefault();var k=i.data;k.empty();k.html("");var j=$(this).val();if(!j||j.length===0){return}if(!validateEmail(j)){addWarningStyle(k);k.html("<p>"+MESSAGES.email_requirement+"</p>");return}var l={};l[g_keyEmail]=j;$.ajax({type:"GET",url:"/player/email/duplicate",data:l,success:function(o,m,p){if(isStandardSuccess(o)){removeWarningStyle(k);k.html("<p>"+MESSAGES.email_valid+"</p>")}else{addWarningStyle(k);k.html("<p>"+MESSAGES.email_invalid+"</p>")}},error:function(p,m,o){}})});var d=$("<div>",{"class":"edit-button-rows"}).appendTo(c);this.btnSubmit=$("<button>",{"class":"btn-submit positive-button",text:TITLES.submit}).appendTo(d).click(this,function(i){var m=i.data;var p=m.name.val();var l=m.email.val();if(!p||p.length===0||!validateName(p)){return}if(!(!l)&&l.length>0&&!validateEmail(l)){return}var k=getAccessToken();if(!k){return}var j=getParty();if(!j){return}var o=getTarget(i);disableField(o);var q={};q[g_keyName]=p;if(!(!l)&&l.length>0&&validateEmail(l)){q[g_keyEmail]=l}q[g_keyAccessToken]=k;q[g_keyParty]=j;$.ajax({type:"POST",url:"/player/foreign/implicit/login",data:q,success:function(s,r,t){enableField(o);if(isPlayerNotFound(s)){alert(ALERTS.player_not_existing);clearAccessTokenAndParty();m.hide();return}if(isForeignPartyRegistrationRequired(s)){m.refresh(m.partyNickname);return}if(isTempForeignPartyRecordNotFound(s)){alert(ALERTS.relogin_required);m.hide();return}if(isStandardFailure(s)){alert(ALERTS.unknown_error);m.refresh(m.partyNickname);return}clearAccessTokenAndParty();g_loggedInPlayer=new Player(s);saveToken(s.token);m.hide();checkLoginStatus(false)},error:function(t,r,s){enableField(o);m.hide()}})});this.btnCancel=$("<button>",{"class":"btn-cancel negative-button",text:TITLES.cancel}).appendTo(d).click(this,function(i){clearAccessTokenAndParty();var j=i.data;j.hide()})}}NameCompletionForm.inherits(BaseModalWidget);function initNameCompletionForm(a){g_nameCompletionForm=new NameCompletionForm();g_nameCompletionForm.appendTo(a,true)}var g_qqWelcomePopup=null;function QQWelcomePopup(){this.composeContent=function(c){var a=c;var b=$("<div>",{"class":"general-popup-paragraph",html:MESSAGES.qq_welcome.format(a)}).appendTo(this.content)}}QQWelcomePopup.inherits(BaseModalWidget);function initQQWelcomePopup(a){g_qqWelcomePopup=new QQWelcomePopup();g_qqWelcomePopup.appendTo(a)}function appendForeignPartyLoginEntry(c,b){if(!c){return}if(b==g_partyQQ){var a=$("<img>",{src:g_srcQQLogo,"class":"qq-logo"}).appendTo(c).click(function(d){d.preventDefault();var g=encodeURIComponent(window.location.protocol+"//"+window.location.host+"/callback/qq");var f="https://graph.qq.com/oauth2.0/authorize?";var e=["client_id="+g_appIdQQ,"redirect_uri="+g,"scope=get_user_info","response_type=token","state="+encodeStateWithAction(checkLoginStatus,[false])];window.location.assign(f+e.join("&"))})}}function generatePreLoginForm(l,f,g,m,i,e){if(!l){return null}l.empty();var b=$("<div>",{id:"login-box","class":"right"}).appendTo(l);var p=$("<div>",{"class":"login-info-row"}).appendTo(b);var h=$("<div>",{"class":"login-inputs left plain-input"}).appendTo(p);var j=$("<input>",{placeHolder:HINTS.email,type:"text","class":"login-email"}).appendTo(h);var d=$("<input>",{placeHolder:HINTS.password,type:"password","class":"login-pw"}).appendTo(h);var c=$("<button>",{text:TITLES.login,"class":"login-btn left positive-button"}).appendTo(p);var o=$("<div>",{"class":"accessory-row clear"}).appendTo(b);var k=$("<button>",{text:TITLES.forgot_password,"class":"login-forgot faketext-button"}).appendTo(o);var a=null;if(e){a=$("<button>",{text:TITLES.register,"class":"login-registry faketext-button"}).appendTo(o)}appendForeignPartyLoginEntry(o,g_partyQQ);return new PreLoginForm(j,d,c,k,a,f,g,m,i)}function logout(a){a.preventDefault();var d=((a&&a.data)?a.data:g_postLoginMenu);if(!d){return}var c={};c[g_keyToken]=getToken();var b=(a?$(a.srcElement?a.srcElement:a.target):null);disableField(b);$.ajax({type:"POST",url:"/player/logout",data:c,success:function(f,e,g){enableField(b);g_loggedInPlayer=null;clearToken();wsDisconnect();if(!g_sectionLogin){return}g_preLoginForm=generatePreLoginForm(g_sectionLogin,d.onLoginSuccess,d.onLoginError,d.onLogoutSuccess,d.onLogoutError);if(!d.onLogoutSuccess){return}d.onLogoutSuccess(f)},error:function(g,e,f){enableField(b);wsDisconnect();clearToken();if(!d.onLogoutError){return}d.onLogoutError(f)}})}function generatePostLoginMenu(l,g,s,d,z){if(!l){return null}if(!g_loggedInPlayer){return null}l.empty();var p=function(A){A.preventDefault();if(!g_loggedInPlayer){return}if(g_loggedInPlayer.isVisitor()){alert(ALERTS.email_not_authenticated);return}if(!g_activityEditor){return}g_activityEditor.refresh(null);g_activityEditor.show()};var j=function(A){A.preventDefault();if(!g_loggedInPlayer){return}window.location.hash=("profile?"+g_keyVieweeId+"="+g_loggedInPlayer.id.toString())};var u=logout;var k=$("<div>",{"class":"post-login-whole right"}).appendTo(l);var r=$("<div>",{"class":"post-login-buttons-panel right patch-block-gamma"}).appendTo(k);var t=$("<div>",{"class":"menu-info-row"}).appendTo(r);var i=$("<div>",{"class":"post-login-player-name left",html:g_loggedInPlayer.name}).appendTo(t);var a=$("<div>",{"class":"noti-container glyphicon glyphicon-envelope left"}).appendTo(t).click(function(A){A.preventDefault();if(!g_loggedInPlayer){return}window.location.hash="notifications"});var q=$("<span>",{"class":"bubble",text:"0"}).appendTo(a);var m=new NotiBubble(0,q);m.update(g_loggedInPlayer.unreadCount);var h=$("<div>",{"class":"menu-action-row"}).appendTo(r);var e=["file","user","log-out"];var y=[TITLES.create,TITLES.profile,TITLES.logout];var f=[p,j,u];var w=createDropdownMenu(h,"menu-post-login",g_loggedInPlayer.name,e,y,f);var b=new PostLoginMenu(m,w,g,s,d,z);var v=[b,b,b];w.setReactionParams(v);var x=$("<div>",{"class":"post-login-avatar right patch-block-alpha"}).appendTo(k);var o=$("<img>",{src:g_loggedInPlayer.avatar}).appendTo(x);var c=$("<span>",{text:TITLES.profile}).appendTo(x);x.click(j);return b}function checkForeignPartyLoginStatus(){var b=getAccessToken();var a=getParty();if(!b||!a){clearAccessTokenAndParty();checkLoginStatus(false);return}var c={};c[g_keyAccessToken]=b;c[g_keyParty]=a;$.ajax({type:"POST",url:"/player/foreign/implicit/login",data:c,success:function(f,d,g){if(isPlayerNotFound(f)){alert(ALERTS.player_not_existing);clearAccessTokenAndParty();checkLoginStatus(false);return}if(isForeignPartyRegistrationRequired(f)){var e=f[g_keyPartyNickname];g_nameCompletionForm.refresh(e);g_nameCompletionForm.show();return}if(isTempForeignPartyRecordNotFound(f)){alert(ALERTS.relogin_required);checkLoginStatus(false);return}if(isStandardFailure(f)){alert(ALERTS.unknown_error);checkLoginStatus(false);return}clearAccessTokenAndParty();g_loggedInPlayer=new Player(f);saveToken(f.token);if(a==g_partyQQ&&!(!f[g_keyPartyNickname])){g_qqWelcomePopup.refresh(f[g_keyPartyNickname]);g_qqWelcomePopup.show()}checkLoginStatus(false)},error:function(f,d,e){checkLoginStatus(false)}})}function checkLoginStatus(a){a=(a===undefined?true:a);var b=getToken();if(!b){if(a){checkForeignPartyLoginStatus();return}if(!g_preLoginForm){return}g_preLoginForm.onLoginError(null);return}if(!(!g_loggedInPlayer)){if(!g_preLoginForm){return}g_postLoginMenu=generatePostLoginMenu(g_sectionLogin,g_preLoginForm.onLoginSuccess,g_preLoginForm.onLoginError,g_preLoginForm.onLogoutSuccess,g_preLoginForm.onLogoutError);if(!g_preLoginForm.onLoginSuccess){return}g_preLoginForm.onLoginSuccess(null);return}var c={};c[g_keyToken]=b;$.ajax({type:"POST",url:"/player/status",data:c,success:function(e,d,f){if(isStandardFailure(e)||isTokenExpired(e)||isPlayerNotFound(e)){wsDisconnect();clearToken();if(!g_preLoginForm.onLoginError){return}g_preLoginForm.onLoginError(null);return}g_loggedInPlayer=new Player(e);if(!g_loggedInPlayer){return}saveToken(e.token);wsConnect();if(!g_preLoginForm){return}g_postLoginMenu=generatePostLoginMenu(g_sectionLogin,g_preLoginForm.onLoginSuccess,g_preLoginForm.onLoginError,g_preLoginForm.onLogoutSuccess,g_preLoginForm.onLogoutError);if(!g_preLoginForm.onLoginSuccess){return}g_preLoginForm.onLoginSuccess(e)},error:function(f,d,e){}})}function focusLogin(){}var g_topbar=null;function initTopbar(c){g_topbar=c;g_topbar.empty();var a=$("<div>",{id:"topbar-title","class":"left"}).appendTo(g_topbar);var b=$("<div>",{"class":"glyphicon glyphicon-home"}).appendTo(a).click(function(d){d.preventDefault();window.location.href="/"});g_sectionLogin=$("<div>",{id:"login-section"}).appendTo(g_topbar)}var g_footer=null;var g_announcement=null;function initFooter(g){g_footer=g;g_announcement=new Announcement();g_announcement.appendTo($("#content"));var e=$("<div>",{id:"footer-links","class":"left"}).appendTo(g_footer);var c=$("<ul>",{"class":"clearfix"}).appendTo(e);var b=$("<li>").appendTo(c);var f=$("<a>",{text:TITLES.about_us}).appendTo(b);var a=$("<li>").appendTo(c);f.click(function(i){i.preventDefault();if(!(!g_announcement)){g_announcement.hide()}g_announcement.refresh(MESSAGES.about_us);g_announcement.show()});var d=$("<a>",{text:TITLES.privacy_policy}).appendTo(a);d.click(function(i){i.preventDefault();if(!(!g_announcement)){g_announcement.hide()}g_announcement.refresh(MESSAGES.privacy_policy);g_announcement.show()});var h=$("<div>",{id:"footer-copy","class":"right",html:TITLES.copyright}).appendTo(g_footer)}function BaseWidget(){this.refresh=function(a){if(!this.content){return}this.content.empty();this.composeContent(a)};this.appendTo=function(a){this.content=$("<div>").appendTo(a)};this.show=function(){this.content.show()};this.hide=function(){this.content.hide()};this.remove=function(){this.content.remove()}}function BaseModalWidget(){}BaseModalWidget.inherits(BaseWidget);BaseModalWidget.method("appendTo",function(b,a,c){this.container=$("<div class='modal fade' data-keyboard='false' tabindex='-1' role='dialog' aria-labelledby='create' aria-hidden='true'>").appendTo(b);if(!(!c)){this.container.addClass(c)}if(!(!a)){this.container.attr("data-backdrop","static")}this.dialog=$("<div class='modal-dialog modal-lg'>").appendTo(this.container);this.content=$("<div class='modal-content'>").appendTo(this.dialog)});BaseModalWidget.method("show",function(){this.container.modal("show")});BaseModalWidget.method("hide",function(){this.container.modal("hide")});BaseModalWidget.method("remove",function(){this.container.remove()});var SLOT_IDLE=0;var SLOT_UPLOADING=1;var SLOT_UPLOAD_FAILED=2;var SLOT_AJAX_PENDING=3;var SLOT_UPLOADED=4;function ImageNode(){this.state=SLOT_IDLE;this.uploader=null;this.wrap=null;this.preview=null;this.editor=null;this.btnChoose=null;this.setCDNCredentials=function(a,e,d,c){this.cdn=a;this.bucketDomain=e;var b=currentMillis();this.remoteName="{0}_{1}".format(c.id,b);var f=[g_keyToken+"="+d,g_keyDomain+"="+this.bucketDomain,g_keyRemoteName+"="+this.remoteName];this.uptokenUrl="/image/cdn/qiniu/uptoken?"+f.join("&")}}ImageNode.inherits(BaseWidget);function AjaxButton(f,b,a,c,g,e,d){this.text=f;this.url=b;this.clickData=a;this.type=c;this.extraParams=g;this.onSuccess=e;this.onError=d;this.composeContent=function(h){this.button=$("<button>",{text:this.text}).appendTo(this.content).click(h,function(k){k.preventDefault();var m=k.data.clickData;var o=k.data.url;var j=k.data.type;var p=k.data.extraParams;var i=k.data.onSuccess;var q=k.data.onError;var l=getTarget(k);disableField(l);$.ajax({url:o,type:j,data:p,success:function(s,r,t){enableField(l);if(!i){return}i(s)},error:function(t,r,s){enableField(l);if(!q){return}q(s)}})})}}AjaxButton.inherits(BaseWidget);function DatetimePicker(a){this.input=a;this.getDatetime=function(){var b=this.input.val();if(!b||b===""||b.length===0){return null}return b+":00"}}function generateDatePicker(g,c,h){var b=$("<div>",{"class":"col-sm-6"}).appendTo(g);var a=$("<div>",{"class":"form-group"}).appendTo(b);var d=$("<div>",{"class":"input-group date"}).appendTo(a);var i=$("<input type='text' class='form-control right' style='cursor: default;' readonly>").appendTo(d).val(c);var f=$("<span>",{"class":"input-group-addon"}).appendTo(d);var e=$("<span>",{"class":"glyphicon glyphicon-calendar"}).appendTo(f);d.datetimepicker({format:"YYYY-MM-DD HH:mm",ignoreReadonly:true,sideBySide:true});d.on("dp.change",h);return new DatetimePicker(i)}function PagerFilter(b,a){this.key=b;this.selector=a}function PagerCache(a){this.size=a;this.map={};this.first=1;this.last=1;this.prependPage=function(c){var b=Object.keys(this.map).length;if(this.map.hasOwnProperty(this.last)&&b==this.size){delete this.map[this.last];--this.last}this.map[--this.first]=c};this.appendPage=function(c){var b=Object.keys(this.map).length;if(this.map.hasOwnProperty(this.first)&&b==this.size){delete this.map[this.first];++this.first}this.map[++this.last]=c};this.putPage=function(c,b){if(c>this.last){this.appendPage(b)}else{if(c<this.first){this.prependPage(b)}else{this.map[c]=b}}}}function PagerButton(a,b){this.pager=a;this.page=b}function Pager(h,a,b,g,f,e,d,c){this.init=function(q,i,j,p,o,m,l,k){this.nItems=q;this.page=1;this.total=0;this.st=-g_inf;this.ed=g_inf;this.url=i;this.paramsGenerator=j;this.extraParams=p;this.onSuccess=l;this.onError=k;this.cache=new PagerCache(o);this.filterMap=m};this.refreshFilters=function(){this.filterList=[];if(!this.filterMap){return}for(var u in this.filterMap){var q=this.filterMap[u];var r=q[0];var m=q[1];var o=$("<select>").appendTo(this.filterBar);var l=r.length;for(var p=0;p<l;++p){var s=r[p];var t=m[p];$("<option>",{text:s,value:t}).appendTo(o)}var j=function(w){var v=w.data;var x=v.paramsGenerator(v,1);if(!x){return}var i=k.selector;disableField(i);$.ajax({type:"GET",url:v.url,data:x,success:function(A,y,B){var z=v.cache.size;v.cache=new PagerCache(z);enableField(i);v.onSuccess(A)},error:function(A,y,z){enableField(i);v.onError(z)}})};o.change(this,j);var k=new PagerFilter(u,o);this.filterList.push(k)}};this.createFilters=function(){this.filterBar=$("<div>").appendTo(this.content);this.refreshFilters()};this.refreshBar=function(){var j=this;var m=j.page;var r=j.cache;j.bar.empty();var i=Object.keys(r.map).length;if(i<=1){return}var o=function(t){if(!j.url){return}var s=getTarget(t);var u=t.data;j.page=u.page;var v=j.paramsGenerator(j,u.page);if(!v){return}disableField(s);$.ajax({type:"GET",url:j.url,data:v,success:function(x,w,y){enableField(s);j.onSuccess(x)},error:function(y,w,x){enableField(s);j.onError(x)}})};for(var q in r.map){var l=parseInt(q);var p=$("<button>",{text:l,"class":"plain-button pager-button"}).appendTo(j.bar);var k=new PagerButton(j,l);p.click(k,o);if(l!=m){continue}p.off("mouseenter mouseleave");p.addClass("active-button")}};this.createBar=function(){this.bar=$("<div>").appendTo(this.content);this.refreshBar()};this.refreshScreen=function(i){this.screen.empty();this.updateScreen(i);this.refreshBar()};this.createScreen=function(i){this.screen=$("<div>").appendTo(this.content);this.refreshScreen(i)};this.composeContent=function(i){if(!this.filterBar){this.createFilters()}if(!this.bar){this.createBar()}if(!this.screen){this.createScreen(i)}};this.goToPage=function(j){var i=this;i.page=j;var k=i.paramsGenerator(i,j);if(!k){return}$.ajax({type:"GET",url:i.url,data:k,success:function(m,l,o){i.onSuccess(m)},error:function(o,l,m){i.onError(m)}})}}Pager.inherits(BaseWidget);function Announcement(){this.composeContent=function(b){var a=b;var c=$("<div>",{"class":"general-popup-paragraph",text:a}).appendTo(this.content)}}Announcement.inherits(BaseModalWidget);function createBinarySwitch(e,c,d,i,f,b,k){var a=$("<div class='onoffswitch'>").appendTo(e);var h=$("<input type='checkbox' class='onoffswitch-checkbox' id='"+k+"'>").appendTo(a);var g=$("<label class='onoffswitch-label' for='"+k+"'>").appendTo(a);var l=$("<span class='onoffswitch-inner'>").appendTo(g);var j=$("<span class='onoffswitch-switch'>").appendTo(g);l.attr("left-text",f);l.attr("right-text",b);if(c){disableBinarySwitch(a);l.attr("right-text",i);j.hide()}else{j.show()}setBinarySwitch(a,d);return a}function setBinarySwitch(a,c){var b=firstChild(a,"input.onoffswitch-checkbox");b.prop("checked",c)}function setBinarySwitchOnClick(a,c){var b=firstChild(a,"input.onoffswitch-checkbox");if(b.is(":disabled")){return}a.off("click").on("click",c)}function getBinarySwitchState(a){var b=firstChild(a,"input.onoffswitch-checkbox");return b.is(":checked")}function disableBinarySwitch(a){a.off("click");var b=firstChild(a,"input.onoffswitch-checkbox");b.prop("checked",false);disableField(b)}function DropdownMenu(a,b,c){this.toggle=a;this.items=b;this.reactions=c;this.setReactionParams=function(f){this.reactionParams=f;var e=f.length;for(var d=0;d<e;d++){this.items[d].click(f[d],c[d])}}}function createDropdownMenu(k,b,d,p,l,h){var c=l.length;var a=$("<div>",{"class":"menu-actions"}).appendTo(k);var g=null;var j=$("<ul>").appendTo(a);var o=[];for(var f=0;f<l.length;f++){var m=$("<li class='glyphicon glyphicon-"+p[f]+"'>").appendTo(j);var e=$("<a class='patch-block-gamma' tabindex='-1' href='#' title='"+l[f]+"'>").appendTo(m);e.text(l[f]);o.push(m)}return new DropdownMenu(g,o,h)}function NavTab(a){this.panes=a}function createNavTab(h,m,k,q,r,d){var g=$("<ul class='nav nav-pills' role='tablist'>").appendTo(h);var b=m.length;for(var f=0;f<b;f++){var p=null;if(m[f]==q){p=$("<li role='presentation' class='active'>").appendTo(g)}else{p=$("<li role='presentation'>").appendTo(g)}var a=$("<a href='#"+m[f]+"' role='tab' data-toggle='tab'>").appendTo(p);a.text(k[f])}var l=[];for(var e=0;e<b;e++){var o=(m[e]==q);var c=createNavTabPane(r,m[e],o,d[e]);l.push(c)}return new NavTab(l)}function createNavTabPane(b,d,a,c){var e=null;if(a){e=$("<div role ='tabpanel' class='tab-pane fade in active' id='"+d+"'>").appendTo(b)}else{e=$("<div role='tabpanel' class='tab-pane' fade id='"+d+"'>").appendTo(b)}if(!c){return e}e.append(c);return e}function Captcha(a){this.sid=a;this.hasImg=function(){var b=this.img.attr("src");return(!(!b)&&b.length!==0)};this.updateImg=function(){this.img.attr("src","/captcha?"+g_keySid+"="+this.sid+"&ts="+new Date().getTime())};this.composeContent=function(c){var d=$("<div>",{"class":"captcha"}).appendTo(this.content);this.input=$("<input>",{placeHolder:HINTS.captcha}).on("focusin",this,function(e){var f=e.data;if(f.hasImg()){return}f.updateImg()}).appendTo(d);this.img=$("<img>",{src:""}).appendTo(d);var b=$("<div>",{"class":"captcha-change glyphicon glyphicon-refresh glyphicon-button"}).appendTo(d).click(this,function(e){e.preventDefault();var f=e.data;f.updateImg()})}}Captcha.inherits(BaseWidget);function WordCounter(e,b,a,c,d){this.text=e;this.min=b;this.max=a;this.regex=c;this.violationHint=d;this.update=function(f){this.text=f;this.currentText.text(f.length);if(this.valid()){this.currentText.css("color","gray");this.hintText.text("")}else{this.currentText.css("color","red");this.hintText.text(this.violationHint)}};this.appendCounter=function(f){var g=$("<p>").appendTo(f);this.currentText=$("<span>",{"class":"word-counter-current",text:this.text.length}).appendTo(g);this.maxText=$("<span>",{"class":"word-counter-max",text:"/"+this.max.toString()}).appendTo(g);this.hintText=$("<span>",{"class":"word-counter-violation-hint",text:""}).appendTo(g);this.update(this.text)};this.valid=function(){return(c.test(this.text))}}function RegexInputWidget(){}function SearchWidget(){this.collapse=function(){};this.expand=function(){}}SearchWidget.inherits(BaseWidget);function createSelector(h,f,l,a,m,d,j){if(f.length!=l.length){return}var b=f.length;var g=$("<select>").appendTo(h);for(var e=0;e<b;++e){var k=f[e];var c=l[e];$("<option>",{text:k,value:c}).appendTo(g)}return g}var WS=window.MozWebSocket?MozWebSocket:WebSocket;var g_ws=null;function wsConnect(){if(g_ws!=null){return}var a=getToken();if(a==null){return}var b=window.location.host;g_ws=new WS("ws://"+b+"/el/ws?"+g_keyToken+"="+a);g_ws.onopen=function(){};g_ws.onmessage=function(c){var d=JSON.parse(c.data);if(g_postLoginMenu==null){return}g_postLoginMenu.bubble.increase(1)};g_ws.onclose=function(){}}function wsDisconnect(){if(g_ws==null){return}g_ws.close();g_ws=null}var g_pagerActivity=null;function AdminActivityPager(h,a,b,g,f,e,d,c){this.init(h,a,b,g,f,e,d,c);this.updateScreen=function(m){if(!m){return}var i=parseInt(m[g_keyPageSt]);var q=parseInt(m[g_keyPageEd]);var p=i;var r=m[g_keyActivities];var j=Object.keys(r).length;var k=[];for(var s=1;s<=j;++s){var o=r[s-1];var l=new Activity(o);k.push(l);if(p==this.page){var t=new AdminActivityCell();t.appendTo(this.screen);t.refresh(l)}if(s%this.nItems!==0){continue}this.cache.putPage(p,k);k=[];++p}if(!(!k)&&k.length>0){this.cache.putPage(p,k)}}}AdminActivityPager.inherits(Pager);function OrderOption(c,b,a,d){this.editor=c;this.bitCode=b;this.labelName=a;this.initChecked=d;this.appendTo=function(i){var e=$("<p>",{"class":"order-option"}).appendTo(i);var h=$("<label>",{"class":"order-label"}).appendTo(e);var g=$("<plaintext>",{"class":"order-label-name",text:this.labelName}).appendTo(h);var f=this.editor;this.checkbox=$("<input>",{type:"checkbox","class":"order-checkbox"}).appendTo(h).change(function(j){f.enableSubmit()});if(this.initChecked>0){this.check()}};this.check=function(){if(!this.checkbox){return}checkField(this.checkbox)};this.uncheck=function(){if(!this.checkbox){return}uncheckField(this.checkbox)}}function PriorityEditor(a){this.activity=a;this.disableSubmit=function(){disableField(this.btnSubmit)};this.enableSubmit=function(){enableField(this.btnSubmit)};this.appendTo=function(o){var b=$("<div>",{"class":"priority-editor"}).appendTo(o);var j=this;var p=$("<p>").appendTo(b);this.selectPriority=createSelector(p,["none","low","medium","high"],[0,1,2,3],0,0,0,0);this.selectPriority.val(a.priority);this.selectPriority.change(function(i){j.enableSubmit()});var l=$("<p>",{"class":"priority-editor-buttons-row"}).appendTo(b);this.btnCheckAll=$("<button>",{"class":"positive-button",text:TITLES.check_all}).appendTo(l).click(function(s){s.preventDefault();for(var t=0;t<j.orderOptionList.length;++t){var u=j.orderOptionList[t];u.check()}j.enableSubmit()});this.btnUncheckAll=$("<button>",{"class":"positive-button",text:TITLES.uncheck_all}).appendTo(l).click(function(s){s.preventDefault();for(var t=0;t<j.orderOptionList.length;++t){var u=j.orderOptionList[t];u.uncheck()}j.enableSubmit()});var q=$("<p>",{"class":"priority-editor-order-option-list"}).appendTo(b);this.orderOptionList=[];var f=[TITLES.last_accepted_time,TITLES.begin_time,TITLES.deadline];var r=[1,2,4];var d=f.length;for(var h=0;h<d;++h){var g=f[h];var m=r[h];var k=((a.orderMask&m)>0?1:0);var e=new OrderOption(this,m,g,k);e.appendTo(q);this.orderOptionList.push(e)}var c=$("<p>",{"class":"priority-editor-buttons-row"}).appendTo(b);this.btnSubmit=$("<button>",{text:TITLES.update,"class":"positive-button"}).appendTo(c).click(function(s){s.preventDefault();var v=getToken();if(!v){return}var x=0;for(var u=0;u<j.orderOptionList.length;++u){var y=j.orderOptionList[u];if(!isChecked(y.checkbox)){continue}x|=y.bitCode}var t=j.selectPriority.val();var w={};w[g_keyToken]=v;w[g_keyPriority]=t;w[g_keyOrderMask]=x;w[g_keyActivityId]=j.activity.id;j.disableSubmit();$.ajax({type:"POST",url:"/admin/prioritize",data:w,success:function(z,i,A){j.activity.orderMask=x},error:function(A,i,z){alert(ALERTS.not_updated);j.enableSubmit()}})});this.disableSubmit()}}function onBtnAcceptClicked(b){var d=getTarget(b);b.preventDefault();var a=b.data;var c=getToken();if(!c){return}var e={};e[g_keyActivityId]=a.id;e[g_keyToken]=c;disableField(d);$.ajax({type:"POST",url:"/admin/accept",data:e,success:function(g,f,h){enableField(d);if(isTokenExpired(g)){logout(null);return}if(!isStandardSuccess(g)){return}d.remove();a.statusIndicator.text(STATUS_NAMES.accepted)},error:function(h,f,g){enableField(d)}})}function onBtnRejectClicked(b){var d=getTarget(b);b.preventDefault();var a=b.data;var c=getToken();if(!c){return}var e={};e[g_keyActivityId]=a.id;e[g_keyToken]=c;disableField(d);$.ajax({type:"POST",url:"/admin/reject",data:e,success:function(g,f,h){enableField(d);if(isTokenExpired(g)){logout(null);return}if(!isStandardSuccess(g)){return}d.remove();a.statusIndicator.text(STATUS_NAMES.rejected)},error:function(h,f,g){enableField(d)}})}function onBtnDeleteClicked(b){var e=getTarget(b);b.preventDefault();var a=b.data;var c=getToken();if(!c){return}var d={};d[g_keyActivityId]=a.id;d[g_keyToken]=c;disableField(e);$.ajax({type:"POST",url:"/admin/delete",data:d,success:function(g,f,h){enableField(e);if(isTokenExpired(g)){logout(null);return}if(!isStandardSuccess(g)){return}e.remove();a.statusIndicator.text("Deleted")},error:function(h,f,g){enableField(e)}})}function listActivitiesAndRefreshAdmin(){var a=1;listActivities(a,onListActivitiesSuccessAdmin,onListActivitiesErrorAdmin)}function onListActivitiesSuccessAdmin(a){if(isTokenExpired(a)){logout(null);return}g_pagerActivity.refreshScreen(a)}function onListActivitiesErrorAdmin(a){}function AdminActivityCell(){this.composeContent=function(b){this.id=b.id;var k=[STATUS_NAMES.created,STATUS_NAMES.pending,STATUS_NAMES.rejected,STATUS_NAMES.accepted];var a=$("<div>",{"class":"admin-cell-info-wrap"}).appendTo(this.content);if(!(!b.images)){var d=$("<div>",{"class":"activity-image-container clearfix"}).appendTo(a);for(var g=0;g<b.images.length;++g){var q=$("<div>",{"class":"activity-image left"}).appendTo(d);$("<span>",{"class":"image-helper"}).appendTo(q);$("<img>",{src:b.images[g].url}).appendTo(q)}}var e=$("<a>",{href:window.location.protocol+"//"+window.location.host+"#"+("detail?"+g_keyActivityId+"="+b.id.toString()),"class":"activity-title",text:b.title}).appendTo(a);var m=$("<div>",{"class":"truncate admin-cell-activity-content",text:b.content}).appendTo(a);if(!!b.status){this.statusIndicator=$("<div>",{"class":"admin-cell-status-indicator",text:k[parseInt(b.status)]}).appendTo(this.content)}var c=$("<div>",{"class":"admin-cell-buttons-wrap"}).appendTo(this.content);if(!!b.status&&b.status!=g_statusAccepted){var l=$("<button>",{"class":"admin-cell-button-accept positive-button",text:"Accept"}).appendTo(c).click(this,onBtnAcceptClicked)}if(!!b.status&&b.status!=g_statusRejected){var h=$("<button>",{"class":"admin-cell-button-reject negative-button",text:"Reject"}).appendTo(c).click(this,onBtnRejectClicked)}var f=$("<button>",{"class":"admin-cell-button-delete negative-button",text:"Delete"}).appendTo(c).click(this,onBtnDeleteClicked);if(!!b.status&&b.status==g_statusAccepted){var o=$("<div>",{"class":"admin-cell-section-priority-editor"}).appendTo(this.content);var j=new PriorityEditor(b);j.appendTo(o)}var p=$("<hr>",{"class":"admin-cell-separator"}).appendTo(this.content)}}AdminActivityCell.inherits(BaseWidget);function requestAdmin(){var e={};e[g_keyStatus]=[[STATUS_NAMES.pending,STATUS_NAMES.accepted,STATUS_NAMES.rejected],[g_statusPending,g_statusAccepted,g_statusRejected]];g_pagerActivity=new AdminActivityPager(g_numItemsPerPage,"/activity/list",generateActivitiesListParams,null,10,e,onListActivitiesSuccessAdmin,onListActivitiesErrorAdmin);g_pagerActivity.appendTo($("#pager-activities"));g_pagerActivity.refresh();var b=function(f){listActivitiesAndRefreshAdmin()};var a=function(f){};var d=function(f){};var c=null;g_preLoginForm=generatePreLoginForm(g_sectionLogin,b,a,d,c,false);checkLoginStatus()}$(document).ready(function(){initTopbar($("#topbar"));initActivityEditor($("#wrap"),listActivitiesAndRefreshAdmin);requestAdmin()});